<!DOCTYPE html>
<html lang="ne">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Yubaraj Chaulagai Calling Website</title>

<style>
body{font-family:Arial;margin:0;background:#f2f4f7;text-align:center}
.container{max-width:520px;margin:auto;padding:10px}
.box{background:white;padding:15px;margin:10px;border-radius:10px;
box-shadow:0 2px 6px rgba(0,0,0,.1)}
input,button,select{width:95%;padding:10px;margin:5px;
font-size:15px;border-radius:5px;border:1px solid #ccc}
button{background:#007bff;color:white;border:none}
button:hover{background:#0056b3}
.tabs{display:flex}
.tab{flex:1;background:#ddd;margin:2px;padding:10px;border-radius:5px;cursor:pointer}
.tab.active{background:#007bff;color:white}
#chatbox{height:260px;overflow:auto;border:1px solid #ccc;padding:5px;text-align:left}
iframe{width:100%;height:380px;border:none;border-radius:10px}
@media(max-width:480px){iframe{height:300px}}
</style>
</head>

<body>
<div class="container">

<h2>üìû Yubaraj Chaulagai Calling Website</h2>

<!-- REGISTER -->
<div id="reg" class="box">
<h3>Register</h3>
<input id="rid" placeholder="Member ID">
<input id="rname" placeholder="Name">
<input id="remail" placeholder="Email">
<input id="rpass" placeholder="Password">
<button onclick="register()">Register</button>
</div>

<!-- LOGIN -->
<div id="log" class="box">
<h3>Login</h3>
<input id="lid" placeholder="Member ID">
<input id="lpass" placeholder="Password">
<button onclick="login()">Login</button>
</div>

<!-- DASHBOARD -->
<div id="dash" style="display:none">

<div class="tabs">
<div class="tab active" onclick="openTab('chat',this)">üí¨ Chat</div>
<div class="tab" onclick="openTab('pass',this)">üîë Password</div>
<div class="tab" onclick="openTab('call',this)">üìû Call</div>
</div>

<!-- CHAT -->
<div id="tab-chat" class="box">
<select id="recipient">
<option value="All">All Members</option>
</select>

<div id="chatbox"></div>

<input id="msg" placeholder="Message">
<button onclick="sendMsg()">Send</button>
</div>

<!-- PASSWORD -->
<div id="tab-pass" class="box" style="display:none">
<input id="email" placeholder="Email">
<button onclick="sendOTP()">Send OTP</button>
<input id="otp" placeholder="OTP">
<input id="newpass" placeholder="New Password">
<button onclick="changePass()">Change Password</button>
</div>

<!-- CALL -->
<div id="tab-call" class="box" style="display:none">
<button onclick="startCall()">üé• Start Camera</button>
<button onclick="closeCall()">‚ùå Close Camera</button>
<div id="callbox"></div>
</div>

</div>
</div>

<script>
const API="https://script.google.com/macros/s/AKfycbxDxdFOteKq4lCd9JZPTMFuzIoUTpXVYY9CdACzETBVY9KwVG-ESuQVJCCMnXt8BLFv1Q/exec"; // ‡§Ø‡§π‡§æ‡§Å Apps Script URL ‡§∞‡§æ‡§ñ‡•ç‡§®‡•Å‡§π‡•ã‡§∏‡•ç
let userName="",userID="";

// TAB SWITCH
function openTab(tab,btn){
document.getElementById("tab-chat").style.display="none";
document.getElementById("tab-pass").style.display="none";
document.getElementById("tab-call").style.display="none";
document.getElementById("tab-"+tab).style.display="block";
document.querySelectorAll(".tab").forEach(t=>t.classList.remove("active"));
btn.classList.add("active");
}

// REGISTER
function register(){
fetch(API,{method:"POST",
body:new URLSearchParams({
action:"register",
id:rid.value,
name:rname.value,
email:remail.value,
pass:rpass.value
})}).then(r=>r.text()).then(alert);
}

// LOGIN
function login(){
userID=lid.value;
fetch(API,{method:"POST",
body:new URLSearchParams({
action:"login",
id:lid.value,
pass:lpass.value
})})
.then(r=>r.text())
.then(t=>{
if(t!="FAIL"){
userName=t;
reg.style.display="none";
log.style.display="none";
dash.style.display="block";
loadMembers();
getChat();
alert("Login Successful");
}else alert("Wrong ID or Password");
});
}

// LOAD MEMBER NAMES FROM USERS SHEET
function loadMembers(){
fetch(API+"?action=getMembers")
.then(r=>r.json())
.then(list=>{
let sel=document.getElementById("recipient");
sel.innerHTML='<option value="All">All Members</option>';
list.forEach(n=>{
let o=document.createElement("option");
o.value=n;
o.textContent=n;
sel.appendChild(o);
});
});
}

// SEND MESSAGE
function sendMsg(){
if(msg.value.trim()=="")return;
fetch(API,{method:"POST",
body:new URLSearchParams({
action:"chat",
from:userName,
to:recipient.value,
msg:msg.value
})});
msg.value="";
}

// GET CHAT
function getChat(){
fetch(API)
.then(r=>r.json())
.then(data=>{
let html="";

data.forEach((row,i)=>{

if(i==0) return; // skip header

let from = row[1];
let to   = row[2];
let msg  = row[3];

// PUBLIC MESSAGE
if(to=="All"){
html += "<p><b>"+from+" (Public):</b> "+msg+"</p>";
}

// PRIVATE MESSAGE (only sender & receiver)
else if((from==userName && to!="All") || (to==userName)){
html += "<p style='color:green'><b>"+from+" (Private):</b> "+msg+"</p>";
}

});

chatbox.innerHTML = html;
chatbox.scrollTop = chatbox.scrollHeight;

});
}
  // OTP
function sendOTP(){
fetch(API,{method:"POST",
body:new URLSearchParams({action:"sendOTP",email:email.value})
}).then(r=>r.text()).then(alert);
}

// CHANGE PASSWORD
function changePass(){
fetch(API,{method:"POST",
body:new URLSearchParams({
action:"verifyOTP",
email:email.value,
otp:otp.value
})})
.then(r=>r.text())
.then(t=>{
if(t=="OTP OK"){
fetch(API,{method:"POST",
body:new URLSearchParams({
action:"changePass",
id:userID,
newpass:newpass.value
})}).then(r=>r.text()).then(alert);
}else alert("Wrong OTP");
});
}

// CALL
function startCall(){
callbox.innerHTML=
'<iframe src="https://p2p.mirotalk.com/YubarajRoom#config.startWithVideoMuted=true" allow="camera; microphone;"></iframe>';
}
function closeCall(){
callbox.innerHTML="";
}
</script>

</body>
</html>
