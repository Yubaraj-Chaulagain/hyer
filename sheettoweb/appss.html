<!DOCTYPE html>
<html lang="ne">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Yubaraj WhatsApp Style Chat</title>
<style>
body{margin:0;font-family:sans-serif;background:#ece5dd}
header{background:#075e54;color:white;padding:10px;display:flex;justify-content:space-between;align-items:center}
#member{padding:5px;font-size:16px}
#status{font-size:14px}
#chat{height:400px;overflow-y:auto;padding:10px;background:#e5ddd5}
.msg{padding:8px;margin:4px;border-radius:8px;max-width:80%;word-wrap:break-word}
.me{background:#dcf8c6;margin-left:auto;text-align:right}
.other{background:white;margin-right:auto;text-align:left}
.typing{font-size:12px;color:gray;margin:2px 10px}
input,button{padding:10px;margin:5px;font-size:15px;border-radius:5px}
#controls{display:flex;justify-content:space-between;align-items:center;padding:5px;background:#fff}
#cam{width:150px;height:120px;border-radius:8px;margin-top:5px}
</style>
</head>
<body>

<header>
<select id="member"></select>
<span id="status">Offline</span>
</header>

<div id="chat"></div>
<div class="typing" id="typing"></div>

<div id="controls">
<input id="msg" placeholder="Message">
<button onclick="send()">Send</button>
<button onclick="voice()">üé§</button>
<button onclick="startCam()">üìπ Start</button>
<button onclick="stopCam()">‚ùå Close</button>
</div>

<video id="cam" autoplay></video>

<script>
// ================= GLOBAL VARIABLES
const API = "https://script.google.com/macros/s/AKfycbwNf_BWROemCPz9fnFMVUrQM7sO_en1AQIylFz0oiM_w0P6jvlE4REI7axofJ5AmIxwxA/exec"; // replace with your Apps Script WebApp URL
const ME = prompt("Enter your name:");
const privateMode = true;

// ================= LOAD USERS
async function loadUsers(){
  let r = await fetch(API+"?action=users");
  let users = await r.json();
  member.innerHTML = users.map(u=>`<option>${u}</option>`).join("");
  member.value = users[0]; // default selected
}
loadUsers();

// ================= SEND MESSAGE
async function send(){
  if(privateMode && member.value!="Admin") return; // private mode
  if(msg.value.trim()=="") return;
  await fetch(API+`?action=send&from=${ME}&to=${member.value}&msg=${msg.value}`);
  msg.value="";
}

// ================= LOAD MESSAGES
setInterval(loadMsgs,2000);
async function loadMsgs(){
  let r = await fetch(API+"?action=msgs");
  let data = await r.json();
  chat.innerHTML="";
  data.slice(1).forEach(m=>{
    if((m[1]==ME && m[2]==member.value)||(m[1]==member.value && m[2]==ME)){
      let cls = m[1]==ME?"me":"other";
      let seen = m[5]?" ‚úì‚úì":"";
      chat.innerHTML += `<div class="msg ${cls}">${m[3]}${seen}</div>`;
    }
  });
  chat.scrollTop = chat.scrollHeight;
}

// ================= TYPING INDICATOR
msg.oninput = () => fetch(API+`?action=typing&name=${ME}&to=${member.value}`);
setInterval(loadTyping,1000);
async function loadTyping(){
  let r = await fetch(API+"?action=typing");
  let data = await r.json();
  let t = data.slice(1).filter(x=>x[1]==ME || x[1]==member.value);
  typing.innerHTML = t.length>0 ? `${t[0][0]} Typing...` : "";
}

// ================= ONLINE STATUS
setInterval(()=>{
  fetch(API+`?action=online&name=${ME}`);
  status.innerHTML="üü¢ Online";
},5000);

// ================= VOICE MESSAGE
async function voice(){
  let stream = await navigator.mediaDevices.getUserMedia({audio:true});
  alert("Voice sent (demo)"); // actual recording upload needs server handling
}

// ================= CAMERA
let camStream;
async function startCam(){
  camStream = await navigator.mediaDevices.getUserMedia({video:true});
  cam.srcObject = camStream;
}
function stopCam(){
  if(camStream) camStream.getTracks().forEach(t=>t.stop());
  cam.srcObject = null;
}

</script>
</body>
</html>
