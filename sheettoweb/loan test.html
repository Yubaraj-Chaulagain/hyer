<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Loan Workflow System</title>
<style>
*{
  box-sizing:border-box;
  margin:0;
  padding:0;
  font-family: 'Segoe UI', sans-serif;
}

body{
  background:#0f172a;
  color:#fff;
  max-width:480px;
  margin:auto;
  padding:15px;
}

h3{
  margin:10px 0;
  font-size:18px;
  color:#22c55e;
}

nav{
  display:flex;
  flex-wrap:wrap;
  justify-content:space-between;
  margin-bottom:10px;
}

nav button{
  flex:1;
  margin:3px;
  padding:8px;
  border:none;
  border-radius:8px;
  font-size:12px;
  background:#1e293b;
  color:#fff;
}

nav button:hover{
  background:#22c55e;
  color:#000;
}

.tab{
  display:none;
  margin-top:10px;
  background:#1e293b;
  padding:12px;
  border-radius:12px;
  box-shadow:0 4px 12px rgba(0,0,0,0.4);
}

input,select{
  width:100%;
  padding:8px;
  margin:6px 0;
  border-radius:8px;
  border:none;
  background:#0f172a;
  color:#fff;
  border:1px solid #334155;
}

button{
  width:100%;
  padding:10px;
  margin-top:8px;
  border:none;
  border-radius:10px;
  font-weight:bold;
  font-size:14px;
  background:#22c55e;
  color:#000;
}

button:active{
  transform:scale(0.97);
}

.reject{
  background:#ef4444;
  color:#fff;
}

.reRequest{
  background:#facc15;
  color:#000;
}

.edit{
  background:#3b82f6;
  color:#fff;
}

table{
  width:100%;
  margin-top:10px;
  border-collapse:collapse;
  font-size:12px;
}

th,td{
  border:1px solid #334155;
  padding:6px;
  text-align:center;
}

th{
  background:#0f172a;
  color:#22c55e;
}

@media(max-width:480px){
  table{
    font-size:11px;
  }
}
</style>
</head>
<body>

<!-- ===== TABS ===== -->
<nav id="tabsNav">
  <button onclick="showTab('newRequest')">New Request</button>
  <button onclick="showTab('rejected')">Rejected / Re-Request</button>
  <button onclick="showTab('managerTab')">Manager Panel</button>
  <button onclick="showTab('adminTab')">Admin Panel</button>
</nav>

<!-- ===== STAFF NEW REQUEST ===== -->
<div id="newRequest" class="tab">
<h3>New Loan Request</h3>
MemberID <select id="staffMember"></select><br>
Amount <input id="staffAmount" type="number"><br>
Months <input id="staffMonths" type="number"><br>
Interest % <input id="staffInterest" type="number"><br>
<button onclick="sendRequest()">Send Loan Request</button>
</div>

<!-- ===== STAFF REJECTED / RE-REQUEST ===== -->
<div id="rejected" class="tab">
<h3>Rejected / Re-Requestable Loans</h3>
<table id="staffTbl"></table>
</div>

<!-- ===== MANAGER PANEL ===== -->
<div id="managerTab" class="tab">
<h3>Manager Panel</h3>
<button onclick="loadManagerPending()">Load Pending</button>
<table id="managerTbl"></table>
</div>

<!-- ===== ADMIN PANEL ===== -->
<div id="adminTab" class="tab">
<h3>Admin Panel</h3>
<button onclick="loadAdminPending()">Load Manager Approved</button>
<table id="adminTbl"></table>
</div>

<script>
const URL="https://script.google.com/macros/s/AKfycbxLe_AM3mvaVJowu2WfiXpbRrl85utnRfc_xcUY-YTuvRkC0D-CP37YuC7oi01CQB375g/exec";

// ===== ROLE BASED VIEW =====
function switchRole(){
  const role = roleSelect.value;
  const tabs = {newRequest:['staff','admin'], rejected:['staff','admin'], managerTab:['manager','admin'], adminTab:['admin']};
  for(const tab in tabs){
    document.getElementById(tab).style.display = tabs[tab].includes(role)?'block':'none';
  }
}

// Show tab by clicking
function showTab(tabId){
  document.querySelectorAll('.tab').forEach(t=>t.style.display='none');
  document.getElementById(tabId).style.display='block';
}

// ===== STAFF FUNCTIONS =====
function loadMembers(){
 fetch(URL,{method:"POST",body:JSON.stringify({action:"getMembers"})})
 .then(r=>r.json()).then(list=>{
  staffMember.innerHTML="";
  list.forEach(x=>{
    staffMember.innerHTML+=`<option value="${x.MemberID}">${x.MemberID} - ${x.Name}</option>`;
  });
 });
}

function sendRequest(){
 fetch(URL,{method:"POST",body:JSON.stringify({
   action:"addLoanRequest",
   MemberID:staffMember.value,
   Amount:staffAmount.value,
   Months:staffMonths.value,
   Interest:staffInterest.value
 })}).then(r=>r.json()).then(a=>{
   alert("Loan Request Sent");
   loadStaffRejected();
 });
}

// Load rejected loans to allow Re-Request + Delete
function loadStaffRejected(){
 fetch(URL, {
   method: "POST",
   body: JSON.stringify({action:"getRejected"})
 })
 .then(r => r.json())
 .then(list => {
   let h = "<tr><th>ID</th><th>Member</th><th>Amount</th><th>Action</th></tr>";
   list.forEach(x => {
     h += `<tr>
       <td>${x.RequestID}</td>
       <td>${x.MemberID} - ${x.Name}</td>
       <td>${x.Amount}</td>
       <td>
         <button class="reRequest" onclick="reRequest('${x.RequestID}')">Re-Request</button>
         <button class="reject" onclick="deleteRequest('${x.RequestID}')">Delete</button>
       </td>
     </tr>`;
   });
   staffTbl.innerHTML = h;
 });
}
function reRequest(id){
 fetch(URL,{method:"POST",body:JSON.stringify({
   action:"reRequest",
   RequestID:id
 })}).then(()=>loadStaffRejected());
}

function deleteRequest(id){
 fetch(URL, {
   method:"POST",
   body: JSON.stringify({action:"deleteRequest", RequestID:id})
 })
 .then(()=>loadStaffRejected());
}

// ===== MANAGER FUNCTIONS =====
function loadManagerPending(){
 fetch(URL,{method:"POST",body:JSON.stringify({action:"getManagerPending"})})
 .then(r=>r.json())
 .then(list=>{
   let h="<tr><th>ID</th><th>Member</th><th>Amount</th><th>Action</th></tr>";
   list.forEach(x=>{
     h+=`<tr>
<td>${x.RequestID}</td>
<td>${x.MemberID} - ${x.Name}</td>
<td><input value="${x.Amount}" id="amt_${x.RequestID}" style="width:80px"></td>
<td>
<button onclick="managerAction('${x.RequestID}',true)">Approve</button>
<button class="reject" onclick="managerAction('${x.RequestID}',false)">Reject</button>
</td>
</tr>`;
   });
   managerTbl.innerHTML=h;
 });
}

function managerAction(id,approve){
 const newAmt = document.getElementById(`amt_${id}`)?.value;
 fetch(URL,{method:"POST",body:JSON.stringify({
   action:"managerAction",
   RequestID:id,
   approve:approve,
   Amount:newAmt
 })}).then(()=>loadManagerPending());
}

// ===== ADMIN FUNCTIONS =====
function loadAdminPending(){
 fetch(URL,{method:"POST",body:JSON.stringify({action:"getAdminPending"})})
 .then(r=>r.json())
 .then(list=>{
   let h="<tr><th>ID</th><th>Member</th><th>Amount</th><th>Action</th></tr>";
   list.forEach(x=>{
     h+=`<tr>
<td>${x.RequestID}</td>
<td>${x.MemberID} - ${x.Name}</td>
<td><input value="${x.Amount}" id="admamt_${x.RequestID}" style="width:80px"></td>
<td>
<button onclick="adminApprove('${x.RequestID}')">Approve</button>
<button class="reject" onclick="adminReject('${x.RequestID}')">Reject</button>
</td>
</tr>`;
   });
   adminTbl.innerHTML=h;
 });
}

function adminApprove(id){
 const newAmt = document.getElementById(`admamt_${id}`)?.value;
 fetch(URL,{method:"POST",body:JSON.stringify({action:"adminApprove",RequestID:id,Amount:newAmt})})
 .then(()=>loadAdminPending());
}

function adminReject(id){
 fetch(URL,{method:"POST",body:JSON.stringify({action:"adminReject",RequestID:id})})
 .then(()=>loadAdminPending());
}

// Init
loadMembers();
loadStaffRejected();
switchRole();
</script>
</body>
</html>
