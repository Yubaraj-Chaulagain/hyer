<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Loan Workflow System</title>
    <style>
        /* Base styles (Mobile First) */
        body { font-family: sans-serif; margin: 0; padding: 10px; }
        .container { width: 100%; background-color: lightblue; padding: 20px; }

        /* Mobile Styles (< 480px) */
        @media only screen and (max-width: 480px) {
            body { background-color: #ffcccc; }
            .container { font-size: 14px; }
        }

        /* Tablet Styles (481px - 768px) */
        @media only screen and (min-width: 481px) and (max-width: 768px) {
            body { background-color: #ccffcc; }
            .container { font-size: 16px; }
        }

        /* Chromebook & Computer Styles (> 769px) */
        @media only screen and (min-width: 769px) {
            body { background-color: #ccccff; }
            .container { width: 80%; margin: 0 auto; font-size: 18px; }
        }
    </style>
</head>
<body>

<!-- ===== TABS ===== -->
<nav id="tabsNav">
  <button onclick="showTab('newRequest')">New Request</button>
  <button onclick="showTab('rejected')">Rejected / Re-Request</button>
  <button onclick="showTab('staffApproved'); loadStaffApproved();">Approved Loans</button>
  <button onclick="showTab('managerTab')">Manager Panel</button>
  <button onclick="showTab('adminTab')">Admin Panel</button>
<button onclick="showTab('loginTab')">Member Login</button>
<button onclick="showTab('emiTab')">EMI Schedule</button>
<button onclick="showTab('paymentTab');loadPayments()">Payment History</button>
<button onclick="showTab('reportTab');loadBranch()">Branch Report</button>
</nav>

    <!-- LOGIN -->
<div id="loginTab" class="tab">
<h3>Member Login</h3>
MemberID <input id="loginID"><br>
Password <input id="loginPass" type="password"><br>
<button onclick="login()">Login</button>
<div id="loginMsg"></div>
</div>


<!-- ===== STAFF NEW REQUEST ===== -->
<div id="newRequest" class="tab">
<h3>New Loan Request</h3>
MemberID <select id="staffMember"></select><br>
Amount <input id="staffAmount" type="number"><br>
Months <input id="staffMonths" type="number"><br>
Interest % <input id="staffInterest" type="number"><br>
<button onclick="sendRequest()">Send Loan Request</button>
</div>
    

<!-- ===== STAFF REJECTED / RE-REQUEST ===== -->
<div id="rejected" class="tab">
<h3>Rejected / Re-Requestable Loans</h3>
<table id="staffTbl"></table>
</div>
   <!-- ===== STAFF APPROVED LOANS ===== -->
<div id="staffApproved" class="tab" style="display:none">
  <h3>Approved Loans (Ready to Disburse)</h3>
  <table id="staffApprovedTbl" border="1"></table>
</div>

<!-- ===== MANAGER PANEL ===== -->
<div id="managerTab" class="tab">
<h3>Manager Panel</h3>
<button onclick="loadManagerPending()">Load Pending</button>
<table id="managerTbl"></table>
</div>

<!-- ===== ADMIN PANEL ===== -->
<div id="adminTab" class="tab">
<h3>Admin Panel</h3>
<button onclick="loadAdminPending()">Load Manager Approved</button>
<table id="adminTbl"></table>
</div>

    <div id="emiTab" class="tab">
<h3>Loan Schedule (CSV to Table)</h3>

LoanID:
<input type="text" id="searchLoan" placeholder="Enter LoanID">
<button onclick="loadTable()">Search</button>

<br><br>

<table border="1" style="width:100%;border-collapse:collapse">
<thead id="tableHead"></thead>
<tbody id="tableBody"></tbody>
</table>
</div>

<script>

const CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSvptoJrnOKkO7B23z_y0nz1MlO9oyN8FjrDO_UDKud9yeg2slYFyihi1RKs5TtuCxrShwfu2iDWtOH/pub?gid=1447192810&single=true&output=csv";

async function loadTable() {

  const res = await fetch(CSV_URL);
  const text = await res.text();

  const rows = text.trim().split("\n").map(r =>
    r.split(",").map(c => c.replace(/"/g,"").trim())
  );

  const headers = rows[0];
  const searchValue = document.getElementById("searchLoan").value.trim();

  // Find LoanID column
  const loanIndex = headers.findIndex(h => 
    h.toLowerCase() === "loanid"
  );

  let filteredRows = rows.slice(1);

  if (searchValue && loanIndex !== -1) {
    filteredRows = filteredRows.filter(r => 
      r[loanIndex] === searchValue
    );
  }

  // Create table header
  document.getElementById("tableHead").innerHTML =
    "<tr>" + headers.map(h => `<th>${h}</th>`).join("") + "</tr>";

  // Create table body
  document.getElementById("tableBody").innerHTML =
    filteredRows.map(r =>
      "<tr>" + r.map(c => `<td>${c}</td>`).join("") + "</tr>"
    ).join("");

}

</script>
  
    <!-- PAYMENT -->
<div id="paymentTab" class="tab">
<h3>Payment History</h3>
LoanID <input id="payLoan"><button onclick="loadPayments()">Load</button>
<table id="payTbl"></table>
</div>

<!-- REPORT -->
<div id="reportTab" class="tab">
<h3>Branch Report</h3>
Branch <input id="branchName">
<button onclick="loadBranch()">Load</button>
<table id="branchTbl"></table>
</div>

<script>
const URL="https://script.google.com/macros/s/AKfycbxL6uNAu-PxHD_mmUk_MjSCuj22GjPsYGjNu-n5ktFC7jJ3UHjDIxsHtv35Ia07Lr9UuQ/exec";

// ===== ROLE BASED VIEW =====
function switchRole(){
  const role = roleSelect.value;
  const tabs = {newRequest:['staff','admin'], rejected:['staff','admin'], managerTab:['manager','admin'], adminTab:['admin']};
  for(const tab in tabs){
    document.getElementById(tab).style.display = tabs[tab].includes(role)?'block':'none';
  }
}

// Show tab by clicking
function showTab(tabId){
  document.querySelectorAll('.tab').forEach(t => t.style.display='none');
  document.getElementById(tabId).style.display='block';
}
    // LOGIN
function login(){
 fetch(URL,{method:"POST",body:JSON.stringify({
  action:"login",
  id:loginID.value,
  pass:loginPass.value
 })})
 .then(r=>r.json())
 .then(a=>{
  loginMsg.innerHTML=a.ok?"Welcome "+a.name:"Login Failed";
 });
}

// EMI
async function loadEMI() {
  const loanID = document.getElementById("emiLoan").value.trim();
  const head = document.getElementById("emiTblHead");
  const body = document.getElementById("emiTblBody");

  head.innerHTML = "";
  body.innerHTML = "";

  if (!loanID) return alert("Enter LoanID");

  try {
    const res = await fetch("https://script.google.com/macros/s/AKfycbzyBaOakjGCo-_cHc3ysETEuU-y_cJ4vxoazsLGtxUWP_4iXyQl2pUjF3gHJ8x3jYa-xA/exec", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ action: "getEMI", LoanID: loanID })
    });

    if (!res.ok) throw new Error("Fetch failed");

    const data = await res.json();

    // Filter: only unpaid EMI
    const filtered = data.filter(r => r.Paid === false);

    if (filtered.length === 0) {
      body.innerHTML = "<tr><td colspan='20'>No Pending EMI</td></tr>";
      return;
    }

    // Table headers from keys
    const headers = Object.keys(filtered[0]);
    head.innerHTML = "<tr>" + headers.map(h => `<th>${h}</th>`).join("") + "</tr>";

    // Table rows
    body.innerHTML = filtered.map(r => {
      return "<tr>" + headers.map(h => {
        if (h === "DueDate") {
          return `<td>${new Date(r[h]).toISOString().slice(0,10)}</td>`;
        } else if (h === "Paid") {
          return `<td><input type="checkbox" disabled ${r[h] ? "checked" : ""}></td>`;
        } else {
          return `<td>${r[h]}</td>`;
        }
      }).join("") + "</tr>";
    }).join("");

  } catch (err) {
    console.error(err);
    body.innerHTML = "<tr><td colspan='20'>Error loading EMI</td></tr>";
  }
}
// PAYMENT
function loadPayments(){
 fetch(URL,{method:"POST",body:JSON.stringify({
  action:"getPayments",
  LoanID:payLoan.value
 })})
 .then(r=>r.json())
 .then(list=>{
  let h="<tr><th>ID</th><th>Amount</th><th>Date</th></tr>";
  list.forEach(x=>{
    h+=`<tr>
     <td>${x.PaymentID}</td>
     <td>${x.Amount}</td>
     <td>${x.Date}</td>
    </tr>`;
  });
  payTbl.innerHTML=h;
 });
}

// BRANCH REPORT
function loadBranch(){
 fetch(URL,{method:"POST",body:JSON.stringify({
  action:"branchReport",
  Branch:branchName.value
 })})
 .then(r=>r.json())
 .then(list=>{
  let total=0;
  let h="<tr><th>LoanID</th><th>Member</th><th>Amount</th></tr>";
  list.forEach(x=>{
    total+=Number(x.Amount);
    h+=`<tr>
     <td>${x.LoanID}</td>
     <td>${x.MemberID}</td>
     <td>${x.Amount}</td>
    </tr>`;
  });
  h+=`<tr><th colspan=2>Total</th><th>${total}</th></tr>`;
  branchTbl.innerHTML=h;
 });
}

// ===== STAFF FUNCTIONS =====
function loadMembers(){
 fetch(URL,{method:"POST",body:JSON.stringify({action:"getMembers"})})
 .then(r=>r.json()).then(list=>{
  staffMember.innerHTML="";
  list.forEach(x=>{
    staffMember.innerHTML+=`<option value="${x.MemberID}">${x.MemberID} - ${x.Name}</option>`;
  });
 });
}

function sendRequest(){
 fetch(URL,{
   method:"POST",
   body:JSON.stringify({
     action:"addLoanRequest",
     role:"staff",   // ðŸ‘ˆ important
     MemberID:staffMember.value,
     Amount:staffAmount.value,
     Months:staffMonths.value,
     Interest:staffInterest.value
   })
 }).then(r=>r.json()).then(a=>{
   alert(a.msg || (a.status ? "Loan Request Sent Successfully" : "Error Sending Request"));
   staffAmount.value = "";
   staffMonths.value = "";
   staffInterest.value = "";
   staffMember.selectedIndex = 0;  // Optional: reset to first member

   loadStaffRejected();   // table refresh
 });
}

// Load rejected loans to allow Re-Request + Delete
function loadStaffRejected(){
 fetch(URL, {
   method: "POST",
   body: JSON.stringify({action:"getRejected"})
 })
 .then(r => r.json())
 .then(list => {
   let h = "<tr><th>ID</th><th>Member</th><th>Amount</th><th>Action</th></tr>";
   list.forEach(x => {
     h += `<tr>
       <td>${x.RequestID}</td>
       <td>${x.MemberID} - ${x.Name}</td>
       <td>${x.Amount}</td>
       <td>
         <button class="reRequest" onclick="reRequest('${x.RequestID}')">Re-Request</button>
         <button class="reject" onclick="deleteRequest('${x.RequestID}')">Delete</button>
       </td>
     </tr>`;
   });
   staffTbl.innerHTML = h;
 });
}
function reRequest(id){
 fetch(URL,{method:"POST",body:JSON.stringify({
   action:"reRequest",
   RequestID:id
 })}).then(()=>loadStaffRejected());
}

function deleteRequest(id){
 fetch(URL, {
   method:"POST",
   body: JSON.stringify({action:"deleteRequest", RequestID:id})
 })
 .then(()=>loadStaffRejected());
}
    
function loadStaffApproved(){
  fetch(URL,{
    method:"POST",
    body: JSON.stringify({action:"getStaffApproved"})
  })
  .then(r=>r.json())
  .then(list=>{
    console.log("Approved Loans:", list);   // ðŸ‘ˆ check browser console

    let h = "<tr><th>ID</th><th>Member</th><th>Amount</th><th>Action</th></tr>";

    if(!list || list.length==0){
      h += "<tr><td colspan=4>No Approved Loans</td></tr>";
    }

    list.forEach(x=>{
      h += `<tr>
        <td>${x.RequestID}</td>
        <td>${x.MemberID}</td>
        <td>${x.Amount}</td>
        <td><button onclick="disburseLoan('${x.RequestID}')">Disburse</button></td>
      </tr>`;
    });

    staffApprovedTbl.innerHTML = h;
  });
}
function disburseLoan(id){
  fetch(URL,{
    method:"POST",
    body: JSON.stringify({action:"staffDisburse", RequestID:id})
  })
  .then(r=>r.json())
  .then(res=>{
    alert(res.msg || (res.status?"Success":"Error"));
    loadStaffApproved();
  });
}
// ===== MANAGER FUNCTIONS =====
function loadManagerPending(){
 fetch(URL,{method:"POST",body:JSON.stringify({action:"getManagerPending"})})
 .then(r=>r.json())
 .then(list=>{
   let h="<tr><th>ID</th><th>Member</th><th>Amount</th><th>Action</th></tr>";
   list.forEach(x=>{
     h+=`<tr>
<td>${x.RequestID}</td>
<td>${x.MemberID} - ${x.Name}</td>
<td><input value="${x.Amount}" id="amt_${x.RequestID}" style="width:80px"></td>
<td><input value="${x.Months}" id="months_${x.RequestID}" style="width:50px"></td>
<td><input value="${x.Interest}" id="int_${x.RequestID}" style="width:50px"></td>
<td>
<button onclick="managerAction('${x.RequestID}',true)">Approve</button>
<button class="reject" onclick="managerAction('${x.RequestID}',false)">Reject</button>
</td>
</tr>`;
   });
   managerTbl.innerHTML=h;
 });
}

function managerAction(id, approve){
  const newAmt = document.getElementById(`amt_${id}`)?.value;
  const newMonths = document.getElementById(`months_${id}`)?.value;
  const newInterest = document.getElementById(`int_${id}`)?.value;

  fetch(URL,{
    method:"POST",
    body: JSON.stringify({
      action:"managerAction",
      RequestID: id,
      approve: approve,
      Amount: newAmt,
      Months: newMonths,
      Interest: newInterest
    })
  })
  .then(r => r.json())
  .then(res => {
    alert(res.msg || (res.status ? "Success" : "Error"));
    loadManagerPending(); // refresh table
  });
}
// ===== ADMIN FUNCTIONS =====
function loadAdminPending(){
 fetch(URL,{method:"POST",body:JSON.stringify({action:"getAdminPending"})})
 .then(r=>r.json())
 .then(list=>{
   let h="<tr><th>ID</th><th>Member</th><th>Amount</th><th>Action</th></tr>";
   list.forEach(x=>{
     h+=`<tr>
<td>${x.RequestID}</td>
<td>${x.MemberID} - ${x.Name}</td>
<td><input value="${x.Amount}" id="admamt_${x.RequestID}" style="width:80px"></td>
<td><input value="${x.Months}" id="months_${x.RequestID}" style="width:50px"></td>
<td><input value="${x.Interest}" id="int_${x.RequestID}" style="width:50px"></td>
<td>
<button onclick="adminApprove('${x.RequestID}')">Approve</button>
<button class="reject" onclick="adminReject('${x.RequestID}')">Reject</button>
</td>
</tr>`;
   });
   adminTbl.innerHTML=h;
 });
}

function adminApprove(id){
  const newAmt = document.getElementById(`admamt_${id}`)?.value;
  fetch(URL,{
    method:"POST",
    body: JSON.stringify({
      action:"adminApprove",
      RequestID: id,
      Amount: newAmt
    })
  })
  .then(r=>r.json())
  .then(res=>{
    alert(res.msg || (res.status ? "Success" : "Error"));
    loadAdminPending();
  });
}
function adminReject(id){
 fetch(URL,{method:"POST",body:JSON.stringify({action:"adminReject",RequestID:id})})
 .then(()=>loadAdminPending());
}

window.onload = function(){
  showTab('newRequest');   // First tab show
  loadMembers();
  loadStaffRejected();
}
</script>
</body>
</html>
