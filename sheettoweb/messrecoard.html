<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Billing System</title>
<style>
table { width:100%; border-collapse:collapse }
td,th { border:1px solid #aaa; padding:5px }
</style>
</head>
<body>
<div id="Messrecoard">
<h3>üßæ Billing System</h3>

<input id="member" placeholder="Member ID">
<button onclick="addRow()">+ Add Row</button>

<table id="bill">
<tr>
<th>S.N</th><th>Description</th><th>Qty</th>
<th>Rate</th><th>Total</th>
</tr>
</table>

<h4>
SubTotal: <span id="sub">0</span><br>
GST (13%): <span id="gst">0</span><br>
Grand Total: <span id="gt">0</span>
</h4>

<button onclick="saveBill()">üíæ Save Bill</button>
<button onclick="window.print()">üñ®Ô∏è Print</button>

<hr>
<input id="search" placeholder="Search MemberID">
<button onclick="searchBill()">Search</button>
  <h3>üìú Bills List</h3>
<table id="billList">
<tr>
  <th>Bill No</th>
  <th>Member</th>
  <th>Total</th>
  <th>Action</th>
</tr>
</table>

</div>
<script>
const URL = "https://script.google.com/macros/s/AKfycbwzbPIgIB19uTF7agfuD5dPIfPUdrzv_eYN_RUcDD-Ow1ZjfulK18mTv2KAeYuHsAof8Q/exec";
let sn = 0;

function addRow() {
  sn++;
  const t = document.getElementById("bill");
  const r = t.insertRow();
  r.innerHTML = `
    <td>${sn}</td>
    <td><input></td>
    <td><input type="number" oninput="calc()"></td>
    <td><input type="number" oninput="calc()"></td>
    <td class="tot">0</td>`;
}

function calc() {
  let sub = 0;
  document.querySelectorAll("#bill tr").forEach((r,i)=>{
    if(i==0) return;
    const q = r.cells[2].children[0].value||0;
    const rate = r.cells[3].children[0].value||0;
    const t = q*rate;
    r.cells[4].innerText = t;
    sub += t;
  });
  document.getElementById("sub").innerText = sub;
  document.getElementById("gst").innerText = sub*0.13;
  document.getElementById("gt").innerText = sub*1.13;
}

function saveBill() {
  let items = [];
  document.querySelectorAll("#bill tr").forEach((r,i)=>{
    if(i==0) return;
    items.push({
      desc: r.cells[1].children[0].value,
      qty: r.cells[2].children[0].value,
      rate: r.cells[3].children[0].value,
      total: r.cells[4].innerText
    });
  });

  fetch(URL,{
    method:"POST",
    body:JSON.stringify({
      action: editingBillNo ? "updateBill" : "saveBill",
      billNo: editingBillNo,
      member: member.value,
      subtotal: sub.innerText,
      gst: gst.innerText,
      total: gt.innerText,
      items: items
    })
  })
  .then(r=>r.json())
  .then(res=>{
    alert(editingBillNo ? "Bill Updated" : "Bill Saved");
    editingBillNo = null;
    location.reload();
  });
}

function searchBill() {
  fetch(URL,{
    method:"POST",
    body:JSON.stringify({
      action:"searchBill",
      member:search.value
    })
  })
  .then(r=>r.json())
  .then(list=>{
    const t = document.getElementById("billList");
    t.innerHTML = `
      <tr>
        <th>Bill No</th>
        <th>Member</th>
        <th>Total</th>
        <th>Action</th>
      </tr>`;

    list.forEach(b=>{
      const r = t.insertRow();
      r.innerHTML = `
        <td>${b.BillNo}</td>
        <td>${b.MemberID}</td>
        <td>${b.Total}</td>
        <td>
          <button onclick="editBill('${b.BillNo}')">‚úèÔ∏è Edit</button>
          <button onclick="deleteBill('${b.BillNo}')">‚ùå Delete</button>
        </td>`;
    });
  });
}

 function editBill(billNo){
  editingBillNo = billNo;

  fetch(URL,{
    method:"POST",
    body:JSON.stringify({
      action:"getBill",
      billNo: billNo
    })
  })
  .then(r=>r.json())
  .then(d=>{
    if(!d || !d.items){
      alert("Bill load failed");
      return;
    }

    member.value = d.member;

    document.getElementById("bill").innerHTML = `
      <tr>
        <th>S.N</th><th>Description</th>
        <th>Qty</th><th>Rate</th><th>Total</th>
      </tr>`;
    sn = 0;

    d.items.forEach(it=>{
      addRow();

      const rows = document.querySelectorAll("#bill tr");
      const r = rows[rows.length - 1];

      r.cells[1].children[0].value = it.desc;
      r.cells[2].children[0].value = it.qty;
      r.cells[3].children[0].value = it.rate;
      r.cells[4].innerText = it.total;
    });

    calc();
  });
}

  function deleteBill(billNo){
  if(!confirm("Delete this bill?")) return;

  fetch(URL,{
    method:"POST",
    body:JSON.stringify({
      action:"deleteBill",
      billNo:billNo
    })
  })
  .then(r=>r.json())
  .then(()=>{
    alert("Bill deleted");
    searchBill();
  });
}


</script>

</body>
</html>
