<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Billing System</title>
<style>
  .tab { display:none; }
  .tab.active { display:block; }
  table { width:100%; border-collapse:collapse }
  td,th { border:1px solid #aaa; padding:5px }
  .tab-buttons button { margin-right:5px; padding:5px 10px; }
</style>
</head>
  <div class="tab-buttons">
  <button onclick="showTab('billing')">üßæ Billing</button>
  <button onclick="showTab('list')">üìú Bills List</button>
</div>
<body onload="loadMembers()">
  <div id="billing" class="tab active">
<h3>üßæ Billing System</h3>

<input type="text" id="member" list="memberList" placeholder="Select Member or type...">
<datalist id="memberList"></datalist>
<input type="text" id="customMember" placeholder="Enter Customer Name" style="display:none">


<button onclick="addRow()">+</button>

<table id="bill">
<tr>
<th>S.N</th><th>Description</th><th>Qty</th>
<th>Rate</th><th>Total</th>
</tr>
</table>

<h4>
SubTotal: <span id="sub">0</span><br>
GST: <input type="number" id="gstManual" value="13" style="width:50px" oninput="calc()"><br>
Grand Total: <span id="gt">0</span>
</h4>

<button onclick="saveBill()">üíæ Save Bill</button>
<button onclick="window.print()">üñ®Ô∏è Print</button>
  </div>
<div id="list" class="tab">
<hr>
<input id="search" placeholder="Search MemberID">
<button onclick="searchBill()">Search</button>
  <h3>üìú Bills List</h3>
<table id="billList">
<tr>
  <th>Bill No</th>
  <th>Member</th>
  <th>Total</th>
  <th>Action</th>
</tr>
</table>

</div>
<script>
const URL = "https://script.google.com/macros/s/AKfycbyxZSIZk5x-o_wUnwJ5i9WA22DSM1odnwwOKzKpDIruavs3V9xc9AwKUpf93ZtfWpNU/exec";
let sn = 0;
let editingBillNo = null;   // ‚úÖ MUST

function addRow() {
  sn++;
  const t = document.getElementById("bill");
  const r = t.insertRow();
  r.innerHTML = `
    <td>${sn}</td>
    <td><input></td>
    <td><input type="number" oninput="calc()"></td>
    <td><input type="number" oninput="calc()"></td>
    <td class="tot">0</td>`;
}

function calc() {
  let sub = 0;
  document.querySelectorAll("#bill tr").forEach((r,i)=>{
    if(i==0) return; // skip header
    const q = parseFloat(r.cells[2].children[0].value) || 0;
    const rate = parseFloat(r.cells[3].children[0].value) || 0;
    const t = q * rate;
    r.cells[4].innerText = t.toFixed(2);
    sub += t;
  });

  document.getElementById("sub").innerText = sub.toFixed(2);

  const gstPercent = parseFloat(document.getElementById("gstManual").value) || 0;
  const gstAmount = sub * gstPercent / 100;

  document.getElementById("gt").innerText = (sub + gstAmount).toFixed(2);
}

  
function saveBill() {

  if (!member.value) {
    alert("Member ID required");
    return;
  }

  let items = [];

  document.querySelectorAll("#bill tr").forEach((r, i) => {
    if (i === 0) return;

    const desc = r.cells[1].children[0].value;
    const qty  = r.cells[2].children[0].value;
    const rate = r.cells[3].children[0].value;
    const total = r.cells[4].innerText;

    if (desc && qty && rate) {
      items.push({
        desc: desc,
        qty: qty,
        rate: rate,
        total: total
      });
    }
  });

  if (items.length === 0) {
    alert("At least one item required");
    return;
  }
const selectedMember = document.getElementById("member").value;
const isGuest = selectedMember === "guest";
  const memberName = isGuest 
                     ? document.getElementById("customMember").value 
                     : selectedMember;

if(!memberName){
  alert("Enter member or customer name");
  return;
}
  
  const txnPrefix = isGuest ? "CUSTXT" : "TXN";
  const txnNo = Math.floor(Math.random() * 90000) + 10000; 
  const transactionID = txnPrefix + txnNo;

 const payload = {
    action: editingBillNo ? "updateBill" : "saveBill",
    billNo: editingBillNo || "",
    member: memberName,
    subtotal: document.getElementById("sub").innerText,
    gst: document.getElementById("gstManual").value, // user input GST number
    total: document.getElementById("gt").innerText,
    items: items
};



  fetch(URL, {
    method: "POST",
    body: JSON.stringify(payload)
  })
  .then(res => res.json())
  .then(res => {
     alert(editingBillNo 
          ? `‚úÖ Bill Updated` 
          : `‚úÖ Bill Saved (Txn: ${transactionID})`);  // show txn ID
    // reset
    editingBillNo = null;
    showTab('list');  // Save ‡§™‡§õ‡§ø list ‡§Æ‡§æ ‡§ú‡§æ‡§®‡•ç‡§õ
    searchBill();
    document.getElementById("bill").innerHTML = `
      <tr>
        <th>S.N</th>
        <th>Description</th>
        <th>Qty</th>
        <th>Rate</th>
        <th>Total</th>
      </tr>`;
    sn = 0;
    member.value = "";
    document.getElementById("customMember").value = "";
    document.getElementById("sub").innerText = 0;
    document.getElementById("gst").innerText = 0;
    document.getElementById("gt").innerText = 0;

    searchBill(); // refresh list
  })
  .catch(err => {
    alert("‚ùå Save failed");
    console.error(err);
  });
}

function searchBill() {
  fetch(URL,{
    method:"POST",
    body:JSON.stringify({
      action:"searchBill",
      member:search.value
    })
  })
  .then(r=>r.json())
  .then(list=>{
    const t = document.getElementById("billList");
    t.innerHTML = `
      <tr>
        <th>Bill No</th>
        <th>Member</th>
        <th>Total</th>
        <th>Action</th>
      </tr>`;

    list.forEach(b=>{
      const r = t.insertRow();
      r.innerHTML = `
        <td>${b.BillNo}</td>
        <td>${b.MemberID}</td>
        <td>${b.GrandTotal}</td>

        <td>
          <button onclick="editBill('${b.BillNo}')">‚úèÔ∏è Edit</button>
          <button onclick="deleteBill('${b.BillNo}')">‚ùå Delete</button>
        </td>`;
    });
  });
}

 function editBill(billNo){
  editingBillNo = billNo;

  fetch(URL,{
    method:"POST",
    body:JSON.stringify({
      action:"getBill",
      billNo: billNo
    })
  })
  .then(r=>r.json())
  .then(d=>{
    if(!d || !d.items){
      alert("Bill load failed");
      return;
    }
   showTab('billing');
    member.value = d.member;

    document.getElementById("bill").innerHTML = `
      <tr>
        <th>S.N</th><th>Description</th>
        <th>Qty</th><th>Rate</th><th>Total</th>
      </tr>`;
    sn = 0;

    d.items.forEach(it=>{
      addRow();

      const rows = document.querySelectorAll("#bill tr");
      const r = rows[rows.length - 1];

      r.cells[1].children[0].value = it.desc;
      r.cells[2].children[0].value = it.qty;
      r.cells[3].children[0].value = it.rate;
      r.cells[4].innerText = it.total;
    });

    calc();
  });
}

  function deleteBill(billNo){
  if(!confirm("Delete this bill?")) return;

  fetch(URL,{
    method:"POST",
    body:JSON.stringify({
      action:"deleteBill",
      billNo:billNo
    })
  })
  .then(r=>r.json())
  .then(()=>{
    alert("Bill deleted");
    searchBill();
  });
}
  function showTab(tab){
  document.querySelectorAll('.tab').forEach(d=>d.classList.remove('active'));
  document.getElementById(tab).classList.add('active');
}
  
function loadMembers() {
  fetch(URL, {
    method: "POST",
    body: JSON.stringify({ action: "getMembers" })
  })
  .then(r => r.json())
  .then(data => {
    const list = document.getElementById("memberList");
    list.innerHTML = ""; // reset datalist

    data.forEach(m => {
      const opt = document.createElement("option");
      opt.value = m.MemberID + " - " + (m.Name || '');
      list.appendChild(opt);
    });

    // Add guest option
    const guest = document.createElement("option");
    guest.value = "Guest / Other Customer";
    list.appendChild(guest);
  });
}

// Guest toggle
document.getElementById("member").addEventListener("input", function() {
  const val = this.value;
  const input = document.getElementById("customMember");
  if(val.toLowerCase().includes("guest")) {
    input.style.display = "inline-block";
  } else {
    input.style.display = "none";
    input.value = "";
  }
});

loadMembers();

function toggleCustomMember(val) {
  const input = document.getElementById("customMember");
  if(val === "guest") {
    input.style.display = "inline-block";
  } else {
    input.style.display = "none";
    input.value = "";
  }
}


</script>

</body>
</html>
