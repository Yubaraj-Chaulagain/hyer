<!DOCTYPE html>
<html lang="ne">
<head>
<meta charset="UTF-8">
<title>‡§∏‡§π‡§ï‡§æ‡§∞‡•Ä ‡§∏‡§¶‡§∏‡•ç‡§Ø ‡§¶‡§∞‡•ç‡§§‡§æ ‡§´‡§æ‡§∞‡§Æ</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

<style>
body{background:#f4f6f8}
h6{border-bottom:2px solid #e5e7eb;padding-bottom:4px}
#sideNav{transition:width .3s}
.nav-link.active{background:#198754;border-radius:6px}
</style>
</head>

<body>

<div class="d-flex" style="min-height:100vh">

  <!-- ========== SIDE NAV ========== -->
  <div id="sideNav" class="bg-dark text-white p-3" style="width:240px">
    <h5 class="text-center mb-4">üè¶ ‡§∏‡§π‡§ï‡§æ‡§∞‡•Ä</h5>

    <ul class="nav flex-column gap-2">
      <li>
        <a class="nav-link text-white active" href="#"
           onclick="showSection('memberSection', this)">
          üë§ ‡§∏‡§¶‡§∏‡•ç‡§Ø ‡§µ‡§ø‡§µ‡§∞‡§£
        </a>
      </li>
      <li>
        <a class="nav-link text-white" href="#"
           onclick="showSection('transactionSection', this)">
          üí∞ Transaction
        </a>
      </li>
    </ul>
  </div>

  <!-- ========== CONTENT AREA ========== -->
  <div class="flex-grow-1 p-4 bg-light">

    <!-- TOP BAR -->
    <div class="d-flex align-items-center mb-3">
      <button class="btn btn-outline-success me-2" onclick="toggleNav()">‚ò∞</button>
      <h5 class="mb-0">‡§∏‡§π‡§ï‡§æ‡§∞‡•Ä Management System</h5>
    </div>

    <!-- ===== MEMBER SECTION ===== -->
    <div id="memberSection">
        <form id="memberForm">

<!-- ================== 1. PERSONAL ================== -->
<h6 class="text-primary">‡•ß. ‡§µ‡•ç‡§Ø‡§ï‡•ç‡§§‡§ø‡§ó‡§§ ‡§µ‡§ø‡§µ‡§∞‡§£</h6>
<div class="row mb-3">
  <div class="col-md-2">
    <label>‡§∏‡§¶‡§∏‡•ç‡§Ø ‡§®‡§Ç.</label>
    <input class="form-control" name="‡§∏‡§¶‡§∏‡•ç‡§Ø ‡§®‡§Ç.">
  </div>
  <div class="col-md-3">
  <label>‡§ñ‡§æ‡§§‡§æ ‡§®‡§Ç.</label>
  <input class="form-control" id="member_id" name="‡§ñ‡§æ‡§§‡§æ ‡§®‡§Ç." required>
  <div class="mt-1">
    <button type="button" class="btn btn-sm btn-primary" onclick="searchMember()">Search</button>
    <button type="button" class="btn btn-sm btn-warning" onclick="updateMember()">Update</button>
     <button type="button" class="btn btn-danger" onclick="deleteMember()">üóëÔ∏è Delete</button>
  </div>
</div>

  <div class="col-md-7">
    <label>‡§™‡•Ç‡§∞‡§æ ‡§®‡§æ‡§Æ</label>
    <input class="form-control" name="‡§™‡•Ç‡§∞‡§æ ‡§®‡§æ‡§Æ" required>
  </div>
</div>

<div class="row mb-3">
  <div class="col-md-4"><label>‡§¨‡•Å‡§¨‡§æ‡§ï‡•ã ‡§®‡§æ‡§Æ</label><input class="form-control" name="‡§¨‡•Å‡§¨‡§æ‡§ï‡•ã ‡§®‡§æ‡§Æ"></div>
  <div class="col-md-4"><label>‡§π‡§ú‡•Å‡§∞ ‡§¨‡•Å‡§¨‡§æ‡§ï‡•ã ‡§®‡§æ‡§Æ</label><input class="form-control" name="‡§π‡§ú‡•Å‡§∞ ‡§¨‡•Å‡§¨‡§æ‡§ï‡•ã ‡§®‡§æ‡§Æ"></div>
  <div class="col-md-4"><label>‡§™‡§§‡§ø / ‡§™‡§§‡•ç‡§®‡•Ä</label><input class="form-control" name="‡§™‡§§‡§ø / ‡§™‡§§‡•ç‡§®‡•Ä"></div>
</div>

<div class="row mb-3">
  <div class="col-md-4">
    <label>‡§≤‡§ø‡§ô‡•ç‡§ó</label>
    <select class="form-select" name="‡§≤‡§ø‡§ô‡•ç‡§ó">
      <option>‡§™‡•Å‡§∞‡•Å‡§∑</option><option>‡§Æ‡§π‡§ø‡§≤‡§æ</option><option>‡§Ö‡§®‡•ç‡§Ø</option>
    </select>
  </div>
  <div class="col-md-4"><label>‡§ú‡§®‡•ç‡§Æ ‡§Æ‡§ø‡§§‡§ø</label><input type="date" class="form-control" name="‡§ú‡§®‡•ç‡§Æ ‡§Æ‡§ø‡§§‡§ø"></div>
  <div class="col-md-4"><label>‡§®‡§æ‡§ó‡§∞‡§ø‡§ï‡§§‡§æ ‡§®‡§Ç.</label><input class="form-control" name="‡§®‡§æ‡§ó‡§∞‡§ø‡§ï‡§§‡§æ ‡§®‡§Ç."></div>
</div>

<!-- ================== 2. ADDRESS ================== -->
<h6 class="text-primary mt-4">‡•®. ‡§†‡•á‡§ó‡§æ‡§®‡§æ</h6>
<div class="row mb-3">
  <div class="col-md-3"><label>‡§™‡•ç‡§∞‡§¶‡•á‡§∂</label><select id="province" name="‡§™‡•ç‡§∞‡§¶‡•á‡§∂" class="form-select"></select></div>
  <div class="col-md-3"><label>‡§ú‡§ø‡§≤‡•ç‡§≤‡§æ</label><select id="district" name="‡§ú‡§ø‡§≤‡•ç‡§≤‡§æ" class="form-select"></select></div>
  <div class="col-md-3"><label>‡§™‡§æ‡§≤‡§ø‡§ï‡§æ</label><select id="municipality" name="‡§™‡§æ‡§≤‡§ø‡§ï‡§æ" class="form-select"></select></div>
  <div class="col-md-3"><label>‡§µ‡§°‡§æ ‡§®‡§Ç.</label><input class="form-control" name="‡§µ‡§°‡§æ ‡§®‡§Ç."></div>
</div>

<!-- ================== 3. CONTACT ================== -->
<h6 class="text-primary mt-4">‡•©. ‡§∏‡§Æ‡•ç‡§™‡§∞‡•ç‡§ï ‡§µ‡§ø‡§µ‡§∞‡§£</h6>
<div class="row mb-3">
  <div class="col-md-6"><label>‡§Æ‡•ã‡§¨‡§æ‡§á‡§≤ ‡§®‡§Ç.</label><input class="form-control" name="‡§Æ‡•ã‡§¨‡§æ‡§á‡§≤ ‡§®‡§Ç."></div>
  <div class="col-md-6"><label>‡§à‡§Æ‡•á‡§≤</label><input type="email" class="form-control" name="‡§à‡§Æ‡•á‡§≤"></div>
</div>

<!-- ================== 4. MEMBER TYPE ================== -->
<h6 class="text-primary mt-4">‡•™. ‡§∏‡§¶‡§∏‡•ç‡§Ø‡§ï‡•ã ‡§™‡•ç‡§∞‡§ï‡§æ‡§∞</h6>
<div class="row mb-3">
  <div class="col-md-4">
    <label>‡§∏‡§¶‡§∏‡•ç‡§Ø ‡§™‡•ç‡§∞‡§ï‡§æ‡§∞</label>
    <select class="form-select" name="‡§∏‡§¶‡§∏‡•ç‡§Ø ‡§™‡•ç‡§∞‡§ï‡§æ‡§∞">
      <option>‡§∏‡§æ‡§ß‡§æ‡§∞‡§£ ‡§∏‡§¶‡§∏‡•ç‡§Ø</option>
      <option>‡§∏‡§Ç‡§∏‡•ç‡§•‡§æ‡§™‡§ï ‡§∏‡§¶‡§∏‡•ç‡§Ø</option>
      <option>‡§ã‡§£‡•Ä ‡§∏‡§¶‡§∏‡•ç‡§Ø</option>
      <option>‡§¨‡§æ‡§≤ ‡§∏‡§¶‡§∏‡•ç‡§Ø</option>
    </select>
  </div>
  <div class="col-md-4"><label>‡§∏‡•á‡§Ø‡§∞ ‡§∏‡§Ç‡§ñ‡•ç‡§Ø‡§æ</label><input type="number" class="form-control" name="‡§∏‡•á‡§Ø‡§∞ ‡§∏‡§Ç‡§ñ‡•ç‡§Ø‡§æ"></div>
  <div class="col-md-4">
    <label>‡§∏‡§¶‡§∏‡•ç‡§Ø ‡§∏‡•ç‡§•‡§ø‡§§‡§ø</label>
    <select class="form-select" name="‡§∏‡§¶‡§∏‡•ç‡§Ø ‡§∏‡•ç‡§•‡§ø‡§§‡§ø">
      <option>‡§∏‡§ï‡•ç‡§∞‡§ø‡§Ø</option><option>‡§®‡§ø‡§∑‡•ç‡§ï‡•ç‡§∞‡§ø‡§Ø</option>
    </select>
  </div>
</div>

<!-- ================== 5. OCCUPATION ================== -->
<h6 class="text-primary mt-4">‡•´. ‡§™‡•á‡§∂‡§æ ‡§§‡§•‡§æ ‡§Ü‡§Æ‡•ç‡§¶‡§æ‡§®‡•Ä</h6>
<div class="row mb-3">
  <div class="col-md-6">
    <label>‡§™‡•á‡§∂‡§æ</label>
    <select class="form-select" name="‡§™‡•á‡§∂‡§æ">
      <option>‡§ï‡•É‡§∑‡§ø</option><option>‡§µ‡•ç‡§Ø‡§µ‡§∏‡§æ‡§Ø</option><option>‡§∏‡•á‡§µ‡§æ</option>
      <option>‡§µ‡•à‡§¶‡•á‡§∂‡§ø‡§ï ‡§∞‡•ã‡§ú‡§ó‡§æ‡§∞‡•Ä</option><option>‡§Æ‡§ú‡§¶‡•Å‡§∞‡•Ä</option>
    </select>
  </div>
  <div class="col-md-6"><label>‡§µ‡§æ‡§∞‡•ç‡§∑‡§ø‡§ï ‡§Ü‡§Æ‡•ç‡§¶‡§æ‡§®‡•Ä</label><input type="number" class="form-control" name="‡§µ‡§æ‡§∞‡•ç‡§∑‡§ø‡§ï ‡§Ü‡§Æ‡•ç‡§¶‡§æ‡§®‡•Ä"></div>
</div>

<!-- ================== 6. NOMINEE ================== -->
<h6 class="text-primary mt-4">‡•¨. ‡§π‡§ï‡§µ‡§æ‡§≤‡§æ‡§ï‡•ã ‡§µ‡§ø‡§µ‡§∞‡§£</h6>
<div class="row mb-3">
  <div class="col-md-4"><label>‡§®‡§æ‡§Æ</label><input class="form-control" name="‡§π‡§ï‡§µ‡§æ‡§≤‡§æ‡§ï‡•ã ‡§®‡§æ‡§Æ"></div>
  <div class="col-md-4"><label>‡§∏‡§Æ‡•ç‡§¨‡§®‡•ç‡§ß</label><input class="form-control" name="‡§π‡§ï‡§µ‡§æ‡§≤‡§æ ‡§∏‡§Ç‡§ó‡§ï‡•ã ‡§∏‡§Æ‡•ç‡§¨‡§®‡•ç‡§ß"></div>
  <div class="col-md-4"><label>‡§π‡§ï %</label><input type="number" class="form-control" name="‡§π‡§ï‡§µ‡§æ‡§≤‡§æ‡§ï‡•ã ‡§π‡§ï %"></div>
</div>

<div class="row mb-3">
  <div class="col-md-4"><label>‡§Æ‡•ã‡§¨‡§æ‡§á‡§≤</label><input class="form-control" name="‡§π‡§ï‡§µ‡§æ‡§≤‡§æ‡§ï‡•ã ‡§Æ‡•ã‡§¨‡§æ‡§á‡§≤ ‡§®‡§Ç."></div>
  <div class="col-md-4"><label>‡§®‡§æ‡§ó‡§∞‡§ø‡§ï‡§§‡§æ ‡§®‡§Ç.</label><input class="form-control" name="‡§π‡§ï‡§µ‡§æ‡§≤‡§æ‡§ï‡•ã ‡§®‡§æ‡§ó‡§∞‡§ø‡§ï‡§§‡§æ ‡§®‡§Ç."></div>
  <div class="col-md-4"> 
    <label>‡§®‡§æ‡§ó‡§∞‡§ø‡§ï‡§§‡§æ ‡§ú‡§æ‡§∞‡•Ä ‡§ú‡§ø‡§≤‡•ç‡§≤‡§æ</label>
    <select id="citizenship_district" name="‡§®‡§æ‡§ó‡§∞‡§ø‡§ï‡§§‡§æ ‡§ú‡§æ‡§∞‡•Ä ‡§ú‡§ø‡§≤‡•ç‡§≤‡§æ" class="form-select"></select>
  </div>
</div>

<!-- ================== 7. DOCUMENTS ================== -->
<h6 class="text-primary mt-4">‡•≠. ‡§´‡•ã‡§ü‡•ã ‡§§‡§•‡§æ ‡§ï‡§æ‡§ó‡§ú‡§æ‡§§</h6>

<div class="row mb-3">
  <div class="col-md-4">
    <label>‡§∏‡§¶‡§∏‡•ç‡§Ø ‡§´‡•ã‡§ü‡•ã</label>
    <input type="file" class="form-control" onchange="handleUpload(this,'member_photo_url')">
  <input type="text" id="member_photo_url_display" class="form-control mt-1" readonly>
<input type="hidden" id="member_photo_url">
  </div>

  <div class="col-md-4">
    <label>‡§®‡§æ‡§ó‡§∞‡§ø‡§ï‡§§‡§æ ‡§Ö‡§ó‡§æ‡§°‡§ø</label>
    <input type="file" class="form-control" onchange="handleUpload(this,'member_citizen_front_url')">
    <input type="text" id="member_citizen_front_url_display" class="form-control mt-1" readonly>
    <input type="hidden"  id="member_citizen_front_url">
  </div>

  <div class="col-md-4">
    <label>‡§®‡§æ‡§ó‡§∞‡§ø‡§ï‡§§‡§æ ‡§™‡§õ‡§æ‡§°‡§ø</label>
    <input type="file" class="form-control" onchange="handleUpload(this,'member_citizen_back_url')">
     <input type="text" id="member_citizen_back_url_display" class="form-control mt-1" readonly>
    <input type="hidden" id="member_citizen_back_url">
  </div>
</div>
  <!-- 8. official use only -->
  <h6 class="text-danger mt-4">7. ‡§ï‡§æ‡§∞‡•ç‡§Ø‡§æ‡§≤‡§Ø‡•Ä‡§Ø ‡§™‡•ç‡§∞‡§Ø‡•ã‡§ó (Office Use Only)</h6>

<div class="row mb-3">
  <div class="col-md-4">
    <label class="form-label">‡§¶‡§∞‡•ç‡§§‡§æ ‡§Æ‡§ø‡§§‡§ø</label>
    <input type="date" class="form-control" name="‡§¶‡§∞‡•ç‡§§‡§æ ‡§Æ‡§ø‡§§‡§ø">
  </div>

  <div class="col-md-4">
    <label class="form-label">‡§∏‡•ç‡§µ‡•Ä‡§ï‡•É‡§§ ‡§∏‡•ç‡§•‡§ø‡§§‡§ø</label>
    <select class="form-select" name="‡§∏‡•ç‡§µ‡•Ä‡§ï‡•É‡§§ ‡§∏‡•ç‡§•‡§ø‡§§‡§ø">
      <option>Pending</option>
      <option>Approved</option>
      <option>Rejected</option>
    </select>
  </div>

  <div class="col-md-4">
    <label class="form-label">Approved By</label>
    <input class="form-control" name="approved_by" placeholder="Chairman / Manager">
  </div>
</div>

<div class="row mb-3">
  <div class="col-md-6">
    <label class="form-label">‡§™‡§¶</label>
    <input class="form-control" name="approved_designation">
  </div>
  <div class="col-md-6">
    <label class="form-label">‡§ï‡•à‡§´‡§ø‡§Ø‡§§</label>
    <input class="form-control" name="remarks">
  </div>
</div>

<!-- ================== SUBMIT ================== -->
<div class="form-check mt-3">
  <input class="form-check-input" type="checkbox" required>
  <label class="form-check-label">‡§Æ ‡§∏‡§π‡§ï‡§æ‡§∞‡•Ä‡§ï‡•ã ‡§®‡§ø‡§Ø‡§Æ ‡§™‡§æ‡§≤‡§®‡§æ ‡§ó‡§∞‡•ç‡§® ‡§∏‡§π‡§Æ‡§§ ‡§õ‡•Å</label>
</div>

<div class="text-center mt-4">
  <button class="btn btn-success px-5">‡§¶‡§∞‡•ç‡§§‡§æ ‡§ó‡§∞‡•ç‡§®‡•Å‡§π‡•ã‡§∏‡•ç</button>
</div>

</form>
    </div>

    <!-- ===== TRANSACTION SECTION ===== -->
    <div id="transactionSection" style="display:none">
       

  <h5 class="text-primary mt-4">üí∞ Member Transaction</h5>

  <div class="row mb-3">
  <div class="col-md-4">
    <label>‡§∏‡§¶‡§∏‡•ç‡§Ø (‡§ñ‡§æ‡§§‡§æ ‡§®‡§Ç.)</label>
    <select id="tx_member" class="form-select"
            onchange="loadBalance()"></select>
  </div>

  <div class="col-md-4">
    <label>Current Balance</label>
    <input id="tx_balance" class="form-control" readonly>
  </div>
</div>


    <div class="col-md-4">
      <label>Transaction Type</label>
      <select id="tx_type" class="form-select" onchange="toggleTransfer()">
        <option value="">‡§õ‡§æ‡§®‡•ç‡§®‡•Å‡§π‡•ã‡§∏‡•ç</option>
        <option value="Saving">Saving</option>
        <option value="Withdraw">Withdraw</option>
        <option value="Transfer">Member Transfer</option>
        <option value="Loan">Loan</option>
        <option value="EMI">EMI</option>
      </select>
    </div>

    <div class="col-md-4">
      <label>Amount</label>
      <input type="number" id="tx_amount" class="form-control">
    </div>
  </div>

  <div class="row mb-3" id="transfer_box" style="display:none">
    <div class="col-md-4">
      <label>To Member</label>
      <select id="tx_to_member" class="form-select"></select>
    </div>
  </div>

  <div class="row mb-3">
    <div class="col-md-6">
      <label>Remarks</label>
      <input id="tx_remark" class="form-control">
    </div>
  </div>

  <button class="btn btn-success" onclick="submitTransaction()">
    üíæ Save Transaction
  </button>
   
    </div>

<script>
let navOpen = true;

function toggleTransfer(){
  const type = document.getElementById("tx_type").value;
  document.getElementById("transfer_box").style.display =
    type === "Transfer" ? "block" : "none";
}


function toggleNav(){
  const nav = document.getElementById("sideNav");
  if(navOpen){
    nav.style.width = "0";
    nav.style.padding = "0";
    nav.style.overflow = "hidden";
  }else{
    nav.style.width = "240px";
    nav.style.padding = "1rem";
  }
  navOpen = !navOpen;
}

function showSection(id, el){
  document.getElementById("memberSection").style.display = "none";
  document.getElementById("transactionSection").style.display = "none";
  document.getElementById(id).style.display = "block";

  document.querySelectorAll(".nav-link").forEach(a=>a.classList.remove("active"));
  el.classList.add("active");
}
</script>
<!-- ================== JS ================== -->
<script>
const IMGBB_KEY = "f5d95811959fdcd59c8ea459aadb650b";
let addressData = {};

fetch("nepal-admin-structure.json")
.then(r => r.json())
.then(d => {
  addressData = d;

  // Province load
  province.innerHTML = '<option value="">‡§™‡•ç‡§∞‡§¶‡•á‡§∂ ‡§õ‡§æ‡§®‡•ç‡§®‡•Å‡§π‡•ã‡§∏‡•ç</option>';
  for (let p in d) {
    province.innerHTML += `<option value="${p}">${p}</option>`;
  }

  // Citizenship district (ALL)
  citizenship_district.innerHTML = '<option value="">‡§ú‡§ø‡§≤‡•ç‡§≤‡§æ ‡§õ‡§æ‡§®‡•ç‡§®‡•Å‡§π‡•ã‡§∏‡•ç</option>';
  for (let p in d) {
    for (let dist in d[p]) {
      citizenship_district.innerHTML += `<option value="${dist}">${dist}</option>`;
    }
  }
});

// Province ‚Üí District
province.onchange = () => {
  district.innerHTML = '<option value="">‡§ú‡§ø‡§≤‡•ç‡§≤‡§æ ‡§õ‡§æ‡§®‡•ç‡§®‡•Å‡§π‡•ã‡§∏‡•ç</option>';
  municipality.innerHTML = '<option value="">‡§™‡§æ‡§≤‡§ø‡§ï‡§æ ‡§õ‡§æ‡§®‡•ç‡§®‡•Å‡§π‡•ã‡§∏‡•ç</option>';

  if (!province.value) return;

  for (let dist in addressData[province.value]) {
    district.innerHTML += `<option value="${dist}">${dist}</option>`;
  }
};

// District ‚Üí Municipality
district.onchange = () => {
  municipality.innerHTML = '<option value="">‡§™‡§æ‡§≤‡§ø‡§ï‡§æ ‡§õ‡§æ‡§®‡•ç‡§®‡•Å‡§π‡•ã‡§∏‡•ç</option>';

  if (!district.value) return;

  addressData[province.value][district.value].forEach(m => {
    municipality.innerHTML += `<option value="${m}">${m}</option>`;
  });
};
  
async function handleUpload(input, targetId) {

  if (!member_id.value) {
    alert("‡§™‡§π‡§ø‡§≤‡§æ ‡§ñ‡§æ‡§§‡§æ ‡§®‡§Ç. ‡§≤‡•á‡§ñ‡•ç‡§®‡•Å‡§π‡•ã‡§∏‡•ç");
    input.value = "";
    return;
  }

  const file = input.files[0];
  if (!file) return;

  const ext = file.name.split('.').pop(); // jpg / png

  const fd = new FormData();
  fd.append("key", IMGBB_KEY);
  fd.append("image", file);

  const r = await fetch("https://api.imgbb.com/1/upload", {
    method: "POST",
    body: fd
  });

  const j = await r.json();
  if (!j.success) {
    alert("Upload failed");
    return;
  }

  // üî• ORIGINAL imgbb url
  const originalUrl = j.data.url;  
  // example: https://i.ibb.co/jPBZdddZ/abcxyz.jpg

  // üî• base folder extract
  const base = originalUrl.substring(0, originalUrl.lastIndexOf('/') + 1);

  // üî• custom filename
  const customFile =
    member_id.value + "-" +
    targetId.replace("_url", "").replaceAll("_", "-") +
    "." + ext;

  const finalUrl = base + customFile;

  // save custom url
  document.getElementById(targetId).value = finalUrl;

  const display = document.getElementById(targetId + "_display");
  if (display) display.value = finalUrl;

  console.log("ORIGINAL:", originalUrl);
  console.log("CUSTOM:", finalUrl);
}


</script>
<script>
const SCRIPT_URL = "https://script.google.com/macros/s/AKfycby7gnr17K9vGvI2Ac-N72c761ikM_7KkxqQkDDOpywkDquEAlc5bL_TVsIkXPUJJg-Xyw/exec";

document.getElementById("memberForm").addEventListener("submit", async e => {
  e.preventDefault();

  const form = e.target;
  const data = {};

  [...form.elements].forEach(el => {
    if (el.name) data[el.name] = el.value;
  });

  // hidden image urls
  data.member_photo_url = document.getElementById("member_photo_url").value;
  data.member_citizen_front_url = document.getElementById("member_citizen_front_url").value;
  data.member_citizen_back_url = document.getElementById("member_citizen_back_url").value;

  const res = await fetch(SCRIPT_URL, {
    method: "POST",
    body: JSON.stringify(data)
  });

  const j = await res.json();

  if (j.status === "success") {
    alert("‚úÖ ‡§∏‡§¶‡§∏‡•ç‡§Ø ‡§¶‡§∞‡•ç‡§§‡§æ ‡§∏‡§´‡§≤ ‡§≠‡§Ø‡•ã");
    form.reset();
  } else {
    alert("‚ùå Error ‡§≠‡§Ø‡•ã");
  }
});
</script>
  <script>
async function searchMember(){
  if(!member_id.value) return alert("‡§ñ‡§æ‡§§‡§æ ‡§®‡§Ç. ‡§≤‡•á‡§ñ‡•ç‡§®‡•Å‡§π‡•ã‡§∏‡•ç");

  const r = await fetch(SCRIPT_URL,{
    method:"POST",
    body:JSON.stringify({
      action:"search",
      "‡§ñ‡§æ‡§§‡§æ ‡§®‡§Ç.":member_id.value
    })
  });
  const j = await r.json();

  if(j.status!=="found") return alert("Member not found");

  for(let k in j.data){
    const el = document.querySelector(`[name="${k}"]`);
    if(el) el.value = j.data[k];
  }

  // image urls
  member_photo_url.value = j.data.member_photo_url || "";
  member_photo_url_display.value = j.data.member_photo_url || "";
  member_citizen_front_url.value = j.data.member_citizen_front_url || "";
  member_citizen_front_url_display.value = j.data.member_citizen_front_url || "";
  member_citizen_back_url.value = j.data.member_citizen_back_url || "";
  member_citizen_back_url_display.value = j.data.member_citizen_back_url || "";
}

async function updateMember(){
  const data = collectForm();
  data.action = "update";

  const r = await fetch(SCRIPT_URL,{
    method:"POST",
    body:JSON.stringify(data)
  });
  const j = await r.json();

  alert(j.status==="updated" ? "‚úÖ Update ‡§≠‡§Ø‡•ã" : "‚ùå Update failed");
  document.getElementById("memberForm").reset();
}

async function deleteMember(){

  const id = document.getElementById("member_id").value;

  if (!id) {
    alert("‡§™‡§π‡§ø‡§≤‡§æ ‡§ñ‡§æ‡§§‡§æ ‡§®‡§Ç. ‡§≤‡•á‡§ñ‡•ç‡§®‡•Å‡§π‡•ã‡§∏‡•ç");
    return;
  }

  if (!confirm("‡§Ø‡•ã ‡§∏‡§¶‡§∏‡•ç‡§Ø delete ‡§ó‡§∞‡•ç‡§® ‡§™‡§ï‡•ç‡§ï‡§æ ‡§π‡•ã?")) return;

  const res = await fetch(SCRIPT_URL, {
    method: "POST",
    body: JSON.stringify({
      action: "delete",
      "‡§ñ‡§æ‡§§‡§æ ‡§®‡§Ç.": id
    })
  });

  const j = await res.json();

  if (j.status === "deleted") {
    alert("üóëÔ∏è ‡§∏‡§¶‡§∏‡•ç‡§Ø delete ‡§≠‡§Ø‡•ã");
    document.getElementById("memberForm").reset();
  } 
  else if (j.status === "notfound") {
    alert("‚ùå ‡§ñ‡§æ‡§§‡§æ ‡§®‡§Ç. ‡§≠‡•á‡§ü‡§ø‡§è‡§®");
  } 
  else {
    alert("‚ùå Delete failed");
  }
}


function collectForm(){
  const data = {};
  [...memberForm.elements].forEach(el=>{
    if(el.name) data[el.name]=el.value;
  });
  data.member_photo_url = member_photo_url.value;
  data.member_citizen_front_url = member_citizen_front_url.value;
  data.member_citizen_back_url = member_citizen_back_url.value;
  return data;
}

    async function uploadImgBB(file){
  const fd = new FormData();
  fd.append("image", file);

  const r = await fetch(
    "https://api.imgbb.com/1/upload?key=IMGBB_API_KEY",
    { method:"POST", body: fd }
  );

  const j = await r.json();
  if (!j.success) throw "Upload failed";

  return {
    url: j.data.url,
    delete_url: j.data.delete_url
  };
}
async function updatePhoto(){
  const file = member_photo.files[0];
  if(!file) return alert("Photo ‡§õ‡§æ‡§®");

  const img = await uploadImgBB(file);

  await fetch(SCRIPT_URL,{
    method:"POST",
    body:JSON.stringify({
      action:"update",
      "‡§ñ‡§æ‡§§‡§æ ‡§®‡§Ç.": member_id.value,
      member_photo_url: img.url,
      member_photo_delete_url: img.delete_url
    })
  });

  alert("‚úÖ Photo updated & old deleted");
}

    
async function loadBalance(){

  const id = tx_member.value;
  if(!id){
    tx_balance.value = "";
    return;
  }

  const r = await fetch(
    SCRIPT_URL + "?action=balance&member_id=" + id
  );

  const j = await r.json();

  tx_balance.value =
    j.status==="success" ? j.balance : "0";
}


</script>
  <script>
document.addEventListener("DOMContentLoaded", loadMembers);

async function loadMembers(){

  const res = await fetch(SCRIPT_URL + "?action=members");
  const json = await res.json();

  const sel1 = document.getElementById("tx_member");
  const sel2 = document.getElementById("tx_to_member");

  sel1.innerHTML = `<option value="">-- ‡§∏‡§¶‡§∏‡•ç‡§Ø ‡§õ‡§æ‡§®‡•ç‡§®‡•Å‡§π‡•ã‡§∏‡•ç --</option>`;
  sel2.innerHTML = `<option value="">-- ‡§∏‡§¶‡§∏‡•ç‡§Ø ‡§õ‡§æ‡§®‡•ç‡§®‡•Å‡§π‡•ã‡§∏‡•ç --</option>`;

  json.data.forEach(m => {
    const opt1 = document.createElement("option");
    opt1.value = m.id;
    opt1.textContent = m.id + " - " + m.name;
    sel1.appendChild(opt1);

    const opt2 = document.createElement("option");
    opt2.value = m.id;
    opt2.textContent = m.id + " - " + m.name;
    sel2.appendChild(opt2);
  });
}
</script>
  <script>
async function submitTransaction(){

  if(!tx_member.value || !tx_type.value || !tx_amount.value){
    alert("‚ùó ‡§∏‡§¨‡•à field ‡§≠‡§∞‡•ç‡§®‡•Å‡§π‡•ã‡§∏‡•ç");
    return;
  }

  try{
    const res = await fetch(SCRIPT_URL, {
      method: "POST",
      headers:{
        "Content-Type":"application/json"
      },
      body: JSON.stringify({
        action: "transaction",
        member_id: tx_member.value,
        type: tx_type.value,
        amount: Number(tx_amount.value),
        to_member: tx_to_member.value || "",
        remark: tx_remark.value || ""
      })
    });

    const json = await res.json();

    if(json.status === "success"){
      alert("‚úÖ Transaction save ‡§≠‡§Ø‡•ã");

      tx_amount.value = "";
      tx_remark.value = "";
      tx_type.value = "";
      tx_to_member.value = "";
      transfer_box.style.display = "none";

      loadBalance(); // refresh balance
    }else{
      alert("‚ùå Failed : " + JSON.stringify(json));
    }

  }catch(err){
    console.error(err);
    alert("‚ùå Network / Script Error");
  }
}
</script>

</body>
</html>
