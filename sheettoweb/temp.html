<!DOCTYPE html>
<html>
<head>
<title>Dynamic Member Management</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <style>
  .table-wrapper {
  overflow-x:auto;
  max-width:100%;
}
table {
  table-layout: fixed;
  width:100%;
}
th, td {
  word-wrap: break-word;
  vertical-align:middle;
  text-align:center;
  min-width:80px;
}
.thumb {
  width:50px;
  height:50px;
  object-fit:cover;
  border-radius:5px;
}
</style>
<style>
  .thumb{width:50px;height:50px;object-fit:cover;border-radius:5px;}
  .hidden{display:none;}
  table{table-layout:fixed;width:100%;}
  th, td{word-wrap:break-word;vertical-align:middle;text-align:center; min-width:80px;}
  .table-wrapper{overflow-x:auto; max-width:100%;}
</style>
</head>
<body class="p-3">

<!-- LOGIN -->
<div id="loginBox" class="container col-md-4">
<h4>ğŸ” Login</h4>
<input id="user" class="form-control mb-2" placeholder="Username">
<input id="pass" type="password" class="form-control mb-2" placeholder="Password">
<button class="btn btn-primary w-100" onclick="login()">Login</button>
</div>

<!-- APP -->
<div id="app" class="hidden">

<h3>ğŸ“Š Dashboard</h3>
<div class="row mb-3">
<div class="col"><div class="card p-2">ğŸ‘¥ Total: <b id="d_total"></b></div></div>
<div class="col"><div class="card p-2">âœ… Active: <b id="d_active"></b></div></div>
<div class="col"><div class="card p-2">âŒ Inactive: <b id="d_inactive"></b></div></div>
</div>

<input id="search" class="form-control mb-2" placeholder="Search">

<button id="addBtn" class="btn btn-success mb-2" onclick="openAdd()">+ Add Member</button>

<div class="table-wrapper">
  <table class="table table-bordered table-sm">
    <thead id="thead" class="table-dark"></thead>
    <tbody id="tbody"></tbody>
  </table>
</div>
</div>

<!-- MODAL -->
<div class="modal fade" id="memberModal">
<div class="modal-dialog modal-xl">
<div class="modal-content">
<div class="modal-header">
<h5 id="modalTitle"></h5>
<button class="btn-close" data-bs-dismiss="modal"></button>
</div>
<div class="modal-body row g-2" id="formBody"></div>
<div class="modal-footer">
<button id="saveBtn" class="btn btn-success" onclick="save()">Save</button>
<button id="delBtn" class="btn btn-danger" onclick="del()">Delete</button>
</div>
</div>
</div>
</div>

<script>
const API_URL="https://script.google.com/macros/s/AKfycbwz9PVIuMyFmRHj975MRCtS-yNJkgkRFO3RJ32PGCqohw5eCcGdpcpEv5Mph1a-iE1oCQ/exec";
const IMGBB_KEY="f5d95811959fdcd59c8ea459aadb650b";

let role="", headers=[], members=[], edit=false;
const modal = new bootstrap.Modal(memberModal);

/* ================= LOGIN ================= */
function login(){
fetch(API_URL,{method:"POST",body:JSON.stringify({
action:"login",user:user.value,pass:pass.value
})}).then(r=>r.json()).then(d=>{
if(!d.ok)return alert("Login failed");
role=d.role;
loginBox.classList.add("hidden");
app.classList.remove("hidden");
if(role!=="admin"){
addBtn.style.display="none";
saveBtn.style.display="none";
delBtn.style.display="none";
}
loadMembers();
});
}

/* ================= LOAD MEMBERS ================= */
function loadMembers(){
fetch(API_URL).then(r=>r.json()).then(d=>{
if(d.length===0) return;
members=d;
headers=Object.keys(d[0]); // dynamic headers
buildTable();
draw();
buildForm();
dashboard();
});
}

/* ================= DASHBOARD ================= */
function dashboard(){
d_total.innerText=members.length;
d_active.innerText=members.filter(m=>m.Status=="Active").length;
d_inactive.innerText=members.filter(m=>m.Status=="Inactive").length;
}

/* ================= TABLE ================= */
function buildTable(){
thead.innerHTML = "";
headers.forEach(h => thead.innerHTML += `<th>${h}</th>`);
thead.innerHTML += `<th>Action</th>`;
}

function draw(){
  tbody.innerHTML="";
  members.forEach(m=>{
    let tr=document.createElement("tr");

    headers.forEach(h=>{
      let td=document.createElement("td");
      let v = m[h] || "";

      if(h.toLowerCase().includes("photo") && v){
        let img = document.createElement("img");
        img.src = v;
        img.className = "thumb";
        // force table redraw when image loads
        img.onload = ()=>{ tbody.style.display='table'; };
        td.appendChild(img);
      } else td.innerText = v;

      tr.appendChild(td);
    });

    // Action column
    let tdAction=document.createElement("td");
    if(role==="admin"){
      let editBtn=document.createElement("button");
      editBtn.className="btn btn-sm btn-warning me-1";
      editBtn.innerText="Edit";
      editBtn.onclick = ()=> editM(m);
      tdAction.appendChild(editBtn);

      let delBtn=document.createElement("button");
      delBtn.className="btn btn-sm btn-danger";
      delBtn.innerText="Del";
      delBtn.onclick = ()=> deleteM(m[headers[0]]);
      tdAction.appendChild(delBtn);
    }
    tr.appendChild(tdAction);

    tbody.appendChild(tr);
  });
}


/* ================= FORM ================= */
function buildForm(){
formBody.innerHTML="";
headers.forEach(h=>{
formBody.innerHTML+=`
<div class="col-6">
<label>${h}</label>
<input class="form-control" id="f_${h}" placeholder="${h}">
${h.toLowerCase().includes("photo")?`<input type="file" class="form-control mt-1" onchange="uploadImage(this,'${h}')"><img id="p_${h}" class="thumb hidden mt-1">`:""}
</div>`;
});
}

/* ================= MODAL ================= */
function openAdd(){
edit=false;
modalTitle.innerText="Add Member";
headers.forEach(h=>{
document.getElementById("f_"+h).value="";
let p = document.getElementById("p_"+h);
if(p) p.classList.add("hidden");
});
modal.show();
}

function editM(m){
edit=true;
modalTitle.innerText="Edit Member";
headers.forEach(h=>{
if(document.getElementById("f_"+h)) document.getElementById("f_"+h).value=m[h]||"";
let p=document.getElementById("p_"+h);
if(p && m[h] && h.toLowerCase().includes("photo")){
p.src=m[h]; p.classList.remove("hidden");
}
});
modal.show();
}

/* ================= SAVE ================= */
function save(){
let data={action:edit?"update":"add"};
headers.forEach(h=>data[h]=document.getElementById("f_"+h).value);
fetch(API_URL,{method:"POST",body:JSON.stringify(data)})
.then(()=>{modal.hide();loadMembers();});
}

/* ================= DELETE ================= */
function deleteM(id){
if(!confirm("Delete member?")) return;
fetch(API_URL,{method:"POST",body:JSON.stringify({action:"delete",MemberID:id})})
.then(()=>{loadMembers();});
}

/* ================= IMG UPLOAD ================= */
function uploadImage(input,field){
if(!input.files.length) return;
const fd=new FormData();
fd.append("image",input.files[0]);
fd.append("name",field+"_"+Date.now());
fetch(`https://api.imgbb.com/1/upload?key=${IMGBB_KEY}`,{method:"POST",body:fd})
.then(r=>r.json()).then(d=>{
if(d.success){
document.getElementById("f_"+field).value=d.data.url;
let img=document.getElementById("p_"+field);
img.src=d.data.url;
img.classList.remove("hidden");
}else alert("Image upload failed");
});
}
</script>
</body>
</html>
