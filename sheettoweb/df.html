<!DOCTYPE html>
<html>
<head>
<title>Member Management</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

<style>
.hidden{display:none}
.table-wrapper{overflow-x:auto}
table{width:100%;table-layout:fixed}
th,td{padding:6px;font-size:14px;text-align:center;vertical-align:middle}
th,td{min-width:120px}
.photo-col{width:90px}
.action-col{width:150px}
.thumb{width:50px;height:50px;object-fit:cover;border-radius:6px}
</style>
</head>

<body class="p-3">

<!-- LOGIN -->
<div id="loginBox" class="col-md-4 mx-auto">
<h4>ğŸ” Login</h4>
<input id="user" class="form-control mb-2" placeholder="Username">
<input id="pass" type="password" class="form-control mb-2" placeholder="Password">
<button class="btn btn-primary w-100" onclick="login()">Login</button>
</div>

<!-- APP -->
<div id="app" class="hidden">

<h4 class="mb-3">ğŸ“Š Dashboard</h4>
<div class="row mb-3">
<div class="col">ğŸ‘¥ Total: <b id="d_total"></b></div>
<div class="col">âœ… Active: <b id="d_active"></b></div>
<div class="col">âŒ Inactive: <b id="d_inactive"></b></div>
</div>

<button class="btn btn-success mb-2" onclick="openAdd()">+ Add Member</button>

<div class="table-wrapper">
<table class="table table-bordered table-sm">
<thead class="table-dark"><tr id="thead"></tr></thead>
<tbody id="tbody"></tbody>
</table>
</div>
</div>

<!-- MODAL -->
<div class="modal fade" id="memberModal">
<div class="modal-dialog modal-xl">
<div class="modal-content">
<div class="modal-header">
<h5 id="modalTitle"></h5>
<button class="btn-close" data-bs-dismiss="modal"></button>
</div>
<div class="modal-body row g-2" id="formBody"></div>
<div class="modal-footer">
<button class="btn btn-success" onclick="save()">Save</button>
</div>
</div>
</div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<script>
const API = "https://script.google.com/macros/s/AKfycbydwJCKdsdPZuMKJj-IhFOjkgGJh9pX5PKUYwtgV1c6QLuO6cAjAXaiEciFzMQQ6WsKIQ/exec";
const IMGBB = "f5d95811959fdcd59c8ea459aadb650b";

let headers=[], members=[], role="", edit=false;
const modal = new bootstrap.Modal(memberModal);

/* LOGIN */
function login(){
  fetch(API,{
    method:"POST",
    body: JSON.stringify({
      action:"login",
      user: user.value,
      pass: pass.value
    })
  })
  .then(r=>r.json())
  .then(d=>{
    console.log("LOGIN RESPONSE:", d);
    if(!d.ok) return alert("âŒ Login Failed");
    role=d.role;
    loginBox.classList.add("hidden");
    app.classList.remove("hidden");
    load();
  })
  .catch(err=>{
    console.error(err);
    alert("API error");
  });
}


/* LOAD */
function load(){
fetch(API).then(r=>r.json()).then(d=>{
 members=d;
 headers=Object.keys(d[0]);
 buildTable(); draw(); buildForm(); dash();
});
}

/* DASH */
function dash(){
 d_total.innerText=members.length;
 d_active.innerText=members.filter(x=>x.Status=="Active").length;
 d_inactive.innerText=members.filter(x=>x.Status=="Inactive").length;
}

/* TABLE */
function buildTable(){
 thead.innerHTML="";
 headers.forEach(h=>{
  let cls=h.toLowerCase().includes("photo")?"photo-col":"";
  thead.innerHTML+=`<th class="${cls}">${h}</th>`;
 });
 thead.innerHTML+=`<th class="action-col">Action</th>`;
}

function draw(){
 tbody.innerHTML="";
 members.forEach(m=>{
  let tr="<tr>";
  headers.forEach(h=>{
   if(h.toLowerCase().includes("photo"))
    tr+=`<td>${m[h]?`<img src="${m[h]}" class="thumb">`:""}</td>`;
   else tr+=`<td>${m[h]||""}</td>`;
  });
  tr+=`<td>
  <button class="btn btn-sm btn-warning me-1" onclick='editM(${JSON.stringify(m)})'>Edit</button>
  <button class="btn btn-sm btn-danger" onclick='del("${m.MemberID}")'>Delete</button>
  </td></tr>`;
  tbody.innerHTML+=tr;
 });
}

/* FORM */
function buildForm(){
 formBody.innerHTML="";
 headers.forEach(h=>{
  formBody.innerHTML+=`
  <div class="col-6">
   <label>${h}</label>
   <input id="f_${h}" class="form-control">
   ${h.toLowerCase().includes("photo")?
   `<input type="file" class="form-control mt-1" onchange="upload(this,'${h}')">`:""}
  </div>`;
 });
}

/* ADD / EDIT */
function openAdd(){ edit=false; modalTitle.innerText="Add Member"; modal.show(); }
function editM(m){
 edit=true; modalTitle.innerText="Edit Member";
 headers.forEach(h=>f(h).value=m[h]||"");
 modal.show();
}

/* SAVE */
function save(){
 let d={action:edit?"update":"add"};
 headers.forEach(h=>d[h]=f(h).value);
 fetch(API,{
  method:"POST",
  headers:{ "Content-Type":"application/json" },
  body:JSON.stringify(d)
 }).then(()=>{ modal.hide(); load(); });
}

/* DELETE */
function del(id){
 if(!confirm("Delete this member?")) return;
 fetch(API,{
  method:"POST",
  headers:{ "Content-Type":"application/json" },
  body:JSON.stringify({action:"delete",MemberID:id})
 }).then(()=>load());
}

/* IMAGE */
function upload(i,fld){
 let fd=new FormData();
 fd.append("image",i.files[0]);
 fetch(`https://api.imgbb.com/1/upload?key=${IMGBB}`,{method:"POST",body:fd})
 .then(r=>r.json()).then(d=>f(fld).value=d.data.url);
}
const f=h=>document.getElementById("f_"+h);
</script>
</body>
</html>
