<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Loan Workflow</title>
<style>
body{font-family:Arial;background:#0f172a;color:#fff;text-align:center}
input,button,select{padding:8px;margin:5px}
table{margin:auto;border-collapse:collapse}
td,th{border:1px solid #fff;padding:6px}
button{background:#22c55e;border:none}
</style>
</head>
<body>

<h2>Login</h2>
Code <input id="code">
<button onclick="login()">Login</button>

<div id="staff" style="display:none">
<h2>Staff Loan Request</h2>
MemberID <input id="m"><br>
Amount <input id="a"><br>
Months <input id="mo"><br>
Interest <input id="i"><br>
<button onclick="requestLoan()">Send</button>
</div>

<div id="manager" style="display:none">
<h2>Manager Approval</h2>
<button onclick="loadPending()">Load</button>
<table id="tbl"></table>
</div>

<div id="admin" style="display:none">
<h2>Admin Final Approve</h2>
<button onclick="loadManagerApproved()">Load</button>
<table id="tbl2"></table>
</div>

<script>
const URL="https://script.google.com/macros/s/AKfycbxWpUAJ2p9h3mJr36tAamYo0n3dlC1ke8ps40d7w2_jnVCkqvXt9JK1FROGPPwSVuCJ9g/exec";
let user={};

function login(){
fetch(URL,{method:"POST",body:JSON.stringify({
action:"login",code:code.value
})}).then(r=>r.json()).then(u=>{
if(!u.status)return alert("Wrong Code");
user=u;

if(u.role=="Staff") staff.style.display="block";
if(u.role=="Manager") manager.style.display="block";
if(u.role=="Admin"){
staff.style.display="block";
manager.style.display="block";
admin.style.display="block";
}
});
}

function requestLoan(){
fetch(URL,{method:"POST",body:JSON.stringify({
action:"addLoanRequest",
MemberID:m.value,
Amount:a.value,
Months:mo.value,
Interest:i.value,
StaffCode:user.code,
BranchCode:user.branch
})}).then(()=>alert("Request Sent"));
}

function loadPending(){
fetch(URL,{method:"POST",body:JSON.stringify({
action:"getPending",branch:user.branch
})}).then(r=>r.json()).then(list=>{
let h="<tr><th>ID</th><th>Member</th><th>Amt</th><th>Action</th></tr>";
list.forEach(x=>{
h+=`<tr>
<td>${x.RequestID}</td>
<td>${x.MemberID}</td>
<td>${x.Amount}</td>
<td>
<button onclick="managerAction('${x.RequestID}',true)">Approve</button>
<button onclick="managerAction('${x.RequestID}',false)">Reject</button>
</td></tr>`;
});
tbl.innerHTML=h;
});
}

function managerAction(id,a){
fetch(URL,{method:"POST",body:JSON.stringify({
action:"managerAction",
RequestID:id,
approve:a
})}).then(()=>loadPending());
}

function loadManagerApproved(){
fetch(URL,{method:"POST",body:JSON.stringify({
action:"getManagerApproved"
})}).then(r=>r.json()).then(list=>{
let h="<tr><th>ID</th><th>Member</th><th>Amt</th><th>Final</th></tr>";
list.forEach(x=>{
h+=`<tr>
<td>${x.RequestID}</td>
<td>${x.MemberID}</td>
<td>${x.Amount}</td>
<td>
<button onclick="adminApprove('${x.RequestID}')">Approve</button>
</td></tr>`;
});
tbl2.innerHTML=h;
});
}

function adminApprove(id){
fetch(URL,{method:"POST",body:JSON.stringify({
action:"adminApprove",
RequestID:id
})}).then(()=>alert("Loan Added"));
}
</script>
</body>
</html>
