<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Loan Workflow</title>
<style>
body{font-family:Arial;background:#0f172a;color:#fff}
.tabs{display:flex;justify-content:center;margin:20px 0}
.tabs button{padding:10px 20px;margin:0 5px;background:#1e293b;color:#fff;border:none;cursor:pointer}
.tabs button.active{background:#22c55e;color:#000}
.tabcontent{display:none;padding:10px}
input,button,select{padding:8px;margin:5px}
table{margin:auto;border-collapse:collapse;width:90%}
td,th{border:1px solid #fff;padding:6px;text-align:center}
button.action{background:#22c55e;border:none;padding:5px 10px;margin:2px;cursor:pointer}
</style>
</head>
<body>

<h2 style="text-align:center">Loan Workflow</h2>

<!-- Tabs -->
<div class="tabs">
  <button class="tablinks active" onclick="openTab('loginTab', this)">Login</button>
  <button class="tablinks" id="staffTabBtn" onclick="openTab('staffTab', this)" style="display:none">Staff</button>
  <button class="tablinks" id="managerTabBtn" onclick="openTab('managerTab', this)" style="display:none">Manager</button>
  <button class="tablinks" id="adminTabBtn" onclick="openTab('adminTab', this)" style="display:none">Admin</button>
</div>

<!-- Login -->
<div id="loginTab" class="tabcontent" style="display:block;text-align:center">
  Code: <input id="code"><button onclick="login()">Login</button>
</div>

<!-- Staff -->
<div id="staffTab" class="tabcontent">
  <h3>Staff Loan Request</h3>
  <form id="requests">
    MemberID <input id="m"><br>
    Amount <input id="a"><br>
    Months <input id="mo"><br>
    Interest <input id="i"><br>
    <button type="button" onclick="requestLoan()">Send</button>
  </form>
  <h3>My Requests</h3>
  <button onclick="loadMyRequests()">Load</button>
  <table id="staffTbl"></table>
</div>

<!-- Manager -->
<div id="managerTab" class="tabcontent">
  <h3>Manager Approval</h3>
  <button onclick="loadPending()">Load Pending</button>
  <table id="tbl"></table>
</div>

<!-- Admin -->
<div id="adminTab" class="tabcontent">
  <h3>Admin Final Approve</h3>
  <button onclick="loadManagerApproved()">Load</button>
  <table id="tbl2"></table>
</div>

<script>
let user={};

// ---------------- Tab Switching ----------------
function openTab(tabName, el){
  document.querySelectorAll(".tabcontent").forEach(tab=>tab.style.display="none");
  document.querySelectorAll(".tablinks").forEach(btn=>btn.classList.remove("active"));
  document.getElementById(tabName).style.display="block";
  el.classList.add("active");
}

// ---------------- Web App URL ----------------
const URL="https://script.google.com/macros/s/AKfycbz4WNka9rROUiY21TNZfaQpe_jAep_Hqe_DWT-nTJzUPNDzkTvWs9Cu5p1Ur90kGgY7VQ/exec"; // replace with your deployed Apps Script URL

// ---------------- LOGIN ----------------
function login(){
  const codeVal = document.getElementById("code").value.trim();
  
  fetch(URL, {
    method: "POST",
    body: JSON.stringify({action:"login", code: codeVal})
  })
  .then(r => r.json())
  .then(u => {
    if(!u.status){
      alert("Wrong Code or User not found");
      return;
    }
    user = u;
    console.log("Login success:", u);
    
    if(u.role=="Staff"){
      document.getElementById("staffTabBtn").style.display="inline-block";
      openTab('staffTab', document.getElementById("staffTabBtn"));
      loadMyRequests();
    }
    if(u.role=="Manager"){
      document.getElementById("managerTabBtn").style.display="inline-block";
      openTab('managerTab', document.getElementById("managerTabBtn"));
      loadPending();
    }
    if(u.role=="Admin"){
      document.getElementById("staffTabBtn").style.display="inline-block";
      document.getElementById("managerTabBtn").style.display="inline-block";
      document.getElementById("adminTabBtn").style.display="inline-block";
      openTab('adminTab', document.getElementById("adminTabBtn"));
      loadMyRequests();
      loadPending();
      loadManagerApproved();
    }
  });
}


// ---------------- STAFF REQUEST ----------------
function requestLoan(){
  fetch(URL,{
    method:"POST",
    body:JSON.stringify({
      action:"addLoanRequest",
      MemberID:m.value,
      Amount:a.value,
      Months:mo.value,
      Interest:i.value,
      BranchCode:user.branch,
      StaffCode:user.code
    })
  }).then(r=>r.json())
  .then(res=>{
    if(res.s
