<!-- ================= FULL ONE FILE SYSTEM ================= -->
<!-- GOOGLE APPS SCRIPT + HTML UI FOR LOAN REQUEST WORKFLOW -->

<!-- ================== HTML UI ================== -->
<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Loan Request System</title>
<style>
body{font-family:Arial;background:#0f172a;color:#fff;text-align:center}
input,button,select{padding:8px;margin:5px}
table{margin:auto;border-collapse:collapse}
th,td{border:1px solid #fff;padding:6px}
button{background:#22c55e;border:none}
</style>
</head>
<body>

<h2>Loan Request</h2>

MemberID <input id="member"><br>
Amount <input id="amount"><br>
Months <input id="months"><br>
Interest % <input id="interest"><br>
<button onclick="sendRequest()">Send Request</button>

<h2>Manager Panel</h2>
<button onclick="loadPending()">Load Pending</button>
<table id="tbl"></table>

<script>
const URL="YOUR_SCRIPT_URL";

function sendRequest(){
fetch(URL,{method:"POST",body:JSON.stringify({
 action:"addLoanRequest",
 MemberID:member.value,
 Amount:amount.value,
 Months:months.value,
 Interest:interest.value,
 RequestedBy:"Staff"
})}).then(r=>r.json()).then(a=>alert("Request Sent"));
}

function loadPending(){
fetch(URL,{method:"POST",body:JSON.stringify({action:"getPending"})})
.then(r=>r.json())
.then(list=>{
 let h="<tr><th>ID</th><th>Member</th><th>Amt</th><th>Action</th></tr>";
 list.forEach(x=>{
  h+=`<tr>
<td>${x.RequestID}</td>
<td>${x.MemberID}</td>
<td>${x.Amount}</td>
<td>
<button onclick="approve('${x.RequestID}')">Approve</button>
<button onclick="reject('${x.RequestID}')">Reject</button>
</td></tr>`;
 });
 tbl.innerHTML=h;
});
}

function approve(id){
fetch(URL,{method:"POST",body:JSON.stringify({
 action:"managerAction",
 RequestID:id,
 approve:true
})}).then(()=>loadPending());
}

function reject(id){
fetch(URL,{method:"POST",body:JSON.stringify({
 action:"managerAction",
 RequestID:id,
 approve:false
})}).then(()=>loadPending());
}
</script>
</body>
</html>


/* ================== APPS SCRIPT ================== */

function doPost(e){
 const d=JSON.parse(e.postData.contents);

 switch(d.action){
  case "addLoanRequest": return json(addLoanRequest(d));
  case "getPending": return json(getPending());
  case "managerAction": return json(managerAction(d));
  case "adminApprove": return json(adminApproveLoan(d));
 }
}

function addLoanRequest(d){
 const sh=ss().getSheetByName("LoanRequests");
 sh.appendRow([
  "REQ"+Date.now(),
  new Date(),
  d.MemberID,
  d.Amount,
  d.Months,
  d.Interest,
  d.RequestedBy,
  "Pending"
 ]);
 return {status:true};
}

function getPending(){
 return getSheet("LoanRequests").filter(x=>x.Status=="Pending");
}

function managerAction(d){
 const sh=ss().getSheetByName("LoanRequests");
 const data=sh.getDataRange().getValues();
 const idIdx=data[0].indexOf("RequestID");
 const statusIdx=data[0].indexOf("Status");

 for(let i=1;i<data.length;i++){
  if(data[i][idIdx]==d.RequestID){
   sh.getRange(i+1,statusIdx+1)
    .setValue(d.approve?"ManagerApproved":"ManagerRejected");
   return {status:true};
  }
 }
 return {status:false};
}

function adminApproveLoan(d){
 const req=getSheet("LoanRequests")
  .find(x=>x.RequestID==d.RequestID);
 if(!req) return {status:false};

 addLoan(req);
 return {status:true};
}

function addLoan(r){
 const sh=ss().getSheetByName("Loans");
 const emi=calcEMI(r.Amount,r.Interest,r.Months);
 sh.appendRow([
  "LN"+Date.now(),
  r.MemberID,
  r.Amount,
  r.Interest,
  r.Months,
  emi,
  0,
  r.Amount,
  "Active",
  new Date()
 ]);
}

function calcEMI(P,R,N){
 R=R/12/100;
 return Math.round(P*R*Math.pow(1+R,N)/(Math.pow(1+R,N)-1));
}

function getSheet(name){
 const sh=ss().getSheetByName(name);
 const d=sh.getDataRange().getValues();
 const h=d.shift();
 return d.map(r=>Object.fromEntries(h.map((k,i)=>[k,r[i]])));
}

function ss(){return SpreadsheetApp.getActive();}
function json(o){return ContentService.createTextOutput(JSON.stringify(o)).setMimeType(ContentService.MimeType.JSON);}
