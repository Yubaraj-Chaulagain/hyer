<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Loan Workflow</title>
<style>
body{font-family:Arial;background:#0f172a;color:#fff}
.tabs{display:flex;justify-content:center;margin:20px 0}
.tabs button{padding:10px 20px;margin:0 5px;background:#1e293b;color:#fff;border:none;cursor:pointer}
.tabs button.active{background:#22c55e;color:#000}
.tabcontent{display:none;padding:10px}
input,button,select{padding:8px;margin:5px}
table{margin:auto;border-collapse:collapse;width:90%}
td,th{border:1px solid #fff;padding:6px;text-align:center}
button.action{background:#22c55e;border:none;padding:5px 10px;margin:2px;cursor:pointer}
</style>
</head>
<body>

<h2 style="text-align:center">Loan Workflow</h2>

<!-- Tabs -->
<div class="tabs">
  <button class="tablinks active" onclick="openTab('loginTab')">Login</button>
  <button class="tablinks" onclick="openTab('staffTab')">Staff</button>
  <button class="tablinks" onclick="openTab('managerTab')">Manager</button>
  <button class="tablinks" onclick="openTab('adminTab')">Admin</button>
</div>

<!-- Login -->
<div id="loginTab" class="tabcontent" style="display:block;text-align:center">
  Code: <input id="code"><button onclick="login()">Login</button>
</div>

<!-- Staff -->
<div id="staffTab" class="tabcontent">
  <h3>Staff Loan Request</h3>
  <form id="requests">
    MemberID <input id="m"><br>
    Amount <input id="a"><br>
    Months <input id="mo"><br>
    Interest <input id="i"><br>
    <button type="button" onclick="requestLoan()">Send</button>
  </form>
  <h3>My Requests</h3>
  <button onclick="loadMyRequests()">Load</button>
  <table id="staffTbl"></table>
</div>

<!-- Manager -->
<div id="managerTab" class="tabcontent">
  <h3>Manager Approval</h3>
  <button onclick="loadPending()">Load Pending</button>
  <table id="tbl"></table>
</div>

<!-- Admin -->
<div id="adminTab" class="tabcontent">
  <h3>Admin Final Approve</h3>
  <button onclick="loadManagerApproved()">Load</button>
  <table id="tbl2"></table>
</div>

<script>
let user={};

// Tab switching
function openTab(tabName){
  document.querySelectorAll(".tabcontent").forEach(tab=>tab.style.display="none");
  document.querySelectorAll(".tablinks").forEach(btn=>btn.classList.remove("active"));
  document.getElementById(tabName).style.display="block";
  event.currentTarget.classList.add("active");
}

// Web App URL
const URL="https://script.google.com/macros/s/AKfycbz2u6QX920V9ZGDzwoilCRNH16KxnknTHls3d5LNowfi0jMdJ-0GU4bKcv03tM6XzOWfg/exec";

// Login function
function login(){
  const codeVal = document.getElementById("code").value;
  fetch(URL,{
    method:"POST",
    body:JSON.stringify({action:"login", code: codeVal})
  }).then(r=>r.json())
  .then(u=>{
    if(!u.status) return alert("Wrong Code");
    user=u;

    // Auto open relevant tabs
    if(u.role=="Staff") openTab('staffTab');
    if(u.role=="Manager") openTab('managerTab');
    if(u.role=="Admin") openTab('adminTab');
  });
}
  
function requestLoan(){

fetch(URL,{
  method:"POST",
  body:JSON.stringify({
    action:"addLoanRequest",
    MemberID:m.value,
    Amount:a.value,
    Months:mo.value,
    Interest:i.value,
    BranchCode:user.branch,     // ✅ ADD THIS
    StaffCode:user.code         // ✅ ADD THIS
  })
})
.then(r=>r.json())
.then(res=>{
  if(res.status){
    alert("Request Sent ✅");
    document.getElementById("requests").reset();
  }
});
}

function loadPending(){
fetch(URL,{method:"POST",body:JSON.stringify({
action:"getPending",branch:user.branch
})}).then(r=>r.json()).then(list=>{

let h="<tr><th>ID</th><th>Member</th><th>Amount</th><th>Edit</th><th>Action</th></tr>";

list.forEach(x=>{
h+=`<tr>
<td>${x.RequestID}</td>
<td>${x.MemberID}</td>

<td>
<input id="amt_${x.RequestID}" value="${x.Amount}">
</td>

<td>
<button onclick="updateAmount('${x.RequestID}')">Save</button>
</td>

<td>
<button onclick="managerAction('${x.RequestID}',true)">Approve</button>
<button onclick="managerAction('${x.RequestID}',false)">Reject</button>
</td>
</tr>`;
});

tbl.innerHTML=h;
});
}

function managerAction(id,a){
fetch(URL,{method:"POST",body:JSON.stringify({
action:"managerAction",
RequestID:id,
approve:a
})}).then(()=>loadPending());
}

function loadManagerApproved(){
fetch(URL,{method:"POST",body:JSON.stringify({
action:"getManagerApproved"
})}).then(r=>r.json()).then(list=>{

let h="<tr><th>ID</th><th>Member</th><th>Amount</th><th>Edit</th><th>Final</th></tr>";

list.forEach(x=>{
h+=`<tr>
<td>${x.RequestID}</td>
<td>${x.MemberID}</td>

<td>
<input id="adm_${x.RequestID}" value="${x.Amount}">
</td>
<td>
<input id="reason_${x.RequestID}" placeholder="Reason">
</td>
<td>
<button onclick="rejectWithReason('${x.RequestID}')">Reject</button>
<button onclick="updateAmount('${x.RequestID}',true)">Save</button>
</td>

<td>
<button onclick="adminApprove('${x.RequestID}')">Approve</button>
</td>
</tr>`;
});

tbl2.innerHTML=h;
});
}

function updateAmount(id,admin=false){

let amt = admin
? document.getElementById("adm_"+id).value
: document.getElementById("amt_"+id).value;

fetch(URL,{
method:"POST",
body:JSON.stringify({
action:"updateAmount",
RequestID:id,
Amount:amt
})
}).then(()=>alert("Amount Updated ✅"));
}

 function loadMyRequests(){
fetch(URL,{
  method:"POST",
  body:JSON.stringify({
    action:"getStaffRequests",
    StaffCode:user.code
  })
})
.then(r=>r.json())
.then(list=>{

let h="<tr><th>ID</th><th>Member</th><th>Amount</th><th>Status</th><th>Action</th></tr>";

list.forEach(x=>{
let color =
x.Status=="ManagerRejected" || x.Status=="AdminRejected"
? "style='color:red'"
: x.Status=="AdminApproved"
? "style='color:lightgreen'"
: "";

let actionBtn = "";
if(x.Status=="ManagerRejected" || x.Status=="AdminRejected"){
  actionBtn = `<button onclick="reRequest('${x.RequestID}')">Re-Request</button>`;
}

h+=`<tr ${color}>
<td>${x.RequestID}</td>
<td>${x.MemberID}</td>
<td>${x.Amount}</td>
<td>${x.Status}</td>
<td>${actionBtn}</td>
</tr>`;
});

staffTbl.innerHTML=h;
});

  function reRequest(id){
  // Get amount from the table input
  let amtInput = document.getElementById("amt_" + id);
  let newAmount = prompt("Enter new Amount:", amtInput ? amtInput.value : "");

  fetch(URL,{
    method:"POST",
    body:JSON.stringify({
      action:"reRequest",
      RequestID:id,
      Amount:newAmount
    })
  })
  .then(r=>r.json())
  .then(res=>{
    if(res.status){
      alert("Request Re-submitted ✅");
      loadMyRequests(); // refresh staff table
    }
  });
}

function adminApprove(id){
fetch(URL,{method:"POST",body:JSON.stringify({
action:"adminApprove",
RequestID:id
})}).then(()=>alert("Loan Added"));
}
</script>
</body>
</html>
