<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Chat System</title>

<style>
body{margin:0;font-family:Arial;background:#ece5dd}
.box{background:#fff;padding:15px;margin:15px;border-radius:10px}
input,button,select{padding:8px;margin:5px;font-size:14px}
button{background:#075e54;color:white;border:none;border-radius:5px}
#chat,#publicChat{height:300px;overflow:auto;background:#f1f1f1;padding:10px;border-radius:8px}
.msgMe{background:#dcf8c6;padding:6px;margin:4px;border-radius:6px;text-align:right}
.msgOther{background:#fff;padding:6px;margin:4px;border-radius:6px;text-align:left}
</style>
</head>
<body>

<!-- LOGIN -->
<div id="loginBox" class="box">
<h3>Login</h3>
<input id="loginID" placeholder="Member ID"><br>
<input id="loginPass" type="password" placeholder="Password"><br>
<button onclick="login()">Login</button>
<p>
<a href="#" onclick="showSignup()">Signup</a> |
<a href="#" onclick="showReset()">Forgot?</a>
</p>
</div>

<!-- SIGNUP -->
<div id="signupBox" class="box" style="display:none">
<h3>Signup</h3>
<input id="sid" placeholder="Member ID"><br>
<input id="sname" placeholder="Name"><br>
<input id="semail" placeholder="Email"><br>
<input id="spass" type="password" placeholder="Password"><br>
<button onclick="signup()">Register</button>
<p><a href="#" onclick="showLogin()">Back</a></p>
</div>

<!-- RESET -->
<div id="resetBox" class="box" style="display:none">
<h3>Reset Password</h3>
<input id="remail" placeholder="Email"><br>
<button onclick="sendOTP()">Send OTP</button><br>
<input id="rotp" placeholder="Enter OTP"><br>
<input id="rnew" type="password" placeholder="New Password"><br>
<button onclick="verifyReset()">Reset</button>
<p><a href="#" onclick="showLogin()">Back</a></p>
</div>

<!-- CHAT AREA -->
<div id="chatArea" class="box" style="display:none">

<button onclick="showPrivate()">üîí Private</button>
<button onclick="showPublic()">üåç Public</button>
<button onclick="showChange()">‚öô Change Password</button>

<hr>

<!-- PRIVATE -->
<div id="privateDiv">
<select id="member"></select>

<div id="chat"></div>

<input id="msg" placeholder="Message">
<button onclick="sendPrivate()">Send</button>
</div>

<!-- PUBLIC -->
<div id="publicDiv" style="display:none">
<div id="publicChat"></div>

<input id="publicMsg" placeholder="Public Message">
<button onclick="sendPublic()">Send</button>
</div>

<!-- CHANGE PASSWORD -->
<div id="changeDiv" style="display:none">
<h4>Change Password</h4>
<input id="cemail" placeholder="Your Email"><br>
<input id="cnew" type="password" placeholder="New Password"><br>
<button onclick="changePass()">Update</button>
</div>

</div>

<script>

const API="https://script.google.com/macros/s/AKfycbxZ3mOTBQHznRdyE0RIcM_NxPbPIHWrQF3ITscqBLl711vcvDjHQVyXCBiTaDSU9KCLYQ/exec";
let ME="";

// ---------- FORM SHOW ----------
function showSignup(){loginBox.style.display="none";signupBox.style.display="block";}
function showLogin(){loginBox.style.display="block";signupBox.style.display="none";resetBox.style.display="none";}
function showReset(){loginBox.style.display="none";resetBox.style.display="block";}
function showPrivate(){privateDiv.style.display="block";publicDiv.style.display="none";changeDiv.style.display="none";}
function showPublic(){privateDiv.style.display="none";publicDiv.style.display="block";changeDiv.style.display="none";}
function showChange(){privateDiv.style.display="none";publicDiv.style.display="none";changeDiv.style.display="block";}

// ---------- LOGIN ----------
async function login(){
let r=await fetch(API,{method:'post',
body:new URLSearchParams({action:'login',id:loginID.value,pass:loginPass.value})});
let t=await r.text();
if(t=="FAIL"){alert("Wrong Login");return;}
ME=t;
loginBox.style.display="none";
chatArea.style.display="block";
loadMembers();
setInterval(loadMessages,2000);
}

// ---------- SIGNUP ----------
async function signup(){
await fetch(API,{method:'post',
body:new URLSearchParams({
action:'register',
id:sid.value,
name:sname.value,
email:semail.value,
pass:spass.value
})});
alert("Registered");
showLogin();
}

// ---------- PRIVATE SEND ----------
async function sendPrivate(){
if(msg.value=="") return;
await fetch(API,{method:'post',
body:new URLSearchParams({
action:'send',
from:ME,
to:member.value,
msg:msg.value
})});
msg.value="";
}

// ---------- PUBLIC SEND ----------
async function sendPublic(){
if(publicMsg.value=="") return;
await fetch(API,{method:'post',
body:new URLSearchParams({
action:'public',
from:ME,
msg:publicMsg.value
})});
publicMsg.value="";
}

// ---------- LOAD ----------
async function loadMessages(){
let r=await fetch(API+"?action=msgs");
let d=await r.json();

chat.innerHTML="";
publicChat.innerHTML="";

d.slice(1).forEach(row=>{
if(row[2]=="ALL"){
publicChat.innerHTML+="<div><b>"+row[1]+":</b> "+row[3]+"</div>";
}
else if((row[1]==ME && row[2]==member.value) ||
(row[1]==member.value && row[2]==ME)){
let cls=row[1]==ME?"msgMe":"msgOther";
chat.innerHTML+="<div class='"+cls+"'>"+row[3]+"</div>";
}
});

chat.scrollTop=chat.scrollHeight;
publicChat.scrollTop=publicChat.scrollHeight;
}

// ---------- MEMBERS ----------
async function loadMembers(){
let r=await fetch(API+"?action=members");
let list=await r.json();
member.innerHTML=list.map(x=>"<option>"+x+"</option>").join("");
}

// ---------- RESET ----------
async function sendOTP(){
await fetch(API,{method:'post',
body:new URLSearchParams({action:'sendOTP',email:remail.value})});
alert("OTP Sent");
}

async function verifyReset(){
let r1=await fetch(API,{method:'post',
body:new URLSearchParams({action:'verifyOTP',email:remail.value,otp:rotp.value})});
let t=await r1.text();
if(t=="ok"){
await fetch(API,{method:'post',
body:new URLSearchParams({action:'changePass',email:remail.value,newpass:rnew.value})});
alert("Password Changed");
showLogin();
}else alert("Wrong OTP");
}

// ---------- CHANGE ----------
async function changePass(){
await fetch(API,{method:'post',
body:new URLSearchParams({action:'changePass',email:cemail.value,newpass:cnew.value})});
alert("Updated");
showPrivate();
}

</script>

</body>
</html>
