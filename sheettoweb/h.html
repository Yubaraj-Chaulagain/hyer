<!DOCTYPE html>
<html lang="ne">
<head>
<meta charset="UTF-8">
<title>рд╕рд╣рдХрд╛рд░реА рд╕рджрд╕реНрдп рджрд░реНрддрд╛ рдлрд╛рд░рдо</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

<style>
  body{background:#f4f6f8}
  h6{border-bottom:2px solid #e5e7eb;padding-bottom:4px}
</style>
</head>

<body>
<div class="container my-4">
<div class="card shadow">
<div class="card-header bg-success text-white text-center">
  <h4 class="mb-0">рд╕рд╣рдХрд╛рд░реА рд╕рджрд╕реНрдп рджрд░реНрддрд╛ рдлрд╛рд░рдо</h4>
</div>

<div class="card-body">
<form id="memberForm">

<!-- ================== 1. PERSONAL ================== -->
<h6 class="text-primary">рез. рд╡реНрдпрдХреНрддрд┐рдЧрдд рд╡рд┐рд╡рд░рдг</h6>
<div class="row mb-3">
  <div class="col-md-2">
    <label>рд╕рджрд╕реНрдп рдирдВ.</label>
    <input class="form-control" name="рд╕рджрд╕реНрдп рдирдВ.">
  </div>
  <div class="col-md-3">
  <label>рдЦрд╛рддрд╛ рдирдВ.</label>
  <input class="form-control" id="member_id" name="рдЦрд╛рддрд╛ рдирдВ." required>
  <div class="mt-1">
    <button type="button" class="btn btn-sm btn-primary" onclick="searchMember()">Search</button>
    <button type="button" class="btn btn-sm btn-warning" onclick="updateMember()">Update</button>
    <button type="button" class="btn btn-sm btn-danger" onclick="deleteMember()">Delete</button>
  </div>
</div>

  <div class="col-md-7">
    <label>рдкреВрд░рд╛ рдирд╛рдо</label>
    <input class="form-control" name="рдкреВрд░рд╛ рдирд╛рдо" required>
  </div>
</div>

<div class="row mb-3">
  <div class="col-md-4"><label>рдмреБрдмрд╛рдХреЛ рдирд╛рдо</label><input class="form-control" name="рдмреБрдмрд╛рдХреЛ рдирд╛рдо"></div>
  <div class="col-md-4"><label>рд╣рдЬреБрд░ рдмреБрдмрд╛рдХреЛ рдирд╛рдо</label><input class="form-control" name="рд╣рдЬреБрд░ рдмреБрдмрд╛рдХреЛ рдирд╛рдо"></div>
  <div class="col-md-4"><label>рдкрддрд┐ / рдкрддреНрдиреА</label><input class="form-control" name="рдкрддрд┐ / рдкрддреНрдиреА"></div>
</div>

<div class="row mb-3">
  <div class="col-md-4">
    <label>рд▓рд┐рдЩреНрдЧ</label>
    <select class="form-select" name="рд▓рд┐рдЩреНрдЧ">
      <option>рдкреБрд░реБрд╖</option><option>рдорд╣рд┐рд▓рд╛</option><option>рдЕрдиреНрдп</option>
    </select>
  </div>
  <div class="col-md-4"><label>рдЬрдиреНрдо рдорд┐рддрд┐</label><input type="date" class="form-control" name="рдЬрдиреНрдо рдорд┐рддрд┐"></div>
  <div class="col-md-4"><label>рдирд╛рдЧрд░рд┐рдХрддрд╛ рдирдВ.</label><input class="form-control" name="рдирд╛рдЧрд░рд┐рдХрддрд╛ рдирдВ."></div>
</div>

<!-- ================== 2. ADDRESS ================== -->
<h6 class="text-primary mt-4">реи. рдареЗрдЧрд╛рдирд╛</h6>
<div class="row mb-3">
  <div class="col-md-3"><label>рдкреНрд░рджреЗрд╢</label><select id="province" name="рдкреНрд░рджреЗрд╢" class="form-select"></select></div>
  <div class="col-md-3"><label>рдЬрд┐рд▓реНрд▓рд╛</label><select id="district" name="рдЬрд┐рд▓реНрд▓рд╛" class="form-select"></select></div>
  <div class="col-md-3"><label>рдкрд╛рд▓рд┐рдХрд╛</label><select id="municipality" name="рдкрд╛рд▓рд┐рдХрд╛" class="form-select"></select></div>
  <div class="col-md-3"><label>рд╡рдбрд╛ рдирдВ.</label><input class="form-control" name="рд╡рдбрд╛ рдирдВ."></div>
</div>

<!-- ================== 3. CONTACT ================== -->
<h6 class="text-primary mt-4">рей. рд╕рдореНрдкрд░реНрдХ рд╡рд┐рд╡рд░рдг</h6>
<div class="row mb-3">
  <div class="col-md-6"><label>рдореЛрдмрд╛рдЗрд▓ рдирдВ.</label><input class="form-control" name="рдореЛрдмрд╛рдЗрд▓ рдирдВ."></div>
  <div class="col-md-6"><label>рдИрдореЗрд▓</label><input type="email" class="form-control" name="рдИрдореЗрд▓"></div>
</div>

<!-- ================== 4. MEMBER TYPE ================== -->
<h6 class="text-primary mt-4">рек. рд╕рджрд╕реНрдпрдХреЛ рдкреНрд░рдХрд╛рд░</h6>
<div class="row mb-3">
  <div class="col-md-4">
    <label>рд╕рджрд╕реНрдп рдкреНрд░рдХрд╛рд░</label>
    <select class="form-select" name="рд╕рджрд╕реНрдп рдкреНрд░рдХрд╛рд░">
      <option>рд╕рд╛рдзрд╛рд░рдг рд╕рджрд╕реНрдп</option>
      <option>рд╕рдВрд╕реНрдерд╛рдкрдХ рд╕рджрд╕реНрдп</option>
      <option>рдЛрдгреА рд╕рджрд╕реНрдп</option>
      <option>рдмрд╛рд▓ рд╕рджрд╕реНрдп</option>
    </select>
  </div>
  <div class="col-md-4"><label>рд╕реЗрдпрд░ рд╕рдВрдЦреНрдпрд╛</label><input type="number" class="form-control" name="рд╕реЗрдпрд░ рд╕рдВрдЦреНрдпрд╛"></div>
  <div class="col-md-4">
    <label>рд╕рджрд╕реНрдп рд╕реНрдерд┐рддрд┐</label>
    <select class="form-select" name="рд╕рджрд╕реНрдп рд╕реНрдерд┐рддрд┐">
      <option>рд╕рдХреНрд░рд┐рдп</option><option>рдирд┐рд╖реНрдХреНрд░рд┐рдп</option>
    </select>
  </div>
</div>

<!-- ================== 5. OCCUPATION ================== -->
<h6 class="text-primary mt-4">рел. рдкреЗрд╢рд╛ рддрдерд╛ рдЖрдореНрджрд╛рдиреА</h6>
<div class="row mb-3">
  <div class="col-md-6">
    <label>рдкреЗрд╢рд╛</label>
    <select class="form-select" name="рдкреЗрд╢рд╛">
      <option>рдХреГрд╖рд┐</option><option>рд╡реНрдпрд╡рд╕рд╛рдп</option><option>рд╕реЗрд╡рд╛</option>
      <option>рд╡реИрджреЗрд╢рд┐рдХ рд░реЛрдЬрдЧрд╛рд░реА</option><option>рдордЬрджреБрд░реА</option>
    </select>
  </div>
  <div class="col-md-6"><label>рд╡рд╛рд░реНрд╖рд┐рдХ рдЖрдореНрджрд╛рдиреА</label><input type="number" class="form-control" name="рд╡рд╛рд░реНрд╖рд┐рдХ рдЖрдореНрджрд╛рдиреА"></div>
</div>

<!-- ================== 6. NOMINEE ================== -->
<h6 class="text-primary mt-4">рем. рд╣рдХрд╡рд╛рд▓рд╛рдХреЛ рд╡рд┐рд╡рд░рдг</h6>
<div class="row mb-3">
  <div class="col-md-4"><label>рдирд╛рдо</label><input class="form-control" name="рд╣рдХрд╡рд╛рд▓рд╛рдХреЛ рдирд╛рдо"></div>
  <div class="col-md-4"><label>рд╕рдореНрдмрдиреНрдз</label><input class="form-control" name="рд╣рдХрд╡рд╛рд▓рд╛ рд╕рдВрдЧрдХреЛ рд╕рдореНрдмрдиреНрдз"></div>
  <div class="col-md-4"><label>рд╣рдХ %</label><input type="number" class="form-control" name="рд╣рдХрд╡рд╛рд▓рд╛рдХреЛ рд╣рдХ %"></div>
</div>

<div class="row mb-3">
  <div class="col-md-4"><label>рдореЛрдмрд╛рдЗрд▓</label><input class="form-control" name="рд╣рдХрд╡рд╛рд▓рд╛рдХреЛ рдореЛрдмрд╛рдЗрд▓ рдирдВ."></div>
  <div class="col-md-4"><label>рдирд╛рдЧрд░рд┐рдХрддрд╛ рдирдВ.</label><input class="form-control" name="рд╣рдХрд╡рд╛рд▓рд╛рдХреЛ рдирд╛рдЧрд░рд┐рдХрддрд╛ рдирдВ."></div>
  <div class="col-md-4"> 
    <label>рдирд╛рдЧрд░рд┐рдХрддрд╛ рдЬрд╛рд░реА рдЬрд┐рд▓реНрд▓рд╛</label>
    <select id="citizenship_district" name="рдирд╛рдЧрд░рд┐рдХрддрд╛ рдЬрд╛рд░реА рдЬрд┐рд▓реНрд▓рд╛" class="form-select"></select>
  </div>
</div>

<!-- ================== 7. DOCUMENTS ================== -->
<h6 class="text-primary mt-4">рен. рдлреЛрдЯреЛ рддрдерд╛ рдХрд╛рдЧрдЬрд╛рдд</h6>

<div class="row mb-3">
  <div class="col-md-4">
    <label>рд╕рджрд╕реНрдп рдлреЛрдЯреЛ</label>
    <input type="file" class="form-control" onchange="handleUpload(this,'member_photo_url')">
  <input type="text" id="member_photo_url_display" class="form-control mt-1" readonly>
<input type="hidden" id="member_photo_url">
  </div>

  <div class="col-md-4">
    <label>рдирд╛рдЧрд░рд┐рдХрддрд╛ рдЕрдЧрд╛рдбрд┐</label>
    <input type="file" class="form-control" onchange="handleUpload(this,'member_citizen_front_url')">
    <input type="text" id="member_citizen_front_url_display" class="form-control mt-1" readonly>
    <input type="hidden"  id="member_citizen_front_url">
  </div>

  <div class="col-md-4">
    <label>рдирд╛рдЧрд░рд┐рдХрддрд╛ рдкрдЫрд╛рдбрд┐</label>
    <input type="file" class="form-control" onchange="handleUpload(this,'member_citizen_back_url')">
     <input type="text" id="member_citizen_back_url_display" class="form-control mt-1" readonly>
    <input type="hidden" id="member_citizen_back_url">
  </div>
</div>
  <!-- 8. official use only -->
  <h6 class="text-danger mt-4">7. рдХрд╛рд░реНрдпрд╛рд▓рдпреАрдп рдкреНрд░рдпреЛрдЧ (Office Use Only)</h6>

<div class="row mb-3">
  <div class="col-md-4">
    <label class="form-label">рджрд░реНрддрд╛ рдорд┐рддрд┐</label>
    <input type="date" class="form-control" name="рджрд░реНрддрд╛ рдорд┐рддрд┐">
  </div>

  <div class="col-md-4">
    <label class="form-label">рд╕реНрд╡реАрдХреГрдд рд╕реНрдерд┐рддрд┐</label>
    <select class="form-select" name="рд╕реНрд╡реАрдХреГрдд рд╕реНрдерд┐рддрд┐">
      <option>Pending</option>
      <option>Approved</option>
      <option>Rejected</option>
    </select>
  </div>

  <div class="col-md-4">
    <label class="form-label">Approved By</label>
    <input class="form-control" name="approved_by" placeholder="Chairman / Manager">
  </div>
</div>

<div class="row mb-3">
  <div class="col-md-6">
    <label class="form-label">рдкрдж</label>
    <input class="form-control" name="approved_designation">
  </div>
  <div class="col-md-6">
    <label class="form-label">рдХреИрдлрд┐рдпрдд</label>
    <input class="form-control" name="remarks">
  </div>
</div>

<!-- ================== SUBMIT ================== -->
<div class="form-check mt-3">
  <input class="form-check-input" type="checkbox" required>
  <label class="form-check-label">рдо рд╕рд╣рдХрд╛рд░реАрдХреЛ рдирд┐рдпрдо рдкрд╛рд▓рдирд╛ рдЧрд░реНрди рд╕рд╣рдордд рдЫреБ</label>
</div>

<div class="text-center mt-4">
  <button class="btn btn-success px-5">рджрд░реНрддрд╛ рдЧрд░реНрдиреБрд╣реЛрд╕реН</button>
</div>

</form>
</div>
</div>
</div>

<!-- ================== JS ================== -->
<script>
const IMGBB_KEY = "f5d95811959fdcd59c8ea459aadb650b";
let addressData = {};

fetch("nepal-admin-structure.json")
.then(r => r.json())
.then(d => {
  addressData = d;

  // Province load
  province.innerHTML = '<option value="">рдкреНрд░рджреЗрд╢ рдЫрд╛рдиреНрдиреБрд╣реЛрд╕реН</option>';
  for (let p in d) {
    province.innerHTML += `<option value="${p}">${p}</option>`;
  }

  // Citizenship district (ALL)
  citizenship_district.innerHTML = '<option value="">рдЬрд┐рд▓реНрд▓рд╛ рдЫрд╛рдиреНрдиреБрд╣реЛрд╕реН</option>';
  for (let p in d) {
    for (let dist in d[p]) {
      citizenship_district.innerHTML += `<option value="${dist}">${dist}</option>`;
    }
  }
});

// Province тЖТ District
province.onchange = () => {
  district.innerHTML = '<option value="">рдЬрд┐рд▓реНрд▓рд╛ рдЫрд╛рдиреНрдиреБрд╣реЛрд╕реН</option>';
  municipality.innerHTML = '<option value="">рдкрд╛рд▓рд┐рдХрд╛ рдЫрд╛рдиреНрдиреБрд╣реЛрд╕реН</option>';

  if (!province.value) return;

  for (let dist in addressData[province.value]) {
    district.innerHTML += `<option value="${dist}">${dist}</option>`;
  }
};

// District тЖТ Municipality
district.onchange = () => {
  municipality.innerHTML = '<option value="">рдкрд╛рд▓рд┐рдХрд╛ рдЫрд╛рдиреНрдиреБрд╣реЛрд╕реН</option>';

  if (!district.value) return;

  addressData[province.value][district.value].forEach(m => {
    municipality.innerHTML += `<option value="${m}">${m}</option>`;
  });
};
  
async function handleUpload(input, targetId) {

  if (!member_id.value) {
    alert("рдкрд╣рд┐рд▓рд╛ рдЦрд╛рддрд╛ рдирдВ. рд▓реЗрдЦреНрдиреБрд╣реЛрд╕реН");
    input.value = "";
    return;
  }

  const file = input.files[0];
  if (!file) return;

  const ext = file.name.split('.').pop(); // jpg / png

  const fd = new FormData();
  fd.append("key", IMGBB_KEY);
  fd.append("image", file);

  const r = await fetch("https://api.imgbb.com/1/upload", {
    method: "POST",
    body: fd
  });

  const j = await r.json();
  if (!j.success) {
    alert("Upload failed");
    return;
  }

  // ЁЯФе ORIGINAL imgbb url
  const originalUrl = j.data.url;  
  // example: https://i.ibb.co/jPBZdddZ/abcxyz.jpg

  // ЁЯФе base folder extract
  const base = originalUrl.substring(0, originalUrl.lastIndexOf('/') + 1);

  // ЁЯФе custom filename
  const customFile =
    member_id.value + "-" +
    targetId.replace("_url", "").replaceAll("_", "-") +
    "." + ext;

  const finalUrl = base + customFile;

  // save custom url
  document.getElementById(targetId).value = finalUrl;

  const display = document.getElementById(targetId + "_display");
  if (display) display.value = finalUrl;

  console.log("ORIGINAL:", originalUrl);
  console.log("CUSTOM:", finalUrl);
}


</script>
<script>
const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzxQciKEGfjC3YB4_bL9qg5q-8onufy5CDWJTBDgliqC2U-77a_ozP7lIoP5ta-e4Lkow/exec";

document.getElementById("memberForm").addEventListener("submit", async e => {
  e.preventDefault();

  const form = e.target;
  const data = {};

  [...form.elements].forEach(el => {
    if (el.name) data[el.name] = el.value;
  });

  // hidden image urls
  data.member_photo_url = document.getElementById("member_photo_url").value;
  data.member_citizen_front_url = document.getElementById("member_citizen_front_url").value;
  data.member_citizen_back_url = document.getElementById("member_citizen_back_url").value;

  const res = await fetch(SCRIPT_URL, {
    method: "POST",
    body: JSON.stringify(data)
  });

  const j = await res.json();

  if (j.status === "success") {
    alert("тЬЕ рд╕рджрд╕реНрдп рджрд░реНрддрд╛ рд╕рдлрд▓ рднрдпреЛ");
    form.reset();
  } else {
    alert("тЭМ Error рднрдпреЛ");
  }
});
</script>
  <script>
async function searchMember(){
  if(!member_id.value) return alert("рдЦрд╛рддрд╛ рдирдВ. рд▓реЗрдЦреНрдиреБрд╣реЛрд╕реН");

  const r = await fetch(SCRIPT_URL,{
    method:"POST",
    body:JSON.stringify({
      action:"search",
      "рдЦрд╛рддрд╛ рдирдВ.":member_id.value
    })
  });
  const j = await r.json();

  if(j.status!=="found") return alert("Member not found");

  for(let k in j.data){
    const el = document.querySelector(`[name="${k}"]`);
    if(el) el.value = j.data[k];
  }

  // image urls
  member_photo_url.value = j.data.member_photo_url || "";
  member_photo_url_display.value = j.data.member_photo_url || "";
  member_citizen_front_url.value = j.data.member_citizen_front_url || "";
  member_citizen_front_url_display.value = j.data.member_citizen_front_url || "";
  member_citizen_back_url.value = j.data.member_citizen_back_url || "";
  member_citizen_back_url_display.value = j.data.member_citizen_back_url || "";
}

async function updateMember(){
  const data = collectForm();
  data.action = "update";

  const r = await fetch(SCRIPT_URL,{
    method:"POST",
    body:JSON.stringify(data)
  });
  const j = await r.json();

  alert(j.status==="updated" ? "тЬЕ Update рднрдпреЛ" : "тЭМ Update failed");
}

async function deleteMember(){
  if(!confirm("Delete рдЧрд░реНрдиреБрд╣реБрдиреНрдЫ?")) return;

  const r = await fetch(SCRIPT_URL,{
    method:"POST",
    body:JSON.stringify({
      action:"delete",
      "рдЦрд╛рддрд╛ рдирдВ.":member_id.value
    })
  });
  const j = await r.json();
  alert(j.status==="deleted" ? "ЁЯЧСя╕П Deleted" : "Not found");
}

function collectForm(){
  const data = {};
  [...memberForm.elements].forEach(el=>{
    if(el.name) data[el.name]=el.value;
  });
  data.member_photo_url = member_photo_url.value;
  data.member_citizen_front_url = member_citizen_front_url.value;
  data.member_citizen_back_url = member_citizen_back_url.value;
  return data;
}
</script>


</body>
</html>

