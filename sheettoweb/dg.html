<!DOCTYPE html>
<html>
<head>
<title>Member Management with OTP</title>

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

<style>
.hidden{display:none}
.table-wrapper{overflow-x:auto}
table{width:100%;table-layout:fixed;border-collapse:collapse}
th,td{padding:6px;font-size:14px;text-align:center;vertical-align:middle;word-break:break-word}
th,td{min-width:120px}
.photo-col{width:80px;min-width:80px}
.action-col{width:150px;min-width:150px}
.thumb{width:50px;height:50px;object-fit:cover;border-radius:5px}
</style>
</head>

<body class="p-3">

<!-- ğŸ” LOGIN -->
<div id="loginBox" class="col-md-4 mx-auto">
<h4>ğŸ” Login</h4>
<input id="user" class="form-control mb-2" placeholder="admin / viewer">
<input id="pass" type="password" class="form-control mb-2" placeholder="password">
<button class="btn btn-primary w-100" onclick="login()">Login</button>
</div>

<!-- ğŸ“Š APP -->
<div id="app" class="hidden">

<h4 class="mb-3">ğŸ“Š Dashboard</h4>
<div class="row mb-3">
<div class="col">ğŸ‘¥ Total: <b id="d_total"></b></div>
<div class="col">âœ… Active: <b id="d_active"></b></div>
<div class="col">âŒ Inactive: <b id="d_inactive"></b></div>
</div>

<input id="search" class="form-control mb-2" placeholder="Search">

<button id="addBtn" class="btn btn-success mb-2" onclick="openAdd()">+ Add Member</button>

<div class="table-wrapper">
<table class="table table-bordered table-sm">
<thead class="table-dark">
<tr id="thead"></tr>
</thead>
<tbody id="tbody"></tbody>
</table>
</div>
</div>

<!-- ğŸ“ MEMBER MODAL -->
<div class="modal fade" id="memberModal">
<div class="modal-dialog modal-xl">
<div class="modal-content">
<div class="modal-header">
<h5 id="modalTitle"></h5>
<button class="btn-close" data-bs-dismiss="modal"></button>
</div>

<div class="modal-body row g-2" id="formBody"></div>

<div class="modal-footer">
<button class="btn btn-success" onclick="save()">Save</button>
</div>
</div>
</div>
</div>

<!-- ğŸ”’ OTP MODAL -->
<div class="modal fade" id="otpModal">
<div class="modal-dialog">
<div class="modal-content">
<div class="modal-header">
<h5>ğŸ”’ OTP Verification</h5>
</div>
<div class="modal-body">
<input id="otpInput" class="form-control" placeholder="Enter OTP">
</div>
<div class="modal-footer">
<button class="btn btn-primary" onclick="verifyOtp()">Verify</button>
</div>
</div>
</div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<script>
/* ================= CONFIG ================= */
const API="https://script.google.com/macros/s/AKfycbxAw2HRS_g62KM5QwJlKxd6HMsdQ5s0XS4jyyP9dTKjUWwG8McloScRnl-Eu7rWAQofbg/exec";
const IMGBB="f5d95811959fdcd59c8ea459aadb650b";

/* ================= GLOBAL ================= */
let headers=[],members=[],role="",edit=false;
let pendingAction=null;
const modal=new bootstrap.Modal(memberModal);
const otpModalObj=new bootstrap.Modal(otpModal);

/* ================= LOGIN ================= */
function login(){
fetch(API,{
method:"POST",
body:JSON.stringify({action:"login",user:user.value,pass:pass.value})
})
.then(r=>r.json())
.then(d=>{
if(!d.ok) return alert("Login failed");
role=d.role;
loginBox.classList.add("hidden");
app.classList.remove("hidden");
if(role!=="admin") addBtn.style.display="none";
loadMembers();
});
}

/* ================= LOAD ================= */
function loadMembers(){
fetch(API).then(r=>r.json()).then(d=>{
members=d;
headers=Object.keys(d[0]);
buildTable();
draw();
buildForm();
dashboard();
});
}

/* ================= DASHBOARD ================= */
function dashboard(){
d_total.innerText=members.length;
d_active.innerText=members.filter(x=>x.Status=="Active").length;
d_inactive.innerText=members.filter(x=>x.Status=="Inactive").length;
}

/* ================= TABLE ================= */
function buildTable(){
thead.innerHTML="";
headers.forEach(h=>{
let cls=h.toLowerCase().includes("photo")?"photo-col":"";
thead.innerHTML+=`<th class="${cls}">${h}</th>`;
});
thead.innerHTML+=`<th class="action-col">Action</th>`;
}

function draw(){
tbody.innerHTML="";
members.forEach(m=>{
let tr="<tr>";
headers.forEach(h=>{
if(h.toLowerCase().includes("photo")){
tr+=`<td class="photo-col">${m[h]?`<img src="${m[h]}" class="thumb">`:""}</td>`;
}else{
tr+=`<td>${m[h]||""}</td>`;
}
});
tr+=`<td class="action-col">
${role==="admin"?`<button class="btn btn-sm btn-warning me-1" onclick='editM(${JSON.stringify(m)})'>Edit</button>`:""}
${role==="admin"?`<button class="btn btn-sm btn-danger" onclick='deleteM("${m.MemberID}")'>Del</button>`:""}
</td></tr>`;
tbody.innerHTML+=tr;
});
}

/* ================= FORM ================= */
function buildForm(){
formBody.innerHTML="";
headers.forEach(h=>{
formBody.innerHTML+=`
<div class="col-6">
<label>${h}</label>
<input id="f_${h}" class="form-control">
${h.toLowerCase().includes("photo")?
`<input type="file" class="form-control mt-1" onchange="uploadImg(this,'${h}')">`:""}
</div>`;
});
}

/* ================= ADD / EDIT ================= */
function openAdd(){
edit=false;
modalTitle.innerText="Add Member";
headers.forEach(h=>f(h).value="");
modal.show();
}

function editM(m){
edit=true;
modalTitle.innerText="Edit Member";
headers.forEach(h=>f(h).value=m[h]||"");
modal.show();
}

/* ================= OTP FLOW ================= */
function save(){
requestOtp(f("MemberID").value, ()=>{
let d={action:edit?"update":"add",otp:otpInput.value};
headers.forEach(h=>d[h]=f(h).value);
fetch(API,{method:"POST",body:JSON.stringify(d)})
.then(()=>{modal.hide();loadMembers();});
});
}

function deleteM(id){
requestOtp(id, ()=>{
fetch(API,{
method:"POST",
body:JSON.stringify({action:"delete",MemberID:id,otp:otpInput.value})
})
.then(()=>loadMembers());
});
}

function requestOtp(id,cb){
pendingAction=cb;
fetch(API,{
method:"POST",
body:JSON.stringify({action:"sendOtp",MemberID:id})
})
.then(r=>r.json())
.then(d=>{
if(d.ok) otpModalObj.show();
else alert("OTP send failed");
});
}

function verifyOtp(){
otpModalObj.hide();
pendingAction();
}

/* ================= IMAGE UPLOAD ================= */
function uploadImg(input,field){
const fd=new FormData();
fd.append("image",input.files[0]);
fetch(`https://api.imgbb.com/1/upload?key=${IMGBB}`,{
method:"POST",body:fd
})
.then(r=>r.json())
.then(d=>{
if(d.success) f(field).value=d.data.url;
else alert("Upload failed");
});
}

/* ================= UTILS ================= */
const f=h=>document.getElementById("f_"+h);
</script>

</body>
</html>
