<!DOCTYPE html>
<html>
<head>
<title>Member Management (OTP Working)</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
<style>
.hidden{display:none}
.table-wrapper{overflow-x:auto}
th,td{text-align:center;min-width:120px}
.thumb{width:50px;height:50px;object-fit:cover}
</style>
</head>

<body class="p-3">

<!-- LOGIN -->
<div id="loginBox" class="col-md-4 mx-auto">
<h4>Login</h4>
<input id="user" class="form-control mb-2" placeholder="Username">
<input id="pass" type="password" class="form-control mb-2" placeholder="Password">
<button class="btn btn-primary w-100" onclick="login()">Login</button>
</div>

<!-- APP -->
<div id="app" class="hidden">
<button class="btn btn-success mb-2" onclick="openAdd()">+ Add Member</button>

<div class="table-wrapper">
<table class="table table-bordered">
<thead class="table-dark"><tr id="thead"></tr></thead>
<tbody id="tbody"></tbody>
</table>
</div>
</div>

<!-- MEMBER MODAL -->
<div class="modal fade" id="memberModal">
<div class="modal-dialog modal-xl">
<div class="modal-content">
<div class="modal-header">
<h5 id="modalTitle"></h5>
<button class="btn-close" data-bs-dismiss="modal"></button>
</div>
<div class="modal-body row g-2" id="formBody"></div>
<div class="modal-footer">
<button class="btn btn-success" onclick="save()">Save</button>
</div>
</div>
</div>
</div>

<!-- OTP MODAL -->
<div class="modal fade" id="otpModal">
<div class="modal-dialog">
<div class="modal-content">
<div class="modal-header"><h5>OTP Verification</h5></div>
<div class="modal-body">
<input id="otpInput" class="form-control" placeholder="Enter OTP">
</div>
<div class="modal-footer">
<button class="btn btn-primary" onclick="confirmOtp()">Verify</button>
</div>
</div>
</div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<script>
/* ================= CONFIG ================= */
const API="https://script.google.com/macros/s/AKfycbyq6XkcxsOOwh4RGBPg60r2SAs-CDQcB9DaWDZZ7gSLQygtEgE345oGhIjKKFP9xeBqgg/exec";

/* ================= GLOBAL ================= */
let headers=[], members=[];
let edit=false;
let currentMemberID=null;
let otpCallback=null;

const modal = new bootstrap.Modal(document.getElementById("memberModal"));
const otpModalObj = new bootstrap.Modal(document.getElementById("otpModal"));

/* ================= LOGIN ================= */
function login(){
fetch(API,{
method:"POST",
body:JSON.stringify({action:"login",user:user.value,pass:pass.value})
})
.then(r=>r.json())
.then(d=>{
if(!d.ok) return alert("Login failed");
loginBox.classList.add("hidden");
app.classList.remove("hidden");
load();
});
}

/* ================= LOAD ================= */
function load(){
fetch(API)
.then(r=>r.json())
.then(d=>{
members=d;
headers=Object.keys(d[0]);
buildTable();
draw();
buildForm();
});
}

/* ================= TABLE ================= */
function buildTable(){
thead.innerHTML="";
headers.forEach(h=>thead.innerHTML+=`<th>${h}</th>`);
thead.innerHTML+=`<th>Action</th>`;
}

function draw(){
tbody.innerHTML="";
members.forEach(m=>{
let tr="<tr>";
headers.forEach(h=>{
tr+=h.toLowerCase().includes("photo")
? `<td>${m[h]?`<img src="${m[h]}" class="thumb">`:""}</td>`
: `<td>${m[h]||""}</td>`;
});
tr+=`<td>
<button class="btn btn-sm btn-warning me-1" onclick='editM(${JSON.stringify(m)})'>Edit</button>
<button class="btn btn-sm btn-danger" onclick='delMember("${m.MemberID}")'>Del</button>
</td></tr>`;
tbody.innerHTML+=tr;
});
}

/* ================= FORM ================= */
function buildForm(){
formBody.innerHTML="";
headers.forEach(h=>{
formBody.innerHTML+=`
<div class="col-6">
<label>${h}</label>
<input id="f_${h}" class="form-control">
</div>`;
});
}
const f=h=>document.getElementById("f_"+h);

/* ================= ADD ================= */
function openAdd(){
edit=false;
currentMemberID=null;
modalTitle.innerText="Add Member";
headers.forEach(h=>{
f(h).value="";
f(h).disabled=false;
});
modal.show();
}

/* ================= EDIT ================= */
function editM(m){
edit=true;
currentMemberID=m.MemberID;
modalTitle.innerText="Edit Member";

headers.forEach(h=>{
f(h).value=m[h]||"";
if(h==="MemberID") f(h).disabled=true; // ðŸ”’ lock ID
});
modal.show();
}

/* ================= SAVE ================= */
function save(){
if(!edit){
let d={action:"add"};
headers.forEach(h=>d[h]=f(h).value);
post(d);
}else{
sendOtp(currentMemberID,()=>{
let d={
action:"update",
MemberID:currentMemberID,
otp:otpInput.value
};
headers.forEach(h=>{
if(h!=="MemberID") d[h]=f(h).value;
});
post(d);
});
}
}

/* ================= DELETE ================= */
function delMember(id){
sendOtp(id,()=>{
post({action:"delete",MemberID:id,otp:otpInput.value});
});
}

/* ================= OTP ================= */
function sendOtp(id,cb){
otpCallback=cb;
fetch(API,{
method:"POST",
body:JSON.stringify({action:"sendOtp",MemberID:id})
})
.then(r=>r.json())
.then(d=>{
if(d.ok) otpModalObj.show();
else alert("OTP send failed");
});
}

function confirmOtp(){
otpModalObj.hide();
otpCallback();
}

/* ================= POST ================= */
function post(d){
fetch(API,{method:"POST",body:JSON.stringify(d)})
.then(()=>{modal.hide();load();});
}
</script>
</body>
</html>
