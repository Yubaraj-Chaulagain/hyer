<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Lucky Draw Wheel</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body{
  background:#0f172a;
  color:#fff;
  font-family:Arial;
  text-align:center;
}
h1{margin:10px 0}
#wheelBox{
  position:relative;
  width:360px;
  height:360px;
  margin:20px auto;
}
#wheel{
  width:100%;
  height:100%;
  border-radius:50%;
  border:10px solid #22c55e;
  transition:transform 4s cubic-bezier(.17,.67,.25,1);
}
#pointer{
  position:absolute;
  top:-10px;
  left:50%;
  transform:translateX(-50%);
  font-size:30px;
  color:#facc15;
}
button{
  padding:12px 24px;
  font-size:16px;
  background:#22c55e;
  border:none;
  border-radius:6px;
  cursor:pointer;
}
button:disabled{
  opacity:.5;
  cursor:not-allowed;
}
#winner{
  margin-top:20px;
  font-size:18px;
  color:#facc15;
}
</style>
</head>

<body>

<h1>üé° Lucky Draw</h1>
<div id="wheelBox">
  <div id="pointer">‚ñº</div>
  <canvas id="wheel" width="360" height="360"></canvas>
</div>

<button onclick="spinWheel()">SPIN</button>

<div id="winner"></div>

<script>
const scriptURL = "https://script.google.com/macros/s/AKfycbzV6lfOQ5pLum6H6OMFoAT6Ea2rQuytRkwt7_c6HOLBUQzE-bGEWYo-Y65VP4mP8CBVjw/exec";

const canvas = document.getElementById("wheel");
const ctx = canvas.getContext("2d");
const radius = canvas.width/2;

let members = [];
let angle = 0;
let spinning = false;

// ---------- Fetch members ----------
fetch(scriptURL,{
  method:"POST",
  body:JSON.stringify({action:"getLuckyDrawMembers"})
})
.then(r=>r.json())
.then(d=>{
  members = d;
  drawWheel();
});

// ---------- Draw Wheel ----------
function drawWheel(){
  const slice = 2*Math.PI / members.length;
  ctx.clearRect(0,0,360,360);

  members.forEach((m,i)=>{
    const start = i*slice;
    ctx.beginPath();
    ctx.moveTo(radius,radius);
    ctx.arc(radius,radius,radius,start,start+slice);
    ctx.fillStyle = i%2 ? "#2563eb" : "#16a34a";
    ctx.fill();

    ctx.save();
    ctx.translate(radius,radius);
    ctx.rotate(start + slice/2);
    ctx.fillStyle="#fff";
    ctx.font="14px Arial";
    ctx.fillText(m.name, radius/2, 5);
    ctx.restore();
  });
}

// ---------- Spin ----------
function spinWheel(){
  if(spinning || members.length===0) return;
  spinning = true;

  const extra = Math.random()*360 + 1440; // 4+ rounds
  angle += extra;

  canvas.style.transform = `rotate(${angle}deg)`;

  setTimeout(selectWinner, 4200);
}

// ---------- Winner ----------
function selectWinner(){
  const sliceDeg = 360 / members.length;
  const current = angle % 360;
  const index = Math.floor((360-current)/sliceDeg) % members.length;

  const winner = members[index];
  document.getElementById("winner").innerHTML =
    `üèÜ Winner: <b>${winner.name}</b> (ID: ${winner.memberId})`;

  saveWinner(winner);
  spinning = false;
}

// ---------- Save Winner + Email ----------
function saveWinner(w){
  fetch(scriptURL,{
    method:"POST",
    body:JSON.stringify({
      action:"saveLuckyDrawWinner",
      memberId:w.memberId,
      name:w.name,
      email:w.email
    })
  });
}
</script>

</body>
</html>
