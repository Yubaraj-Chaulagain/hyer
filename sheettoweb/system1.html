<!DOCTYPE html>
<html lang="ne">
<header class="topbar hidden" id="topbar">
  <div class="title">‡§∏‡§π‡§ï‡§æ‡§∞‡•Ä ‡§µ‡•ç‡§Ø‡§µ‡§∏‡•ç‡§•‡§æ‡§™‡§® ‡§™‡•ç‡§∞‡§£‡§æ‡§≤‡•Ä</div>

  <div class="profile" onclick="toggleProfile()">
    <img id="ppTop" src="https://via.placeholder.com/40">

    <div class="dropdown" id="profileMenu">
      <div onclick="openProfile()">üë§ Profile</div>
      <div onclick="show('pwBox')">üîë Change Password</div>
      <div onclick="logout()">üö™ Logout</div>
    </div>
  </div>
</header>


  <style>
.hidden{
  display:none !important;
}
</style>
  <style>
  /* MEMBER LOGIN ‡§π‡•Å‡§Å‡§¶‡§æ hide */
.member-role .admin,
.member-role .staff{
  display:none !important;
}
</style>
  <style>
  .topbar{
  display:flex;
  justify-content:space-between;
  align-items:center;
  background:#0d6efd;
  color:#fff;
  padding:10px 15px;
}

.profile{
  position:relative;
  cursor:pointer;
}

.profile img{
  width:40px;
  height:40px;
  border-radius:50%;
  border:2px solid #fff;
}

.dropdown{
  display:none;
  position:absolute;
  right:0;
  top:50px;
  background:#fff;
  color:#000;
  border-radius:6px;
  box-shadow:0 2px 8px rgba(0,0,0,.2);
  min-width:160px;
  z-index:1000;
}

.dropdown div{
  padding:10px;
  border-bottom:1px solid #eee;
}

.dropdown div:hover{
  background:#f1f1f1;
}

</style>

<body>
<header>‡§∏‡§π‡§ï‡§æ‡§∞‡•Ä ‡§µ‡•ç‡§Ø‡§µ‡§∏‡•ç‡§•‡§æ‡§™‡§® ‡§™‡•ç‡§∞‡§£‡§æ‡§≤‡•Ä</header>

<!-- LOGIN -->
<div class="container" id="loginBox">
  <div class="card">
    <h3>Login</h3>
    <input id="lu" placeholder="Username">
    <input id="lp" type="password" placeholder="Password">
    <button onclick="login()">Login</button>
  </div>
</div>


<!-- DASHBOARD -->
<div class="container hidden" id="dash">

  <!-- PROFILE -->
  <div class="card hidden" id="profileBox">
  <h3>My Profile</h3>

  <img id="bigPhoto" width="100"><br><br>

  <input type="file" id="photoFile" accept="image/*">
  <button onclick="uploadPhoto()">üì∑ Upload Photo</button>

  <div id="profileInfo"></div>
</div>

<div class="card hidden" id="pwBox">
  <h3>Change Password</h3>
  <input type="password" id="oldpw" placeholder="Old Password">
  <input type="password" id="newpw" placeholder="New Password">
  <button onclick="changePw()">Change</button>
</div>


  <!-- NAV -->
  <div class="card nav">
    <button onclick="show('memberBox')" class="admin staff">Member</button>
    <button onclick="show('txnBox')" class="admin staff">Savings / Withdraw</button>
    <button onclick="show('transferBox')" class="admin staff member">Transfer</button>
    <button onclick="show('stockBox')" class="admin staff">Stock</button>
    <button onclick="show('reportBox')" class="admin">All Transactions</button>
    <button onclick="show('myBox')" class="member">My Account</button>
  </div>

  <!-- ADD MEMBER -->
  <div class="card hidden" id="memberBox">
    <h3>‡§®‡§Ø‡§æ‡§Å ‡§∏‡§¶‡§∏‡•ç‡§Ø</h3>
    <input id="mname" placeholder="‡§®‡§æ‡§Æ">
    <input id="mphone" placeholder="‡§´‡•ã‡§®">
    <input id="memail" placeholder="Email">
    <button onclick="addMember()">Save</button>
  </div>

  <!-- SAVINGS / WITHDRAW -->
  <div class="card hidden" id="txnBox">
    <h3>Savings / Withdraw</h3>
    <input id="tmember" placeholder="Member ID">
    <input id="tamt" type="number" placeholder="Amount">
    <button onclick="savings()">Savings</button>
    <button class="danger" onclick="withdraw()">Withdraw</button>
  </div>

  <!-- TRANSFER -->
  <div class="card hidden" id="transferBox">
    <h3>Member Transfer</h3>
    <input id="from" placeholder="From Member ID">
    <input id="to" placeholder="To Member ID">
    <input id="tamt2" type="number" placeholder="Amount">
    <button onclick="transfer()">Transfer</button>
  </div>

  <!-- STOCK -->
  <div class="card hidden" id="stockBox">
    <h3>Stock Sell</h3>
    <input id="sid" placeholder="Item ID">
    <input id="smember" placeholder="Member ID">
    <input id="sqty" type="number" placeholder="Qty">
    <button onclick="sellStock()">Sell</button>
  </div>

  <!-- MEMBER SELF -->
  <div class="card hidden" id="myBox">
  <h3>‡§Æ‡•á‡§∞‡•ã ‡§µ‡§ø‡§µ‡§∞‡§£</h3>

  <label>‡§®‡§æ‡§Æ</label>
  <input id="myName">

  <label>‡§´‡•ã‡§®</label>
  <input id="myPhone">

  <label>Email</label>
  <input id="myEmail">

  <button onclick="updateMyProfile()">üíæ Save</button>

  <hr>

  <h4>‡§Æ‡•á‡§∞‡•ã ‡§ï‡§æ‡§∞‡•ã‡§¨‡§æ‡§∞</h4>
  <table id="myTx"></table>
</div>


  <!-- ADMIN REPORT -->
   <div class="card" id="chartBox">
  <h3>Dashboard Summary</h3>
  <canvas id="txChart"></canvas>
  <canvas id="loanChart"></canvas>
</div>
  <div class="card hidden" id="reportBox">
    <h3>All Transactions</h3>
    <table id="allTx"></table>
  </div>

</div>
 


<script>
/******** CONFIG ********/
const IMGBB_KEY = "f5d95811959fdcd59c8ea459aadb650b";
const API = "https://script.google.com/macros/s/AKfycbwRWNEouISN_7TvdwnH9C1kKCwnFtbh_ytkK1WoLaaStlNkd_zYlP7BfC2uUt8pB1ys9Q/exec";
const KEY = "sarojkumar643";

/******** LOGIN ********/
function login(){
 fetch(API,{
  method:"POST",
  body:JSON.stringify({
    apiKey:KEY,
    action:"login",
    username:lu.value,
    password:lp.value,
    agent:navigator.userAgent,
    ip:"WEB"
  })
 }).then(r=>r.json()).then(j=>{
  if(!j.success) return alert(j.error);

  sessionStorage.setItem("user", j.username);
  sessionStorage.setItem("role", j.role);
  sessionStorage.setItem("mid", j.member_id || "");
  sessionStorage.setItem("photo", j.photo || "");

  // üîë UI show
  loginBox.classList.add("hidden");
  dash.classList.remove("hidden");
  topbar.classList.remove("hidden");

  // üñºÔ∏è Photo sync
  document.getElementById("ppTop").src  = j.photo || "https://via.placeholder.com/40";
  document.getElementById("bigPhoto").src = j.photo || "";
  document.querySelector(".nav").classList.remove("hidden");

roleUI(j.role);
  loadCharts();
 });
}


/******** ROLE UI ********/
function roleUI(role){
  document.body.classList.remove("admin-role","staff-role","member-role");

  if(role === "admin") document.body.classList.add("admin-role");
  if(role === "staff") document.body.classList.add("staff-role");
  if(role === "member") document.body.classList.add("member-role");
}


/******** NAV ********/
function show(id){
 document.querySelectorAll("#dash .card").forEach(c=>{
  if(c.id && c.id!=="") c.classList.add("hidden");
 });
 document.getElementById(id).classList.remove("hidden");

 if(id=="myBox") loadMy();
 if(id=="reportBox") loadAllTx();
 if(id==="profileBox") loadProfile();

}

/******** API HELPERS ********/
function post(o){
 return fetch(API,{method:"POST",body:JSON.stringify(o)})
  .then(r=>r.json());
}

/******** ACTIONS ********/
function addMember(){
 post({apiKey:KEY,action:"addMember",
  name:mname.value,phone:mphone.value,email:memail.value
 }).then(()=>alert("Saved"));
}

function savings(){
 post({apiKey:KEY,action:"savings",
  member:tmember.value,amount:+tamt.value,
  by:sessionStorage.getItem("user")
 }).then(r=>alert(r.success?"Done":r.error));
}

function withdraw(){
 post({apiKey:KEY,action:"withdraw",
  member:tmember.value,amount:+tamt.value,
  by:sessionStorage.getItem("user")
 }).then(r=>alert(r.success?"Done":r.error));
}

function transfer(){
 post({apiKey:KEY,action:"transfer",
  from:from.value,to:to.value,
  amount:+tamt2.value,
  by:sessionStorage.getItem("user")
 }).then(r=>alert(r.success?"Done":r.error));
}

function sellStock(){
 post({apiKey:KEY,action:"sellStock",
  item:sid.value,member:smember.value,
  qty:+sqty.value,by:sessionStorage.getItem("user")
 }).then(r=>alert(r.success?"Sold":r.error));
}

/******** MEMBER VIEW ********/
function loadMy(){

  // üîπ bio load
  post({
    apiKey:KEY,
    action:"getMember",
    member:sessionStorage.getItem("mid")
  }).then(m=>{
    myName.value  = m.name;
    myPhone.value = m.phone;
    myEmail.value = m.email;
  });

  // üîπ transaction load
  post({
    apiKey:KEY,
    action:"memberTx",
    member:sessionStorage.getItem("mid")
  }).then(d=>{
    let h="<tr><th>Date</th><th>Type</th><th>Amt</th></tr>";
    d.slice(1).forEach(r=>{
      h+=`<tr>
        <td>${new Date(r[1]).toLocaleDateString()}</td>
        <td>${r[2]}</td>
        <td>${r[5]}</td>
      </tr>`;
    });
    myTx.innerHTML=h;
  });
}

  function updateMyProfile(){
  post({
    apiKey:KEY,
    action:"updateMember",
    member:sessionStorage.getItem("mid"),
    name:myName.value,
    phone:myPhone.value,
    email:myEmail.value
  }).then(r=>{
    alert(r.success ? "Profile Update ‡§≠‡§Ø‡•ã" : r.error);
  });
}

/******** ADMIN REPORT ********/
function loadAllTx(){
 post({apiKey:KEY,action:"allTx"})
 .then(d=>{
  let h="<tr><th>Date</th><th>Type</th><th>From</th><th>To</th><th>Amt</th></tr>";
  d.slice(1).forEach(r=>{
    h+=`<tr><td>${new Date(r[1]).toLocaleDateString()}</td><td>${r[2]}</td><td>${r[3]}</td><td>${r[4]}</td><td>${r[5]}</td></tr>`;
  });
  allTx.innerHTML=h;
 });
}

/******** LOGOUT ********/
function logout(){
 post({apiKey:KEY,action:"logout",
  username:sessionStorage.getItem("user")
 }).then(()=>{
  sessionStorage.clear();
  location.reload();
   topbar.classList.add("hidden");
dash.classList.add("hidden");
loginBox.classList.remove("hidden");

 });
}

  function loadCharts(){
 post({apiKey:KEY,action:"allTx"}).then(d=>{
  let sav=0,wit=0,trs=0;
  d.slice(1).forEach(r=>{
    if(r[2]=="SAVINGS") sav+=+r[5];
    if(r[2]=="WITHDRAW") wit+=+r[5];
    if(r[2]=="TRANSFER") trs+=+r[5];
  });

  new Chart(txChart,{
    type:"pie",
    data:{
      labels:["Savings","Withdraw","Transfer"],
      datasets:[{data:[sav,wit,trs]}]
    }
  });
 });

 fetch(API,{method:"POST",body:JSON.stringify({
  apiKey:KEY,action:"memberLoan",
  member:sessionStorage.getItem("mid")
 })}).then(r=>r.json()).then(d=>{
  let labels=[],bal=[];
  d.schedule.slice(1).forEach(r=>{
    labels.push("M"+r[1]);
    bal.push(r[6]);
  });

  new Chart(loanChart,{
    type:"line",
    data:{
      labels:labels,
      datasets:[{label:"Loan Balance",data:bal,fill:false}]
    }
  });
 });
}
  function changePw(){
  post({
    apiKey:KEY,
    action:"changePassword",
    username:sessionStorage.getItem("user"),
    oldPassword:oldpw.value,
    newPassword:newpw.value
  }).then(r=>{
    if(r.success){
      alert("Password changed successfully");
      oldpw.value="";
      newpw.value="";
    }else{
      alert(r.error);
    }
  });
}

  function toggleProfile(){
  profileMenu.style.display =
    profileMenu.style.display === "block" ? "none" : "block";
}

document.addEventListener("click",e=>{
  if(!e.target.closest(".profile")){
    profileMenu.style.display="none";
  }
});

  function loadProfile(){
  bigPhoto.src = sessionStorage.getItem("photo") || "";
  profileInfo.innerHTML = `
    <b>${sessionStorage.getItem("user")}</b><br>
    Role: ${sessionStorage.getItem("role")}<br>
    Member ID: ${sessionStorage.getItem("mid")}
  `;
}
function updatePhoto(){
  const url = newPhoto.value;

  post({
    apiKey:KEY,
    action:"updatePhoto",
    username:sessionStorage.getItem("user"),
    photo:url
  }).then(r=>{
    if(r.success){
      alert("Photo updated");

      // ‚úÖ session update
      sessionStorage.setItem("photo", url);

      // ‚úÖ top bar photo
      document.getElementById("ppTop").src = url;

      // ‚úÖ profile big photo
      document.getElementById("bigPhoto").src = url;

    }else{
      alert(r.error);
    }
  });
}

function uploadPhoto(){
  const file = document.getElementById("photoFile").files[0];
  if(!file) return alert("‡§´‡•ã‡§ü‡•ã ‡§õ‡§æ‡§®‡•ç‡§®‡•Å‡§π‡•ã‡§∏‡•ç");

  const fd = new FormData();
  fd.append("image", file);

  fetch(`https://api.imgbb.com/1/upload?key=${IMGBB_KEY}`,{
    method:"POST",
    body:fd
  })
  .then(r=>r.json())
  .then(res=>{
    if(!res.success) return alert("Upload ‡§Ö‡§∏‡§´‡§≤");

    const photoUrl = res.data.url;
    updatePhotoToSystem(photoUrl);
  });
}
function updatePhotoToSystem(url){
  post({
    apiKey:KEY,
    action:"updatePhoto",
    username:sessionStorage.getItem("user"),
    photo:url
  }).then(r=>{
    if(r.success){

      sessionStorage.setItem("photo", url);

      // üîù Top bar
      document.getElementById("ppTop").src = url;


      // üë§ Profile page
      document.getElementById("bigPhoto").src = url;

      alert("Photo ‡§∏‡§´‡§≤‡§§‡§æ‡§™‡•Ç‡§∞‡•ç‡§µ‡§ï update ‡§≠‡§Ø‡•ã");
    }else{
      alert(r.error);
    }
  });
}

  function openProfile(){
  // ‡§∏‡§¨‡•à dashboard card hide
  document.querySelectorAll("#dash .card").forEach(c=>{
    c.classList.add("hidden");
  });

  // profile ‡§Æ‡§æ‡§§‡•ç‡§∞ show
  document.getElementById("profileBox").classList.remove("hidden");
  loadProfile();
}



  if(!sessionStorage.getItem("user")){
  topbar.classList.add("hidden");
  dash.classList.add("hidden");
  loginBox.classList.remove("hidden");
}


</script>
  <script>
/******** INITIAL UI STATE ********/
window.onload = function(){

  // login ‡§õ‡•à‡§® ‡§≠‡§®‡•á
  if(!sessionStorage.getItem("user")){

    // topbar hide
    document.getElementById("topbar").classList.add("hidden");

    // dashboard hide
    document.getElementById("dash").classList.add("hidden");

    // login box show
    document.getElementById("loginBox").classList.remove("hidden");

    // dashboard ‡§≠‡§ø‡§§‡•ç‡§∞‡§ï‡§æ ‡§∏‡§¨‡•à card hide
    document.querySelectorAll("#dash .card").forEach(c=>{
      c.classList.add("hidden");
    });
  }
}
</script>

</body>
</html>
