<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Billing System</title>
<link href="https://cdn.jsdelivr.net/npm/tom-select/dist/css/tom-select.bootstrap5.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/tom-select/dist/js/tom-select.complete.min.js"></script>
<style>
  #billingSystem { display:none; } /* Initially hidden */
  table { width:100%; border-collapse:collapse; margin-top:10px; }
  td,th { border:1px solid #aaa; padding:5px; }
  input[type=number] { width:80px; }
</style>
</head>
<body onload="init()">
<div class="tab-buttons">
  <button onclick="showTab('billing')">üßæ Billing</button>
  <button onclick="showTab('list')">üìú Bills List</button>
</div>
  <div id="billing" class="tab active">
<h3>üßæ Select Member to Start Billing</h3>
<select id="member" onchange="onMemberSelect()"></select>

<div id="billingSystem">
<h3>üßæ Billing System</h3>
<label>Bill No: <span id="billNoDisplay"></span></label><br><br>

<input type="text" id="customMember" placeholder="Enter Customer Name" style="display:none">

<button onclick="addRow()">+ Add Row</button>

<table id="bill">
<tr>
<th>S.N</th><th>Description</th><th>Qty</th>
<th>Rate</th><th>Total</th>
</tr>
</table>

<h4>
SubTotal: <span id="sub">0</span><br>
GST (%): <input type="number" id="gstManual" value="13" style="width:50px" oninput="calc()"><br>
Grand Total: <span id="gt">0</span>
</h4>

<button onclick="saveBill()">üíæ Save Bill</button>
<button onclick="window.print()">üñ®Ô∏è Print</button>
</div>
    </div>

<script>
const URL = "https://script.google.com/macros/s/AKfycbyxZSIZk5x-o_wUnwJ5i9WA22DSM1odnwwOKzKpDIruavs3V9xc9AwKUpf93ZtfWpNU/exec";
let sn = 0;
let editingBillNo = null;

// ------------------ INIT -------------------
function init() {
    loadMembers();
    newBillNo();
}

// ------------------ LOAD MEMBERS ----------------
const memberSelect = new TomSelect("#member", {
    valueField: "MemberID",
    labelField: "Name",
    searchField: ["MemberID", "Name"],
    options: [],
    create: false,
    placeholder: "Select or type member...",
});

function loadMembers() {
    fetch(URL, {
        method: "POST",
        body: JSON.stringify({ action: "getMembers" })
    })
    .then(r => r.json())
    .then(data => {
        memberSelect.clearOptions();
        memberSelect.addOptions(data);
        memberSelect.addOption({ MemberID: "guest", Name: "Other / Guest Customer" });
    });
}

// ------------------ ON MEMBER SELECT ----------------
function onMemberSelect() {
    const selectedID = memberSelect.getValue();
    if(!selectedID) {
        document.getElementById("billingSystem").style.display = "none";
    } else {
        document.getElementById("billingSystem").style.display = "block";
        toggleCustomMember(selectedID);
    }
}

// ------------------ TOGGLE CUSTOM MEMBER ----------------
function toggleCustomMember(val){
    const input = document.getElementById("customMember");
    if(val==="guest"){ input.style.display="inline-block"; }
    else{ input.style.display="none"; input.value=""; }
}

// ------------------ ADD ROW ----------------
function addRow() {
  sn++;
  const t = document.getElementById("bill");
  const r = t.insertRow();
  r.innerHTML = `
    <td>${sn}</td>
    <td><input></td>
    <td><input type="number" oninput="calc()"></td>
    <td><input type="number" oninput="calc()"></td>
    <td class="tot">0</td>`;
}

// ------------------ CALC ------------------
function calc() {
  let sub = 0;
  document.querySelectorAll("#bill tr").forEach((r,i)=>{
    if(i==0) return;
    const q = parseFloat(r.cells[2].children[0].value) || 0;
    const rate = parseFloat(r.cells[3].children[0].value) || 0;
    const t = q * rate;
    r.cells[4].innerText = t.toFixed(2);
    sub += t;
  });
  document.getElementById("sub").innerText = sub.toFixed(2);
  const gstPercent = parseFloat(document.getElementById("gstManual").value) || 0;
  const gstAmount = sub * gstPercent / 100;
  document.getElementById("gt").innerText = (sub + gstAmount).toFixed(2);
}

// ------------------ SAVE BILL ----------------
function saveBill() {
  let items = [];
  document.querySelectorAll("#bill tr").forEach((r,i)=>{
    if(i==0) return;
    const desc = r.cells[1].children[0].value;
    const qty = r.cells[2].children[0].value;
    const rate = r.cells[3].children[0].value;
    const total = r.cells[4].innerText;
    if(desc && qty && rate) items.push({desc, qty, rate, total});
  });
  if(items.length===0){ alert("At least one item required"); return; }

  const selectedMember = memberSelect.getValue();
  const memberName = selectedMember === "guest" ? document.getElementById("customMember").value : selectedMember;
  if(!memberName){ alert("Enter member or customer name"); return; }

  const billNo = editingBillNo || generateBillNo(selectedMember);
  document.getElementById("billNoDisplay").innerText = billNo;

  const gstPercent = parseFloat(document.getElementById("gstManual").value||0);

  const payload = {
    action: editingBillNo ? "updateBill" : "saveBill",
    billNo: billNo,
    member: memberName,
    subtotal: document.getElementById("sub").innerText,
    gst: gstPercent,
    total: document.getElementById("gt").innerText,
    items: items
  };

  fetch(URL,{
    method:"POST",
    body: JSON.stringify(payload)
  })
  .then(r=>r.json())
  .then(res=>{
    alert(editingBillNo ? "‚úÖ Bill Updated" : `‚úÖ Bill Saved - ${billNo}`);
    editingBillNo = null;
    resetBillForm();
  })
  .catch(err=>{ alert("‚ùå Save failed"); console.error(err); });
}

// ------------------ RESET ----------------
function resetBillForm(){
  document.getElementById("bill").innerHTML = `<tr><th>S.N</th><th>Description</th><th>Qty</th><th>Rate</th><th>Total</th></tr>`;
  sn = 0;
  memberSelect.clear();
  document.getElementById("customMember").value = "";
  document.getElementById("sub").innerText = 0;
  document.getElementById("gstManual").value = 13;
  document.getElementById("gt").innerText = 0;
  document.getElementById("billingSystem").style.display = "none";
}

function generateBillNo(memberId){
  const ts = Date.now();
  return memberId==="guest" ? `CUSTXT${ts}` : `TXN${ts}`;
}

function newBillNo(){
  document.getElementById("billNoDisplay").innerText = generateBillNo('');
}
</script>
</body>
</html>
