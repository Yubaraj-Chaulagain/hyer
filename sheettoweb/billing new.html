<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Billing System</title>
<link href="https://cdn.jsdelivr.net/npm/tom-select/dist/css/tom-select.bootstrap5.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/tom-select/dist/js/tom-select.complete.min.js"></script>
<style>
  body { font-family: Arial, sans-serif; padding: 10px; }
  .tab { display:none; }
  .tab-buttons button { margin-right:5px; padding:5px 10px; }
  table { width:100%; border-collapse:collapse; margin-top:10px; }
  td, th { border:1px solid #aaa; padding:5px; text-align:center; }
  input[type=number] { width:80px; }
</style>
</head>
<body onload="init()">

<div class="tab-buttons">
  <button onclick="showTab('billingTab')">üßæ Billing</button>
  <button onclick="showTab('listTab')">üìú Bills List</button>
</div>

<!-- Billing Tab -->
<div id="billingTab" class="tab">
  <h3>üßæ Select Member to Start Billing</h3>
  <select id="member"></select>
  <input type="text" id="customMember" placeholder="Enter Customer Name" style="display:none; margin-left:5px;">

  <div id="billingSystem" style="display:none; margin-top:20px;">
    <h3>üßæ Billing System</h3>
    <label>Bill No: <span id="billNoDisplay"></span></label><br><br>

    <button onclick="addRow()">+ Add Row</button>

    <table id="bill">
      <tr>
        <th>S.N</th><th>Description</th><th>Qty</th><th>Rate</th><th>Total</th>
      </tr>
    </table>

    <h4>
      SubTotal: <span id="sub">0</span><br>
      GST (%): <input type="number" id="gstManual" value="13" style="width:50px" oninput="calc()"><br>
      Grand Total: <span id="gt">0</span>
    </h4>

    <button onclick="saveBill()">üíæ Save Bill</button>
    <button onclick="window.print()">üñ®Ô∏è Print</button>
  </div>
</div>

<!-- Bills List Tab -->
<div id="listTab" class="tab">
  <hr>
  <input id="search" placeholder="Search MemberID or Bill No">
  <button onclick="searchBill()">Search</button>

  <h3>üìú Bills List</h3>
  <table id="billList">
    <tr>
      <th>Bill No</th>
      <th>Member</th>
      <th>Total</th>
      <th>Action</th>
    </tr>
  </table>
</div>

<script>
const URL = "https://script.google.com/macros/s/AKfycbwF69NmDQqNAL_GiiaGa7U4icfSzMZFYbEuhfiIeYLKhNnPGy8tcjHeAPTKeKZgKH6Ojg/exec";
let sn = 0;
let editingBillNo = null;

// ---------------- INIT ----------------
function init() {
    showTab('billingTab'); // Initially show billing tab
    loadMembers();
    newBillNo();
}

// ---------------- Tabs ----------------
function showTab(tab){
  document.querySelectorAll('.tab').forEach(d => d.style.display='none');
  document.getElementById(tab).style.display = 'block';
  if(tab==='billingTab') document.getElementById("billingSystem").style.display = 'none';
}

// ---------------- TomSelect Member ----------------
const memberSelect = new TomSelect("#member", {
    valueField: "MemberID",
    labelField: "Name",
    searchField: ["MemberID","Name"],
    options: [],
    create: false,
    placeholder: "Select or type member..."
});

// ---------------- Load Members ----------------
function loadMembers() {
    fetch(URL, { method:"POST", body: JSON.stringify({ action:"getMembers" }) })
    .then(r=>r.json())
    .then(data=>{
        memberSelect.clearOptions();
        memberSelect.addOptions(data);
        memberSelect.addOption({ MemberID:"guest", Name:"Other / Guest Customer" });
    });
}

// ---------------- On Member Select ----------------
memberSelect.on('change', function(value){
    if(!value) {
        document.getElementById("billingSystem").style.display="none";
    } else {
        document.getElementById("billingSystem").style.display="block";
        toggleCustomMember(value);
    }
});

// ---------------- Toggle Guest Input ----------------
function toggleCustomMember(val){
    const input = document.getElementById("customMember");
    if(val==="guest"){ input.style.display="inline-block"; }
    else{ input.style.display="none"; input.value=""; }
}

// ---------------- Add Row ----------------
function addRow() {
  sn++;
  const t = document.getElementById("bill");
  const r = t.insertRow();
  r.innerHTML = `
    <td>${sn}</td>
    <td><input></td>
    <td><input type="number" oninput="calc()"></td>
    <td><input type="number" oninput="calc()"></td>
    <td class="tot">0</td>`;
}

// ---------------- Calc ----------------
function calc() {
  let sub = 0;
  document.querySelectorAll("#bill tr").forEach((r,i)=>{
    if(i===0) return;
    const q = parseFloat(r.cells[2].children[0].value) || 0;
    const rate = parseFloat(r.cells[3].children[0].value) || 0;
    const t = q*rate;
    r.cells[4].innerText = t.toFixed(2);
    sub += t;
  });
  document.getElementById("sub").innerText = sub.toFixed(2);
  const gstPercent = parseFloat(document.getElementById("gstManual").value) || 0;
  document.getElementById("gt").innerText = (sub + sub*gstPercent/100).toFixed(2);
}

// ---------------- Save Bill ----------------
function saveBill() {
  let items = [];
  document.querySelectorAll("#bill tr").forEach((r,i)=>{
    if(i===0) return;
    const desc = r.cells[1].children[0].value;
    const qty = r.cells[2].children[0].value;
    const rate = r.cells[3].children[0].value;
    const total = r.cells[4].innerText;
    if(desc && qty && rate) items.push({desc, qty, rate, total});
  });
  if(items.length===0){ alert("Add at least one item"); return; }

  const selectedMember = memberSelect.getValue();
  const memberName = selectedMember==="guest" ? document.getElementById("customMember").value : selectedMember;
  if(!memberName){ alert("Enter member name"); return; }

  const billNo = editingBillNo || generateBillNo(selectedMember);
  document.getElementById("billNoDisplay").innerText = billNo;

  const gstPercent = parseFloat(document.getElementById("gstManual").value||0);
const payload = {
  action: editingBillNo ? "updateBill" : "saveBill",
  billNo, 
  bill: {
    BillNo: billNo,
    Date: new Date().toISOString().slice(0,10),
    MemberID: memberName,
    SubTotal: document.getElementById("sub").innerText,
    GST: gstPercent,
    GrandTotal: document.getElementById("gt").innerText
  },
  items
};


  fetch(URL,{ method:"POST", body: JSON.stringify(payload) })
    .then(r=>r.json())
    .then(res=>{
      alert(editingBillNo ? "‚úÖ Bill Updated" : `‚úÖ Bill Saved - ${billNo}`);
      editingBillNo=null;
      resetBillForm();
    }).catch(err=>{ alert("‚ùå Save failed"); console.error(err); });
}

// ---------------- Reset Bill ----------------
function resetBillForm(){
  document.getElementById("bill").innerHTML=`<tr>
    <th>S.N</th><th>Description</th><th>Qty</th><th>Rate</th><th>Total</th>
  </tr>`;
  sn=0;
  memberSelect.clear();
  document.getElementById("customMember").value="";
  document.getElementById("sub").innerText=0;
  document.getElementById("gstManual").value=13;
  document.getElementById("gt").innerText=0;
  document.getElementById("billingSystem").style.display="none";
  loadMembers();
  newBillNo();
}

// ---------------- Generate Bill No ----------------
function generateBillNo(memberId){
  const ts = Date.now();
  return memberId==="guest"?`CUSTXT${ts}`:`TXN${ts}`;
}
function newBillNo(){
  document.getElementById("billNoDisplay").innerText = generateBillNo('');
}

// ---------------- Search Bill ----------------
function searchBill() {
  const q = document.getElementById("search").value.trim();
  fetch(URL,{ method:"POST", body:JSON.stringify({ action:"searchBill", member:q }) })
  .then(r=>r.json())
  .then(list=>{
    const t = document.getElementById("billList");
    t.innerHTML = `<tr>
      <th>Bill No</th><th>Member</th><th>Total</th><th>Action</th>
    </tr>`;
    list.forEach(b=>{
      const r = t.insertRow();
      r.innerHTML=`<td>${b.BillNo}</td>
                     <td>${b.MemberID}</td>
                     <td>${b.GrandTotal}</td>
                     <td>
                       <button onclick="editBill('${b.BillNo}')">‚úèÔ∏è Edit</button>
                       <button onclick="deleteBill('${b.BillNo}')">‚ùå Delete</button>
                     </td>`;
    });
  });
}

// ---------------- Edit Bill ----------------
function editBill(billNo){
  fetch(URL,{
    method:"POST",
    body: JSON.stringify({ action:"getBill", billNo })
  })
  .then(r => r.json())
  .then(d => {
    if(!d.status || !d.items){ 
      alert("Bill load failed"); 
      return; 
    }

    // 1Ô∏è‚É£ Switch to billing tab
    showTab('billingTab');
    document.getElementById("billingSystem").style.display = "block";

    // 2Ô∏è‚É£ Fill BillNo
    document.getElementById("billNoDisplay").innerText = d.BillNo;
    editingBillNo = d.BillNo;

    // 3Ô∏è‚É£ Set Member
    memberSelect.setValue(d.MemberID);
    if(d.MemberID==="guest"){
      document.getElementById("customMember").value = d.MemberID; 
      document.getElementById("customMember").style.display = "inline-block";
    }

    // 4Ô∏è‚É£ Clear Table
    const t = document.getElementById("bill");
    t.innerHTML = `<tr>
      <th>S.N</th><th>Description</th><th>Qty</th><th>Rate</th><th>Total</th>
    </tr>`;
    sn = 0;

    // 5Ô∏è‚É£ Fill Items
    d.items.forEach(it => {
      addRow(); // adds new row and increments sn
      const rows = document.querySelectorAll("#bill tr");
      const r = rows[rows.length-1]; // last row
      r.cells[1].children[0].value = it.desc;
      r.cells[2].children[0].value = it.qty;
      r.cells[3].children[0].value = it.rate;
      r.cells[4].innerText = it.total;
    });

    // 6Ô∏è‚É£ Set GST & calculate totals
    document.getElementById("gstManual").value = d.GST || 13;
    calc(); // recalc totals
  });
}

// ---------------- Delete Bill ----------------
function deleteBill(billNo){
  if(!confirm("Delete this bill?")) return;
  fetch(URL,{
    method:"POST",
    body: JSON.stringify({ action:"deleteBill", billNo })
  })
  .then(r=>r.json())
  .then(res=>{
    if(res.status){
      alert("‚úÖ Bill deleted");
      searchBill();
    } else {
      alert("‚ùå Delete failed: " + (res.message || ""));
    }
  });
}

</script>
</body>
</html>
