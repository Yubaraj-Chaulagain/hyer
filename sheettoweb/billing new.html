<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Billing System</title>
<style>
  .tab { display:none; }
  .tab.active { display:block; }
  table { width:100%; border-collapse:collapse }
  td,th { border:1px solid #aaa; padding:5px }
  .tab-buttons button { margin-right:5px; padding:5px 10px; }
  input[type=number] { width:80px; }
  #memberDropdown {
    border:1px solid #aaa; 
    max-height:150px; 
    overflow-y:auto; 
    display:none; 
    position:absolute; 
    background:#fff; 
    z-index:10;
  }
  #memberDropdown div:hover, #memberDropdown .selected { background:#def; }
</style>
</head>
<body onload="init()">

<div class="tab-buttons">
  <button onclick="showTab('billing')">üßæ Billing</button>
  <button onclick="showTab('list')">üìú Bills List</button>
</div>

<div id="billing" class="tab active">
<h3>üßæ Billing System</h3>
<label>Bill No: <span id="billNoDisplay"></span></label><br><br>

<input type="text" id="memberSearch" placeholder="Select Member or type..." 
       oninput="filterMembers()" onkeydown="memberKeyNav(event)">
<div id="memberDropdown"></div>
<input type="hidden" id="member">
<input type="text" id="customMember" placeholder="Enter Customer Name" style="display:none">

<button onclick="addRow()">+ Add Row</button>

<table id="bill">
<tr>
<th>S.N</th><th>Description</th><th>Qty</th>
<th>Rate</th><th>Total</th>
</tr>
</table>

<h4>
SubTotal: <span id="sub">0</span><br>
GST (%): <input type="number" id="gstManual" value="13" style="width:50px" oninput="calc()"><br>
Grand Total: <span id="gt">0</span>
</h4>

<button onclick="saveBill()">üíæ Save Bill</button>
<button onclick="window.print()">üñ®Ô∏è Print</button>
</div>

<div id="list" class="tab">
<hr>
<input id="search" placeholder="Search MemberID or Bill No">
<button onclick="searchBill()">Search</button>

<h3>üìú Bills List</h3>
<table id="billList">
<tr>
  <th>Bill No</th>
  <th>Member</th>
  <th>Total</th>
  <th>Action</th>
</tr>
</table>
</div>

<script>
const URL = "YOUR_GOOGLE_SCRIPT_URL";
let sn = 0;
let editingBillNo = null;
let members = [];
let filteredMembers = [];
let selectedIndex = -1;

// ---------------- INIT ----------------
function init() {
  loadMembers();
  newBillNo();
}

// ---------------- LOAD MEMBERS ----------------
function loadMembers() {
  fetch(URL,{method:"POST",body:JSON.stringify({action:"getMembers"})})
  .then(r=>r.json())
  .then(data=>{
    members = data;
    members.push({MemberID:"guest", Name:"Other / Guest Customer"});
  });
}

// ---------------- FILTER MEMBERS ----------------
function filterMembers() {
  const input = document.getElementById("memberSearch");
  const dropdown = document.getElementById("memberDropdown");
  const val = input.value.toLowerCase();
  dropdown.innerHTML = "";
  selectedIndex = -1;
  if(!val){ dropdown.style.display="none"; return; }

  filteredMembers = members.filter(m=>{
    return (m.MemberID.toLowerCase().includes(val) || (m.Name||'').toLowerCase().includes(val));
  });

  filteredMembers.forEach((m,i)=>{
    const div = document.createElement("div");
    div.style.padding="5px";
    div.style.cursor="pointer";
    div.innerText = `${m.MemberID} - ${m.Name||''}`;
    div.dataset.index = i;
    div.onclick = ()=>selectMember(i);
    dropdown.appendChild(div);
  });

  dropdown.style.display = filteredMembers.length ? "block" : "none";
}

// ---------------- KEYBOARD NAV ----------------
function memberKeyNav(e){
  const dropdown = document.getElementById("memberDropdown");
  const items = dropdown.querySelectorAll("div");
  if(!items.length) return;

  if(e.key === "ArrowDown") {
    e.preventDefault();
    if(selectedIndex<items.length-1){ selectedIndex++; }
    updateHighlight(items);
  } else if(e.key==="ArrowUp") {
    e.preventDefault();
    if(selectedIndex>0){ selectedIndex--; }
    updateHighlight(items);
  } else if(e.key==="Enter") {
    e.preventDefault();
    if(selectedIndex>=0){ selectMember(selectedIndex); }
  }
}

function updateHighlight(items){
  items.forEach((it,i)=>{
    it.classList.toggle("selected", i===selectedIndex);
  });
}

function selectMember(index){
  const m = filteredMembers[index];
  document.getElementById("memberSearch").value = `${m.MemberID} - ${m.Name||''}`;
  document.getElementById("member").value = m.MemberID;
  toggleCustomMember(m.MemberID);
  document.getElementById("memberDropdown").style.display="none";
}

// ---------------- SHOW/HIDE CUSTOM MEMBER ----------------
function toggleCustomMember(val){
  const input = document.getElementById("customMember");
  if(val==="guest"){ input.style.display="inline-block"; }
  else{ input.style.display="none"; input.value=""; }
}

// ---------------- BILL ROW & CALC ----------------
function addRow() {
  sn++;
  const t = document.getElementById("bill");
  const r = t.insertRow();
  r.innerHTML = `<td>${sn}</td>
                 <td><input></td>
                 <td><input type="number" oninput="calc()"></td>
                 <td><input type="number" oninput="calc()"></td>
                 <td class="tot">0</td>`;
}

function calc() {
  let sub=0;
  document.querySelectorAll("#bill tr").forEach((r,i)=>{
    if(i==0) return;
    const q = parseFloat(r.cells[2].children[0].value)||0;
    const rate = parseFloat(r.cells[3].children[0].value)||0;
    const t = q*rate;
    r.cells[4].innerText = t.toFixed(2);
    sub += t;
  });
  document.getElementById("sub").innerText = sub.toFixed(2);
  const gstPercent = parseFloat(document.getElementById("gstManual").value)||0;
  const gstAmount = sub * gstPercent / 100;
  document.getElementById("gt").innerText = (sub + gstAmount).toFixed(2);
}

// ---------------- BILL SAVE ----------------
function saveBill() {
  let items = [];
  document.querySelectorAll("#bill tr").forEach((r,i)=>{
    if(i==0) return;
    const desc=r.cells[1].children[0].value;
    const qty=r.cells[2].children[0].value;
    const rate=r.cells[3].children[0].value;
    const total=r.cells[4].innerText;
    if(desc && qty && rate) items.push({desc, qty, rate, total});
  });
  if(items.length===0){ alert("At least one item required"); return; }

  const selectedMember = document.getElementById("member").value || "guest";
  const memberName = selectedMember==="guest"? document.getElementById("customMember").value : selectedMember;
  if(!memberName){ alert("Enter member or customer name"); return; }

  const billNo = editingBillNo || generateBillNo(selectedMember);
  document.getElementById("billNoDisplay").innerText = billNo;

  const gstPercent = parseFloat(document.getElementById("gstManual").value||0);

  const payload = {
    action: editingBillNo ? "updateBill" : "saveBill",
    billNo: billNo,
    member: memberName,
    subtotal: document.getElementById("sub").innerText,
    gst: gstPercent,
    total: document.getElementById("gt").innerText,
    items: items
  };

  fetch(URL,{method:"POST", body:JSON.stringify(payload)})
  .then(r=>r.json())
  .then(res=>{
    alert(editingBillNo ? "‚úÖ Bill Updated" : `‚úÖ Bill Saved - ${billNo}`);
    editingBillNo = null;
    showTab('list');
    searchBill();
    resetBillForm();
  })
  .catch(err=>{ alert("‚ùå Save failed"); console.error(err); });
}

// ---------------- RESET BILL ----------------
function resetBillForm(){
  document.getElementById("bill").innerHTML=`<tr><th>S.N</th><th>Description</th><th>Qty</th><th>Rate</th><th>Total</th></tr>`;
  sn=0;
  document.getElementById("memberSearch").value="";
  document.getElementById("member").value="";
  document.getElementById("customMember").value="";
  document.getElementById("sub").innerText=0;
  document.getElementById("gstManual").value=13;
  document.getElementById("gt").innerText=0;
  newBillNo();
}

// ---------------- BILL NO ----------------
function generateBillNo(memberId){ return memberId==="guest"?`CUSTXT${Date.now()}`:`TXN${Date.now()}`; }
function newBillNo(){ document.getElementById("billNoDisplay").innerText = generateBillNo(''); }

// ---------------- TAB ----------------
function showTab(tab){ document.querySelectorAll('.tab').forEach(d=>d.classList.remove('active')); document.getElementById(tab).classList.add('active'); }

// ---------------- BILL LIST ----------------
function searchBill(){
  const q=document.getElementById("search").value.trim();
  fetch(URL,{method:"POST",body:JSON.stringify({action:"searchBill", member:q})})
  .then(r=>r.json())
  .then(list=>{
    const t=document.getElementById("billList");
    t.innerHTML=`<tr><th>Bill No</th><th>Member</th><th>Total</th><th>Action</th></tr>`;
    list.forEach(b=>{
      const r=t.insertRow();
      r.innerHTML=`<td>${b.BillNo}</td><td>${b.MemberID}</td><td>${b.GrandTotal}</td>
                     <td><button onclick="editBill('${b.BillNo}')">‚úèÔ∏è Edit</button>
                         <button onclick="deleteBill('${b.BillNo}')">‚ùå Delete</button></td>`;
    });
  });
}

// ---------------- EDIT & DELETE ----------------
function editBill(billNo){
  editingBillNo=billNo;
  fetch(URL,{method:"POST",body:JSON.stringify({action:"getBill", billNo:billNo})})
  .then(r=>r.json())
  .then(d=>{
    if(!d || !d.items){ alert("Bill load failed"); return; }
    showTab('billing');
    document.getElementById("billNoDisplay").innerText=d.BillNo;
    document.getElementById("memberSearch").value=d.member;
    document.getElementById("member").value=d.member;
    toggleCustomMember(d.member);
    document.getElementById("bill").innerHTML=`<tr><th>S.N</th><th>Description</th><th>Qty</th><th>Rate</th><th>Total</th></tr>`;
    sn=0;
    d.items.forEach(it=>{ addRow(); const rows=document.querySelectorAll("#bill tr"); const r=rows[rows.length-1]; r.cells[1].children[0].value=it.desc; r.cells[2].children[0].value=it.qty; r.cells[3].children[0].value=it.rate; r.cells[4].innerText=it.total; });
    document.getElementById("gstManual").value=d.gst || 13;
    calc();
  });
}

function deleteBill(billNo){
  if(!confirm("Delete this bill?")) return;
  fetch(URL,{method:"POST",body:JSON.stringify({action:"deleteBill", billNo:billNo})})
  .then(r=>r.json())
  .then(()=>{ alert("Bill deleted"); searchBill(); });
}
</script>

</body>
</html>
