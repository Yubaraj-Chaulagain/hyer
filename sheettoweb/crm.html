<!DOCTYPE html>
<html>
<head>
<title>Finance System</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</head>
<body class="p-3">

<h4>Member Finance System</h4>

<div id="login">
<input id="u" class="form-control mb-2" placeholder="Username">
<input id="p" type="password" class="form-control mb-2" placeholder="Password">
<button class="btn btn-primary" onclick="login()">Login</button>
</div>
<!-- MEMBER MODAL -->
<div class="modal fade" id="memberModal">
  <div class="modal-dialog modal-xl">
    <div class="modal-content">

      <div class="modal-header">
        <h5 id="memberModalTitle">Add Member</h5>
        <button class="btn-close" data-bs-dismiss="modal"></button>
      </div>

      <div class="modal-body row g-2">
        <input id="mMemberID" class="form-control col-6" placeholder="Member ID">
        <input id="mName" class="form-control col-6" placeholder="Name">
        <input id="mAddress" class="form-control col-6" placeholder="Address">
        <input id="mFather" class="form-control col-6" placeholder="Father Name">
        <input id="mGrand" class="form-control col-6" placeholder="Grand Father Name">
        <input id="mSpouse" class="form-control col-6" placeholder="Spouse/Wife Name">
        <input id="mPhone" class="form-control col-6" placeholder="Phone">
        <input id="mEmail" class="form-control col-6" placeholder="Email">
        <input id="mIDPhoto" class="form-control col-6" placeholder="Identy PhotoURL">
        <input id="mPhoto" class="form-control col-6" placeholder="Member PhotoURL">
        <input id="mStatus" class="form-control col-6" placeholder="Status">
        <input id="mOTP" class="form-control col-6" placeholder="OTP">
        <input id="mDate" type="date" class="form-control col-6">
      </div>

      <div class="modal-footer">
        <button class="btn btn-success" onclick="saveMember()">Save</button>
        <button class="btn btn-danger" onclick="deleteMember()">Delete</button>
      </div>

    </div>
  </div>
</div>

<script>
const memberModal = new bootstrap.Modal(document.getElementById("memberModal"));
let editMode = false;
let currentRole = "admin"; // change based on login

// ===== OPEN ADD =====
function openAdd(){
  if(currentRole === "member") return alert("Members cannot add!");
  editMode = false;
  memberModalTitle.innerText = "Add Member";
  document.querySelectorAll("#memberModal input").forEach(i=>i.value="");
  mMemberID.readOnly = false;
  memberModal.show();
}

// ===== OPEN EDIT =====
function openEditMember(m){
  if(currentRole === "member") return alert("Members cannot edit!");
  editMode = true;
  memberModalTitle.innerText = "Edit Member";
  mMemberID.value = m.MemberID;
  mMemberID.readOnly = true;

  mName.value = m.Name;
  mAddress.value = m.Address;
  mFather.value = m["Father Name"];
  mGrand.value = m["Grand Father Name"];
  mSpouse.value = m["spouse/wife Name"];
  mPhone.value = m.Phone;
  mEmail.value = m.Email;
  mIDPhoto.value = m["Identy PhotoURL"];
  mPhoto.value = m["Member PhotoURL"];
  mStatus.value = m.Status;
  mOTP.value = m.OTP;
  mDate.value = m.EntryDate;

  memberModal.show();
}

// ===== SAVE =====
function saveMember(){
  const payload = {
    action: editMode ? "updateMember" : "addMember",
    "MemberID": mMemberID.value,
    "Name": mName.value,
    "Address": mAddress.value,
    "Father Name": mFather.value,
    "Grand Father Name": mGrand.value,
    "spouse/wife Name": mSpouse.value,
    "Phone": mPhone.value,
    "Email": mEmail.value,
    "Identy PhotoURL": mIDPhoto.value,
    "Member PhotoURL": mPhoto.value,
    "Status": mStatus.value,
    "OTP": mOTP.value,
    "EntryDate": mDate.value
  };

  fetch(API,{
    method:"POST",
    body: JSON.stringify(payload)
  }).then(r=>r.json()).then(res=>{
    if(res.status){
      memberModal.hide();
      load("getMembers");
    } else alert("Error saving member");
  });
}

// ===== DELETE =====
function deleteMember(){
  if(!editMode) return alert("Select member first!");
  if(currentRole === "member") return alert("Members cannot delete!");
  if(!confirm("Delete this member?")) return;

  fetch(API,{
    method:"POST",
    body: JSON.stringify({ action:"deleteMember", "MemberID": mMemberID.value })
  }).then(r=>r.json()).then(res=>{
    if(res.status){
      memberModal.hide();
      load("getMembers");
    } else alert("Error deleting member");
  });
}

// ===== DRAW TABLE =====
function drawMembers(data){
  if(!data.length){tbl.innerHTML="No members";return;}
  let h = "<tr>";
  Object.keys(data[0]).forEach(k=>h+=`<th>${k}</th>`);
  h+="<th>Action</th></tr>";

  data.forEach(r=>{
    h+="<tr>";
    Object.values(r).forEach(v=>h+=`<td>${v}</td>`);
    h+=`<td>
      ${currentRole !== "member"? `<button class="btn btn-sm btn-warning" onclick='openEditMember(${JSON.stringify(r)})'>Edit</button>` : ""}
    </td></tr>`;
  });

  tbl.innerHTML = h;
}
</script>



<div id="app" style="display:none;">
<ul class="nav nav-tabs mb-3">
<li class="nav-item"><a class="nav-link active" onclick="load('getMembers')">Members</a></li>
<li class="nav-item admin"><a class="nav-link" onclick="load('getUsers')">Users</a></li>
<li class="nav-item"><a class="nav-link" onclick="load('getItems')">Items</a></li>
<li class="nav-item"><a class="nav-link" onclick="load('getTransactions')">Transactions</a></li>
<li class="nav-item"><a class="nav-link" onclick="load('dailyReport')">Daily</a></li>
<li class="nav-item"><a class="nav-link" onclick="load('monthlyReport')">Monthly</a></li>
</ul>

<button class="btn btn-success mb-2" onclick="openAdd()">+ Add</button>
<table class="table table-bordered table-sm" id="tbl"></table>
</div>

<script>
const API="https://script.google.com/macros/s/AKfycbyEohqm783728Y4Pws74ocBqiVVx6N7RPd6eDF8gm5M7Ewdtakpq1iipTPWRaXndqIX7A/exec";
let role="";

function login(){
 fetch(API,{method:"POST",body:JSON.stringify({action:"login",username:u.value,password:p.value})})
 .then(r=>r.json()).then(d=>{
  if(!d.status) return alert("Invalid");
  role=d.role;
  document.getElementById("login").style.display="none";
  document.getElementById("app").style.display="block";
  if(role!=="admin") document.querySelectorAll(".admin").forEach(x=>x.remove());
  load("getMembers");
 });
}

function load(a){
 fetch(API,{method:"POST",body:JSON.stringify({action:a})})
 .then(r=>r.json()).then(draw);
}

function draw(d){
  if(!d.length){tbl.innerHTML="No data";return;}

  let h="<tr>";
  Object.keys(d[0]).forEach(k=>h+=`<th>${k}</th>`);
  h+="<th>Action</th></tr>";

  d.forEach(r=>{
    h+="<tr>";
    Object.values(r).forEach(v=>h+=`<td>${v}</td>`);
    h+=`<td>
      <button class="btn btn-sm btn-warning"
        onclick='openEditMember(${JSON.stringify(r)})'>Edit</button>
    </td></tr>`;
  });

  tbl.innerHTML=h;
}


// ===== INVOICE PRINT =====
function printInvoice(txn){
 let w=window.open("");
 w.document.write(`<h3>Invoice</h3><pre>${JSON.stringify(txn,null,2)}</pre>`);
 w.print();
}
</script>


</body>
</html>
