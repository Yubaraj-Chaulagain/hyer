<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>ERP System</title>

<meta name="viewport" content="width=device-width, initial-scale=1">

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://cdn.datatables.net/1.13.6/css/dataTables.bootstrap5.min.css" rel="stylesheet">

<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
</head>

<body class="p-3 bg-light">

<div class="container">

<h4>Add Member</h4>
<input id="name" class="form-control mb-2" placeholder="Name">
<input id="phone" class="form-control mb-2" placeholder="Phone">
<input id="email" class="form-control mb-2" placeholder="Email">
<button class="btn btn-primary w-100" onclick="addMember()">Add</button>

<hr>

<h4>Members List</h4>
<table id="table" class="table table-bordered"></table>

</div>

<script>
const WEBAPP = "PASTE_WEBAPP_URL_HERE";

/* ===== ADD ===== */
function addMember(){
 fetch(WEBAPP,{
  method:"POST",
  body:JSON.stringify({
    action:"add",
    name:name.value,
    phone:phone.value,
    email:email.value
  })
 })
 .then(r=>r.json())
 .then(d=>{
  alert(d.msg);
  loadData();
 });
}

/* ===== LOAD ===== */
function loadData(){
 fetch(WEBAPP,{
  method:"POST",
  body:JSON.stringify({ action:"list" })
 })
 .then(r=>r.json())
 .then(d=>{
  $("#table").DataTable({
    destroy:true,
    data:d.data.slice(1),
    columns:[
      {title:"ID"},
      {title:"Name"},
      {title:"Phone"},
      {title:"Email"},
      {title:"Status"},
      {
        title:"Action",
        render:(d,t,row)=>`
          <button class="btn btn-sm btn-warning"
            onclick='editRow(${JSON.stringify(row)})'>Edit</button>
          <button class="btn btn-sm btn-danger"
            onclick="deleteRow(${row[0]})">Delete</button>
        `
      }
    ]
  });
 });
}

/* ===== EDIT ===== */
function editRow(row){
 const n = prompt("Name", row[1]);
 const p = prompt("Phone", row[2]);
 const e = prompt("Email", row[3]);
 const s = prompt("Status", row[4]);

 fetch(WEBAPP,{
  method:"POST",
  body:JSON.stringify({
    action:"update",
    id:row[0],
    name:n, phone:p, email:e, status:s
  })
 })
 .then(r=>r.json())
 .then(d=>{
  alert(d.msg);
  loadData();
 });
}

/* ===== DELETE ===== */
function deleteRow(id){
 if(!confirm("Are you sure?")) return;

 fetch(WEBAPP,{
  method:"POST",
  body:JSON.stringify({
    action:"delete",
    id:id
  })
 })
 .then(r=>r.json())
 .then(d=>{
  alert(d.msg);
  loadData();
 });
}

loadData();
</script>

</body>
</html>

script>
function doPost(e) {
  try {
    const data = JSON.parse(e.postData.contents);
    const ss = SpreadsheetApp.openById("1NHnSorejydpwzoelmPPD42zctZ1n7HsfsIZ7EUrIFZg");
    const sh = ss.getSheetByName("Members");
    const rows = sh.getDataRange().getValues();

    /* ===== ADD MEMBER ===== */
    if (data.action === "add") {
      const id = rows.length;
      sh.appendRow([
        id,
        data.name,
        data.phone,
        data.email,
        "ACTIVE"
      ]);

      GmailApp.sendEmail(
        data.email,
        "Registration Successful",
        "Hello " + data.name + ",\nYour profile has been created successfully."
      );

      return output({ status: true, msg: "Member added & email sent" });
    }

    /* ===== LIST ===== */
    if (data.action === "list") {
      return output({ data: rows });
    }

    /* ===== UPDATE ===== */
    if (data.action === "update") {
      for (let i = 1; i < rows.length; i++) {
        if (rows[i][0] == data.id) {
          sh.getRange(i + 1, 2, 1, 4).setValues([[
            data.name,
            data.phone,
            data.email,
            data.status
          ]]);

          GmailApp.sendEmail(
            data.email,
            "Profile Updated",
            "Your profile has been updated."
          );

          return output({ status: true, msg: "Updated & email sent" });
        }
      }
    }

    /* ===== DELETE ===== */
    if (data.action === "delete") {
      for (let i = 1; i < rows.length; i++) {
        if (rows[i][0] == data.id) {
          const email = rows[i][3];
          sh.deleteRow(i + 1);

          GmailApp.sendEmail(
            email,
            "Profile Deleted",
            "Your profile has been removed from system."
          );

          return output({ status: true, msg: "Deleted & email sent" });
        }
      }
    }

    return output({ status: false, msg: "Invalid action" });

  } catch (err) {
    return output({ status: false, msg: err.toString() });
  }
}

function output(obj) {
  return ContentService.createTextOutput(
    JSON.stringify(obj)
  ).setMimeType(ContentService.MimeType.JSON);
}
