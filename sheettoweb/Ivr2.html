<!DOCTYPE html>
<html>
<head>
<title>Member Finance System</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<style>td a{text-decoration:none;}</style>
</head>
<body class="p-3">

<div id="loginDiv">
<h4>Login</h4>
<input id="username" class="form-control mb-2" placeholder="Username">
<input id="password" type="password" class="form-control mb-2" placeholder="Password">
<button class="btn btn-primary" onclick="login()">Login</button>
</div>

<div id="mainDiv" style="display:none;">
<h4>Member & Finance System</h4>
<ul class="nav nav-tabs mb-3">
<li class="nav-item"><a class="nav-link active" onclick="tab('members')">Members</a></li>
<li class="nav-item"><a class="nav-link" onclick="tab('users')">Users</a></li>
<li class="nav-item"><a class="nav-link" onclick="tab('items')">Items</a></li>
<li class="nav-item"><a class="nav-link" onclick="tab('transactions')">Transactions</a></li>
<li class="nav-item"><a class="nav-link" onclick="tab('balance')">Balance</a></li>
<li class="nav-item"><a class="nav-link" onclick="tab('loans')">Loans</a></li>
</ul>

<input id="searchBox" class="form-control mb-2" placeholder="Search..." onkeyup="searchTable()">
<div id="content"></div>
</div>

<script>
const API="https://script.google.com/macros/s/AKfycbwsNtNSTcsMBvvXp4WwMa0FgTocC5JDRMutA-uLqrvKhd8TFbLnsCnUquFPSJwJDQyx1g/exec";
let role="",memberID="",currentData=[],currentAction="";

function login(){
 fetch(API,{method:"POST",body:JSON.stringify({
  action:"login",username:username.value,password:password.value
 })}).then(r=>r.json()).then(d=>{
   if(d.status){role=d.role; memberID=d.MemberID; loginDiv.style.display="none"; mainDiv.style.display="block"; tab('members');}
   else alert(d.message);
 });
}

function tab(t){
 currentAction=t;
 let actMap={
   members:"getMembers", users:"getUsers", items:"getItems",
   transactions:"getTransactions", balance:"getBalance", loans:"getLoans"
 };
 fetch(API,{method:"POST",body:JSON.stringify({action:actMap[t]})})
 .then(r=>r.json()).then(d=>{
   currentData=d;
   drawTable(d);
 });
}

function drawTable(data){
 if(!data.length){content.innerHTML="No data";return;}
 let h="<table class='table table-bordered table-sm'><tr>";
 Object.keys(data[0]).forEach(k=>h+="<th>"+k+"</th>");
 if(currentAction!=="balance") h+="<th>Action</th>";
 h+="</tr>";
 data.forEach(r=>{
   h+="<tr>";
   Object.values(r).forEach(v=>h+="<td>"+v+"</td>");
   if(currentAction!=="balance"){
     h+="<td>";
     h+=`<button class='btn btn-sm btn-warning' onclick='editRow(${JSON.stringify(r)})'>Edit</button> `;
     h+=`<button class='btn btn-sm btn-danger' onclick='deleteRow("${JSON.stringify(r)}")'>Del</button>`;
     h+="</td>";
   }
   h+="</tr>";
 });
 h+="</table>";
 content.innerHTML=h;
}

function searchTable(){
 let v=searchBox.value.toLowerCase();
 drawTable(currentData.filter(r=>JSON.stringify(r).toLowerCase().includes(v)));
}

function editRow(r){
 let keys=Object.keys(r),payload={action:"update"+capitalize(currentAction.slice(0,-1))};
 keys.forEach(k=>payload[k]=prompt(k,r[k]));
 fetch(API,{method:"POST",body:JSON.stringify(payload)}).then(r=>r.json()).then(()=>tab(currentAction));
}

function deleteRow(r){
 let obj=JSON.parse(r);
 if(!confirm("Delete?")) return;
 fetch(API,{method:"POST",body:JSON.stringify({action:"delete"+capitalize(currentAction.slice(0,-1)),...obj})})
 .then(r=>r.json()).then(()=>tab(currentAction));
}

function capitalize(s){return s.charAt(0).toUpperCase()+s.slice(1);}
</script>
</body>
</html>
