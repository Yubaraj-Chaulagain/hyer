<!DOCTYPE html>
<html>
<head>
  <title>ERP Dashboard</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body{font-family:Arial;background:#f5f5f5}
    .card{display:inline-block;width:200px;padding:15px;background:#fff;margin:10px;border-radius:8px}
    .hidden{display:none}
    input,select{padding:6px;width:200px}
    button{padding:6px 10px}
  </style>
</head>

<body>

<h2>Login</h2>
<div id="loginBox">
  <input id="username" placeholder="Username"><br>
  <input id="password" type="password" placeholder="Password"><br>
  <button onclick="login()">Login</button>
</div>

<div id="dashboard" class="hidden">

  <h2>Dashboard</h2>

  <div class="card">Members<br><b id="mcount">0</b></div>
  <div class="card">Items<br><b id="icount">0</b></div>
  <div class="card">Loans<br><b id="lcount">0</b></div>

  <canvas id="chart" width="400"></canvas>

  <h3>Add Member</h3>
  <input id="mname" placeholder="Name">
  <input id="mphone" placeholder="Phone">
  <button onclick="addMember()">Add</button>

</div>
<h3>Members List</h3>
<table border="1" id="mtable"></table>

<script>
function loadMembers(){
 fetch(WEBAPP+"?action=list",{
  method:"POST",
  body:JSON.stringify({sheet:"Members"})
 }).then(r=>r.json()).then(d=>{
  localStorage.setItem("members",JSON.stringify(d.data));
  drawTable(d.data);
 }).catch(()=>{
  drawTable(JSON.parse(localStorage.getItem("members")));
 });
}

function drawTable(data){
 let html="<tr>";
 data[0].forEach(h=>html+="<th>"+h+"</th>");
 html+="<th>Action</th></tr>";

 for(let i=1;i<data.length;i++){
  html+="<tr>";
  data[i].forEach(v=>html+=`<td contenteditable>${v}</td>`);
  html+=`<td>
   <button onclick="updateRow(${i+1},this)">üíæ</button>
   <button onclick="delRow(${i+1})">‚ùå</button>
  </td></tr>`;
 }
 mtable.innerHTML=html;
}

function updateRow(r,btn){
 let row=[...btn.parentNode.parentNode.querySelectorAll("td")]
   .slice(0,-1).map(td=>td.innerText);
 fetch(WEBAPP+"?action=update",{
  method:"POST",
  body:JSON.stringify({sheet:"Members",row:r,values:row})
 }).then(()=>alert("Updated"));
}

function delRow(r){
 fetch(WEBAPP+"?action=delete",{
  method:"POST",
  body:JSON.stringify({sheet:"Members",row:r})
 }).then(()=>loadMembers());
}
</script>
<script src="https://cdn.jsdelivr.net/npm/qrcodejs/qrcode.min.js"></script>

<div id="qr"></div>

<script>
function makeQR(id){
 document.getElementById("qr").innerHTML="";
 new QRCode(qr,{
  text:id,
  width:120,
  height:120
 });
}
</script>
<h3>New Loan</h3>
<input id="lamount" placeholder="Amount">
<input id="lrate" placeholder="Rate">
<input id="lperiod" placeholder="Months">
<button onclick="addLoan()">Create Loan</button>

<script>
function addLoan(){
 fetch(WEBAPP,{
  method:"POST",
  body:JSON.stringify({
   action:"addLoan",
   amount:lamount.value,
   rate:lrate.value,
   period:lperiod.value,
   member:"MEM001",
   start:new Date()
  })
 }).then(r=>r.json()).then(d=>{
  alert("EMI: "+d.emi);
 });
}
</script>
<button onclick="window.print()">üñ® Print Report</button>

<style>
@media print{
 body{background:#fff}
 button{display:none}
}
</style>


<script>
const WEBAPP = "https://script.google.com/macros/s/AKfycbwuW28oVGLCjVRzqlKg6nNzJMn06K5dpchAt0ubbHtgB4LbchEbfTZzHuQ8iCsZKtvc/exec";

/* ---------- LOGIN ---------- */
function login(){
 fetch(WEBAPP+"?action=login",{
   method:"POST",
   body:JSON.stringify({
     username:username.value,
     password:password.value
   })
 }).then(r=>r.json()).then(d=>{
   if(d.status){
     loginBox.classList.add("hidden");
     dashboard.classList.remove("hidden");
     loadDashboard();
   } else alert("Login Failed");
 });
}

/* ---------- DASHBOARD ---------- */
function loadDashboard(){
 loadCount("Members","mcount");
 loadCount("Items","icount");
 loadCount("Loan","lcount");

 new Chart(chart,{
   type:"bar",
   data:{
     labels:["Members","Items","Loans"],
     datasets:[{
       data:[mcount.innerText,icount.innerText,lcount.innerText]
     }]
   }
 });
}

function loadCount(sheet,id){
 fetch(WEBAPP,{
  method:"POST",
  body:JSON.stringify({sheet:sheet}),
  headers:{"Content-Type":"application/json"},
 }).then(r=>r.json()).then(d=>{
   document.getElementById(id).innerText=d.data.length-1;
 });
}

/* ---------- ADD MEMBER ---------- */
function addMember(){
 fetch(WEBAPP+"?action=add",{
   method:"POST",
   body:JSON.stringify({
     sheet:"Members",
     values:[
       Date.now(),
       mname.value,
       "",
       "",
       "",
       "",
       "",
       "",
       "",
       "",
       mphone.value,
       "",
       new Date(),
       0,0,"ACTIVE",0,"ACTIVE"
     ]
   })
 }).then(r=>r.json()).then(d=>{
   alert("Member Added");
   loadDashboard();
 });
}
</script>
</body>
</html>
